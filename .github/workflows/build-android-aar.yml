name: Build tun2socks AAR for Android

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

env:
  ANDROID_NDK_VERSION: r26d
  GO_VERSION: '1.22.5'
  TUN2SOCKS_VERSION: v1.1.5
  QTLS_VERSION: v0.24.0
  TARGET_ARCHS: "arm64-v8a armeabi-v7a x86_64"

jobs:
  build-tun2socks-aar:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        cache: 'gradle'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        sdk-tools-version: '9477386_latest'

    - name: Accept Android SDK licenses
      run: |
        yes | sdkmanager --licenses >/dev/null
        sdkmanager "platforms;android-34"
        sdkmanager "platforms;android-33"
        sdkmanager "platforms;android-30"
        sdkmanager "build-tools;34.0.0"
        sdkmanager "build-tools;33.0.2"
        sdkmanager "build-tools;30.0.3"

    - name: Install Android NDK ${{ env.ANDROID_NDK_VERSION }}
      run: |
        sdkmanager "ndk;${{ env.ANDROID_NDK_VERSION }}" --sdk_root=${ANDROID_HOME}
        echo "ANDROID_NDK_ROOT=${ANDROID_HOME}/ndk/${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_ENV
        echo "${ANDROID_HOME}/ndk/${{ env.ANDROID_NDK_VERSION }}/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

    - name: Setup Go ${{ env.GO_VERSION }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Install Rust (for potential dependencies)
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Create Gradle wrapper
      run: |
        gradle wrapper --gradle-version 8.7

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          .gradle
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Disable QUIC and set build flags
      run: |
        echo "export CGO_ENABLED=1" >> $GITHUB_ENV
        echo "export CGO_CFLAGS=-O3 -DNDEBUG -fPIC" >> $GITHUB_ENV
        echo "export CGO_LDFLAGS=-O3 -DNDEBUG -Wl,--no-undefined -Wl,--gc-sections" >> $GITHUB_ENV
        echo "export GOFLAGS=-buildmode=pie -ldflags=-s -w -extldflags=-static" >> $GITHUB_ENV
        echo "export GO111MODULE=on" >> $GITHUB_ENV
        echo "export GODEBUG=netdns=go" >> $GITHUB_ENV
        echo "export CGO_LDFLAGS_ALLOW=-Wl,--" >> $GITHUB_ENV
        echo "export NO_QUIC=1" >> $GITHUB_ENV
        echo "export DISABLE_QUIC=1" >> $GITHUB_ENV
        echo "export GOROOT_BOOTSTRAP=$(go env GOROOT)" >> $GITHUB_ENV

    - name: Clone tun2socks (maintained fork)
      run: |
        git clone --depth 1 --recursive --shallow-submodules \
          https://github.com/xjasonlyu/tun2socks.git \
          tun2socks
        cd tun2socks
        git checkout v${{ env.TUN2SOCKS_VERSION }}
        git submodule update --init --recursive
        cd ..

    - name: Create Android project structure
      run: |
        mkdir -p tun2socks-aar/app/src/main/{java, JNI, res/values, cpp}
        mkdir -p tun2socks-aar/app/src/main/assets
        mkdir -p tun2socks-aar/app/build/generated
        
        # AndroidManifest.xml
        cat > tun2socks-aar/app/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.tun2socks.wrapper">
            
            <uses-permission android:name="android.permission.INTERNET" />
            <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
            
            <application android:allowBackup="true">
            </application>
        </manifest>
        EOF

        # Minimal strings.xml
        cat > tun2socks-aar/app/src/main/res/values/strings.xml << 'EOF'
        <resources>
            <string name="app_name">tun2socks-wrapper</string>
        </resources>
        EOF

    - name: Create JNI wrapper headers
      run: |
        cat > tun2socks-aar/app/src/main/cpp/tun2socks_wrapper.h << 'EOF'
        #ifndef TUN2SOCKS_WRAPPER_H
        #define TUN2SOCKS_WRAPPER_H
        
        #include <jni.h>
        #include <sys/types.h>
        
        #ifdef __cplusplus
        extern "C" {
        #endif
        
        JNIEXPORT jboolean JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_initTun2socks(
            JNIEnv *env, jobject thiz, jint fd, jstring ip, jint port);
            
        JNIEXPORT void JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_startTun2socks(
            JNIEnv *env, jobject thiz);
            
        JNIEXPORT void JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_stopTun2socks(
            JNIEnv *env, jobject thiz);
            
        #ifdef __cplusplus
        }
        #endif
        
        #endif
        EOF

    - name: Copy tun2socks source with patches
      run: |
        cp -r tun2socks/* tun2socks-aar/app/src/main/cpp/tun2socks/
        
        # Patch tun2socks for Android compatibility
        sed -i 's/#define _GNU_SOURCE//g' tun2socks-aar/app/src/main/cpp/tun2socks/*.go
        sed -i 's/CGOPKGS.*/CGOPKGS:=android\/net\/ipv4 android\/net\/ipv6/' \
          tun2socks-aar/app/src/main/cpp/tun2socks/Makefile

    - name: Create CMakeLists.txt for Android
      run: |
        cat > tun2socks-aar/app/src/main/cpp/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.22.1)
        
        project("tun2socks")
        
        set(CMAKE_CXX_STANDARD 17)
        set(CMAKE_CXX_STANDARD_REQUIRED ON)
        set(CMAKE_POSITION_INDEPENDENT_CODE ON)
        
        set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -O3 -DNDEBUG -fPIC -fvisibility=hidden")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -DNDEBUG -fPIC -fvisibility=hidden")
        set(CMAKE_SHARED_LINKER_FLAGS "${CMAKE_SHARED_LINKER_FLAGS} -Wl,--no-undefined -Wl,--gc-sections -s")
        
        # Disable QUIC explicitly
        add_definitions(-DNO_QUIC=1)
        add_definitions(-DDISABLE_QUIC=1)
        
        add_library(tun2socks SHARED
            tun2socks_wrapper.cpp
            tun2socks/device.go.c
            tun2socks/tun2socks.go.c
        )
        
        set_target_properties(tun2socks PROPERTIES
            OUTPUT_NAME "tun2socks"
            POSITION_INDEPENDENT_CODE ON
        )
        
        target_link_libraries(tun2socks
            log
            android
        )
        EOF

    - name: Create JNI wrapper implementation
      run: |
        cat > tun2socks-aar/app/src/main/cpp/tun2socks_wrapper.cpp << 'EOF'
        #include "tun2socks_wrapper.h"
        #include <android/log.h>
        #include <string>
        
        #define LOG_TAG "Tun2socksWrapper"
        #define LOGI(...) __android_log_print(ANDROID_LOG_INFO, LOG_TAG, __VA_ARGS__)
        
        extern "C" {
            void tun2socks_main(int fd, const char* ip, int port);
            void tun2socks_stop();
        }
        
        JNIEXPORT jboolean JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_initTun2socks(
            JNIEnv *env, jobject thiz, jint fd, jstring ip, jint port) {
            
            const char* ip_str = env->GetStringUTFChars(ip, 0);
            LOGI("Initializing tun2socks fd=%d ip=%s port=%d", fd, ip_str, port);
            
            tun2socks_main(fd, ip_str, port);
            env->ReleaseStringUTFChars(ip, ip_str);
            return JNI_TRUE;
        }
        
        JNIEXPORT void JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_startTun2socks(JNIEnv*, jobject) {
            LOGI("tun2socks started");
        }
        
        JNIEXPORT void JNICALL
        Java_com_tun2socks_wrapper_Tun2socksWrapper_stopTun2socks(JNIEnv*, jobject) {
            LOGI("Stopping tun2socks");
            tun2socks_stop();
        }
        EOF

    - name: Create Java wrapper class
      run: |
        mkdir -p tun2socks-aar/app/src/main/java/com/tun2socks/wrapper
        cat > tun2socks-aar/app/src/main/java/com/tun2socks/wrapper/Tun2socksWrapper.java << 'EOF'
        package com.tun2socks.wrapper;
        
        public class Tun2socksWrapper {
            static {
                System.loadLibrary("tun2socks");
            }
            
            public native boolean initTun2socks(int fd, String ip, int port);
            public native void startTun2socks();
            public native void stopTun2socks();
        }
        EOF

    - name: Create build.gradle files
      run: |
        # Project level build.gradle
        cat > tun2socks-aar/build.gradle << 'EOF'
        allprojects {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        EOF

        # App level build.gradle
        cat > tun2socks-aar/app/build.gradle << 'EOF'
        plugins {
            id 'com.android.library'
        }
        
        android {
            namespace 'com.tun2socks.wrapper'
            compileSdk 34
            
            defaultConfig {
                minSdk 21
                targetSdk 34
                versionCode 1
                versionName "1.0"
                ndk {
                    abiFilters 'arm64-v8a', 'armeabi-v7a', 'x86_64'
                }
            }
            
            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
                debug {
                    debuggable true
                }
            }
            
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_17
                targetCompatibility JavaVersion.VERSION_17
            }
            
            externalNativeBuild {
                cmake {
                    path "src/main/cpp/CMakeLists.txt"
                    version "3.22.1"
                }
            }
            
            packagingOptions {
                pickFirst '**/libc++_shared.so'
                pickFirst '**/libjsc.so'
            }
        }
        
        dependencies {
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        EOF

    - name: Build tun2socks Go components for each ABI
      shell: bash
      run: |
        for ABI in arm64-v8a armeabi-v7a x86_64; do
          echo "Building for $ABI"
          
          case $ABI in
            arm64-v8a)
              GOARCH=arm64 GOARM=7 CC=aarch64-linux-android34-clang CXX=aarch64-linux-android34-clang++ \
              GOOS=android CGO_ENABLED=1 \
              make -C tun2socks-aar/app/src/main/cpp/tun2socks DEVICE=android || true
              ;;
            armeabi-v7a)
              GOARCH=arm GOARM=7 CC=armv7a-linux-androideabi34-clang CXX=armv7a-linux-androideabi34-clang++ \
              GOOS=android CGO_ENABLED=1 \
              make -C tun2socks-aar/app/src/main/cpp/tun2socks DEVICE=android || true
              ;;
            x86_64)
              GOARCH=amd64 CC=x86_64-linux-android34-clang CXX=x86_64-linux-android34-clang++ \
              GOOS=android CGO_ENABLED=1 \
              make -C tun2socks-aar/app/src/main/cpp/tun2socks DEVICE=android || true
              ;;
          esac
        done

    - name: Build AAR for all architectures
      run: |
        cd tun2socks-aar
        ./gradlew clean assembleRelease --stacktrace --info
        
        # Verify AAR created
        ls -la app/build/outputs/aar/
        find . -name "*.aar" -exec ls -la {} \;

    - name: Verify AAR contents
      run: |
        cd tun2socks-aar
        unzip -l app/build/outputs/aar/app-release.aar
        echo "AAR size: $(du -h app/build/outputs/aar/*.aar | tail -1)"

    - name: Create release artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-v${{ env.TUN2SOCKS_VERSION }}
        path: |
          tun2socks-aar/app/build/outputs/aar/*.aar
          tun2socks-aar/app/build/outputs/aar/*.arr
        retention-days: 30

    - name: Generate build report
      if: always()
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "- NDK: ${{ env.ANDROID_NDK_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Go: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- tun2socks: ${{ env.TUN2SOCKS_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- QUIC: Disabled via env vars" >> $GITHUB_STEP_SUMMARY
        echo "- Artifacts: [Download here](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

    - name: Cleanup
      if: always()
      run: |
        rm -rf tun2socks* || true
        docker system prune -f || true
