name: Build Minimal tun2socks AAR for Xray-core

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  NDK_VERSION: '25.2.9519653'
  ANDROID_API: 21

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Android NDK
      uses: android-actions/setup-android@v3
      with:
        ndk-version: ${{ env.NDK_VERSION }}
    
    - name: Build Minimal tun2socks
      run: |
        # Clone BadVPN (minimal tun2socks)
        git clone https://github.com/ambrop72/badvpn.git --depth=1
        cd badvpn
        
        # Minimal build - ONLY what's needed for Xray-core
        mkdir -p build-minimal
        cd build-minimal
        
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake \
          -DANDROID_ABI=arm64-v8a \
          -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
          -DANDROID_STL=c++_static \
          -DCMAKE_BUILD_TYPE=MinSizeRel \
          -DBUILD_TUN2SOCKS=ON \
          -DBUILD_NOTHING_BY_DEFAULT=ON \
          -DENABLE_SOCKS=ON \
          -DENABLE_UDP=ON \
          -DENABLE_TCP=ON \
          -DENABLE_SSL=OFF \
          -DENABLE_HTTP=OFF \
          -DENABLE_SERVER=OFF \
          -DENABLE_LZO=OFF \
          -DENABLE_DEBUG=OFF \
          -DCMAKE_C_FLAGS="-Os -fPIC -ffunction-sections -fdata-sections" \
          -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections"
        
        make tun2socks -j$(nproc)
        
        # Strip binary for minimal size
        $ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip \
          tun2socks/tun2socks
        
        echo "Size of tun2socks binary:"
        ls -lh tun2socks/tun2socks
    
    - name: Create Minimal AAR
      run: |
        # Create project structure
        mkdir -p Tun2SocksMinimal
        cd Tun2SocksMinimal
        
        # Minimal build.gradle
        cat > build.gradle << 'EOF'
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.2'
            }
        }
        
        allprojects {
            repositories {
                google()
                mavenCentral()
            }
        }
        
        task clean(type: Delete) {
            delete rootProject.buildDir
        }
        EOF
        
        # Minimal settings.gradle
        echo 'include ":tun2socks"' > settings.gradle
        
        # Create library module
        mkdir -p tun2socks/src/main/java/com/tun2socks/minimal
        mkdir -p tun2socks/src/main/jniLibs/arm64-v8a
        
        # Copy binary
        cp ../badvpn/build-minimal/tun2socks/tun2socks \
           tun2socks/src/main/jniLibs/arm64-v8a/libtun2socks.so
        
        # Create AndroidManifest.xml
        cat > tun2socks/src/main/AndroidManifest.xml << 'EOF'
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android"
            package="com.tun2socks.minimal">
        </manifest>
        EOF
        
        # Create minimal Java wrapper for Xray-core
        cat > tun2socks/src/main/java/com/tun2socks/minimal/XrayTun2Socks.java << 'EOF'
        package com.tun2socks.minimal;
        
        import android.system.Os;
        import android.system.OsConstants;
        import java.io.FileDescriptor;
        import java.io.IOException;
        
        public class XrayTun2Socks {
            static {
                System.loadLibrary("tun2socks");
            }
            
            // Minimal native interface for Xray-core
            private native int startTun2SocksForXray(
                int tunFd,
                String socks5Address,    // Xray-core SOCKS5 inbound
                String socks5Port,
                String dnsServers,       // Optional DNS
                String logLevel
            );
            
            private native void stopTun2Socks();
            private native boolean isRunning();
            
            private Thread tunThread;
            private volatile boolean running = false;
            
            public static class Config {
                public FileDescriptor tunFd;
                public String socks5Host = "127.0.0.1";
                public int socks5Port = 10808;  // Xray-core default SOCKS5 port
                public String dns = "8.8.8.8,8.8.4.4";
                public boolean enableUDP = true;
                public String logLevel = "info";
                public int mtu = 1500;
            }
            
            public void start(final Config config) throws IOException {
                if (running) {
                    stop();
                }
                
                final int fd = config.tunFd.getInt$();
                
                tunThread = new Thread(() -> {
                    running = true;
                    
                    // Build command line arguments for minimal tun2socks
                    String socksAddr = config.socks5Host + ":" + config.socks5Port;
                    
                    int result = startTun2SocksForXray(
                        fd,
                        config.socks5Host,
                        String.valueOf(config.socks5Port),
                        config.dns,
                        config.logLevel
                    );
                    
                    running = false;
                    
                    if (result != 0) {
                        // Log error
                    }
                });
                
                tunThread.start();
            }
            
            public void stop() {
                if (tunThread != null) {
                    stopTun2Socks();
                    tunThread.interrupt();
                    try {
                        tunThread.join(1000);
                    } catch (InterruptedException e) {
                        Thread.currentThread().interrupt();
                    }
                    tunThread = null;
                }
                running = false;
            }
            
            public boolean isRunning() {
                return running;
            }
        }
        EOF
        
        # Create minimal build.gradle for library
        cat > tun2socks/build.gradle << 'EOF'
        plugins {
            id 'com.android.library'
        }
        
        android {
            namespace 'com.tun2socks.minimal'
            compileSdk 34
            
            defaultConfig {
                minSdk 21
                targetSdk 34
                versionCode 1
                versionName "1.0"
                
                ndk {
                    abiFilters 'arm64-v8a'
                }
            }
            
            buildTypes {
                release {
                    minifyEnabled false
                }
            }
            
            sourceSets {
                main {
                    jniLibs.srcDirs = ['src/main/jniLibs']
                }
            }
        }
        EOF
    
    - name: Build AAR
      run: |
        cd Tun2SocksMinimal
        
        # Create gradle wrapper if needed
        if [ ! -f "gradlew" ]; then
            gradle wrapper --gradle-version=8.4
        fi
        
        ./gradlew :tun2socks:assembleRelease
        
        echo "Built AAR location:"
        find . -name "*.aar" -type f
    
    - name: Create JNI Interface
      run: |
        cd Tun2SocksMinimal
        
        # Create minimal JNI C wrapper
        mkdir -p tun2socks/src/main/cpp
        
        cat > tun2socks/src/main/cpp/tun2socks_wrapper.c << 'EOF'
        #include <jni.h>
        #include <stdlib.h>
        #include <string.h>
        
        // Forward declaration of tun2socks main function
        extern int tun2socks_main(int argc, char *argv[]);
        
        JNIEXPORT jint JNICALL
        Java_com_tun2socks_minimal_XrayTun2Socks_startTun2SocksForXray(
            JNIEnv *env,
            jobject thiz,
            jint tun_fd,
            jstring socks5_host,
            jstring socks5_port,
            jstring dns_servers,
            jstring log_level
        ) {
            const char *socks_host = (*env)->GetStringUTFChars(env, socks5_host, 0);
            const char *socks_port = (*env)->GetStringUTFChars(env, socks5_port, 0);
            const char *dns = (*env)->GetStringUTFChars(env, dns_servers, 0);
            
            // Build minimal command line for Xray-core forwarding
            char *argv[] = {
                "tun2socks",
                "--tundev", "tun",  // Will use tun_fd
                "--netif-ipaddr", "10.0.0.2",
                "--netif-netmask", "255.255.255.0",
                "--socks-server-addr", NULL,  // Will be set below
                "--socks5-username", "",      // Empty for Xray
                "--socks5-password", "",      // Empty for Xray
                "--udpgw-remote-server-addr", "127.0.0.1:7300",
                NULL
            };
            
            // Create socks5 address string
            char socks_addr[256];
            snprintf(socks_addr, sizeof(socks_addr), "%s:%s", socks_host, socks_port);
            argv[6] = socks_addr;
            
            // Convert tun_fd to dev path
            char tun_dev[32];
            snprintf(tun_dev, sizeof(tun_dev), "tun%d", tun_fd);
            argv[2] = tun_dev;
            
            // Set FD for the tunnel
            char fd_str[16];
            snprintf(fd_str, sizeof(fd_str), "%d", tun_fd);
            
            // Call tun2socks
            int argc = 11;  // Number of arguments
            int result = tun2socks_main(argc, argv);
            
            // Cleanup
            (*env)->ReleaseStringUTFChars(env, socks5_host, socks_host);
            (*env)->ReleaseStringUTFChars(env, socks5_port, socks_port);
            (*env)->ReleaseStringUTFChars(env, dns_servers, dns);
            
            return result;
        }
        
        JNIEXPORT void JNICALL
        Java_com_tun2socks_minimal_XrayTun2Socks_stopTun2Socks(
            JNIEnv *env,
            jobject thiz
        ) {
            // Signal tun2socks to exit
            // In actual implementation, you'd need a way to signal the running process
        }
        
        JNIEXPORT jboolean JNICALL
        Java_com_tun2socks_minimal_XrayTun2Socks_isRunning(
            JNIEnv *env,
            jobject thiz
        ) {
            // Check if tun2socks is running
            return JNI_FALSE;
        }
        EOF
        
        cat > tun2socks/src/main/cpp/CMakeLists.txt << 'EOF'
        cmake_minimum_required(VERSION 3.4.1)
        
        # Include pre-built tun2socks library
        add_library(tun2socks STATIC IMPORTED)
        set_target_properties(tun2socks PROPERTIES IMPORTED_LOCATION
            ${CMAKE_CURRENT_SOURCE_DIR}/../jniLibs/arm64-v8a/libtun2socks.so)
        
        # Create wrapper library
        add_library(tun2socks-wrapper SHARED
            tun2socks_wrapper.c)
        
        target_link_libraries(tun2socks-wrapper
            tun2socks
            log)
        
        target_compile_options(tun2socks-wrapper PRIVATE -O2)
        EOF
    
    - name: Package AAR
      run: |
        cd Tun2SocksMinimal
        
        # Create README
        cat > README.md << 'EOF'
        # Minimal tun2socks for Xray-core
        
        This AAR provides ONLY the tun2socks functionality needed for Xray-core:
        - SOCKS5 client to connect to Xray's SOCKS5 inbound
        - Raw IP packet forwarding from TUN device
        - Basic UDP support
        
        No extra features, minimal dependencies.
        
        Usage:
        ```java
        XrayTun2Socks.Config config = new XrayTun2Socks.Config();
        config.tunFd = vpnInterface.getFileDescriptor();
        config.socks5Host = "127.0.0.1";
        config.socks5Port = 10808;
        
        XrayTun2Socks tun2socks = new XrayTun2Socks();
        tun2socks.start(config);
        ```
        EOF
        
        echo "Minimal tun2socks AAR created"
    
    - name: Upload AAR
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-minimal-aar
        path: |
          Tun2SocksMinimal/tun2socks/build/outputs/aar/*.aar
          Tun2SocksMinimal/README.md
        retention-days: 7
