################################################################################
# WORKFLOW PURPOSE:
# This workflow builds a fully functional AAR file from the LondonX/tun2socks-android
# project, which is a badvpn-based VPN tunnel implementation for Android.
#
# USER REQUEST:
# User wants to build tun2socks-android AAR without forking or manual setup.
# The project has gradle wrapper already, but needs proper environment setup.
#
# SOLUTION:
# This workflow clones the repo, sets up all required tools (JDK, Android SDK/NDK, CMake),
# handles all compatibility issues, and builds the AAR with comprehensive error handling.
#
# OUTPUT:
# - tun2socks-aar: Ready-to-use AAR file with all architectures
# - tun2socks-native-libs: Native SO libraries for manual integration
# - build-info: Build details and troubleshooting information
################################################################################

name: Build Tun2Socks AAR - Production Ready

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      # Critical: Android SDK tools need JDK 17+, but build needs JDK 11
      # We'll install both and switch between them
      GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m"'
      
    steps:
    ############################################################################
    # STEP 1: Clone the tun2socks-android repository
    # This is the source we're building from - no forking needed
    ############################################################################
    - name: ğŸ“¥ Checkout tun2socks-android repository
      uses: actions/checkout@v4
      with:
        repository: LondonX/tun2socks-android
        ref: main
        fetch-depth: 1
      
    - name: ğŸ“‹ Display repository info
      run: |
        echo "==================================="
        echo "Repository cloned successfully"
        echo "==================================="
        pwd
        ls -la
        echo ""
        echo "Gradle wrapper exists:"
        ls -la gradle/wrapper/ || echo "âš ï¸ No wrapper found"
        echo ""
        
    ############################################################################
    # STEP 2: Setup JDK 17 (Required for Android SDK tools)
    # The sdkmanager and Android SDK command-line tools require JDK 17+
    ############################################################################
    - name: â˜• Set up JDK 17 (for Android SDK tools)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: âœ… Verify JDK 17 installation
      run: |
        echo "==================================="
        echo "JDK 17 installed for SDK tools"
        echo "==================================="
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        echo ""
        
    ############################################################################
    # STEP 3: Setup Android SDK with proper license acceptance
    # This must be done with JDK 17 to avoid the exit code 1 error
    ############################################################################
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      continue-on-error: false
      
    - name: âœ… Verify Android SDK installation
      run: |
        echo "==================================="
        echo "Android SDK Setup Complete"
        echo "==================================="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/ || echo "âš ï¸ SDK root not found"
        echo ""
        
    ############################################################################
    # STEP 4: Install Android NDK 21.4.7075529
    # This specific NDK version is compatible with the old CMake version
    # required by this project (CMake 3.10.2)
    ############################################################################
    - name: ğŸ“¦ Install Android NDK 21.4.7075529
      run: |
        echo "==================================="
        echo "Installing Android NDK"
        echo "==================================="
        # Accept all licenses first
        yes | sdkmanager --licenses || true
        
        # Install NDK
        echo "Installing NDK 21.4.7075529..."
        sdkmanager --install "ndk;21.4.7075529" || {
          echo "âŒ Failed to install NDK, trying alternative method..."
          sdkmanager --install "ndk;21.3.6528147" || {
            echo "âŒ Both NDK versions failed, will try to continue..."
            exit 0
          }
        }
        
        echo ""
        echo "NDK installation complete"
        ls -la $ANDROID_SDK_ROOT/ndk/ || echo "âš ï¸ NDK directory not found"
        
    ############################################################################
    # STEP 5: Install CMake 3.10.2
    # CRITICAL: This project requires exactly CMake 3.10.2
    # The error showed it was looking for 3.10.2 but found newer versions
    ############################################################################
    - name: ğŸ”§ Install CMake 3.10.2.4988404
      run: |
        echo "==================================="
        echo "Installing CMake 3.10.2"
        echo "==================================="
        
        # Try to install the exact version
        sdkmanager --install "cmake;3.10.2.4988404" || {
          echo "âš ï¸ Exact CMake version not available, trying alternatives..."
          
          # Try other compatible versions
          sdkmanager --install "cmake;3.18.1" || \
          sdkmanager --install "cmake;3.22.1" || {
            echo "âš ï¸ CMake installation failed, will use system CMake"
            exit 0
          }
        }
        
        echo ""
        echo "CMake installation complete"
        ls -la $ANDROID_SDK_ROOT/cmake/ || echo "âš ï¸ CMake directory not found"
        
    - name: âœ… Verify NDK and CMake installations
      run: |
        echo "==================================="
        echo "Verifying NDK and CMake"
        echo "==================================="
        
        # Find installed NDK versions
        echo "Available NDK versions:"
        ls -la $ANDROID_SDK_ROOT/ndk/ 2>/dev/null || echo "No NDK found"
        
        # Find installed CMake versions
        echo ""
        echo "Available CMake versions:"
        ls -la $ANDROID_SDK_ROOT/cmake/ 2>/dev/null || echo "No CMake found"
        
        # Set NDK path to any available version
        if [ -d "$ANDROID_SDK_ROOT/ndk/21.4.7075529" ]; then
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/21.4.7075529" >> $GITHUB_ENV
          echo "âœ… Using NDK 21.4.7075529"
        elif [ -d "$ANDROID_SDK_ROOT/ndk/21.3.6528147" ]; then
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/21.3.6528147" >> $GITHUB_ENV
          echo "âœ… Using NDK 21.3.6528147"
        else
          NDK_VERSION=$(ls $ANDROID_SDK_ROOT/ndk/ 2>/dev/null | head -1)
          if [ ! -z "$NDK_VERSION" ]; then
            echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/$NDK_VERSION" >> $GITHUB_ENV
            echo "âœ… Using NDK $NDK_VERSION"
          else
            echo "âŒ No NDK found!"
            exit 1
          fi
        fi
        
        # Set CMake path
        if [ -d "$ANDROID_SDK_ROOT/cmake/3.10.2.4988404" ]; then
          echo "CMAKE_DIR=$ANDROID_SDK_ROOT/cmake/3.10.2.4988404" >> $GITHUB_ENV
          echo "âœ… Using CMake 3.10.2.4988404"
        else
          CMAKE_VERSION=$(ls $ANDROID_SDK_ROOT/cmake/ 2>/dev/null | head -1)
          if [ ! -z "$CMAKE_VERSION" ]; then
            echo "CMAKE_DIR=$ANDROID_SDK_ROOT/cmake/$CMAKE_VERSION" >> $GITHUB_ENV
            echo "âœ… Using CMake $CMAKE_VERSION"
          else
            echo "âš ï¸ No CMake found in SDK, will use system CMake"
          fi
        fi
        
    ############################################################################
    # STEP 6: Switch to JDK 11 (Required for building this old project)
    # The project's Gradle configuration expects Java 11
    # Modern Android Gradle Plugin needs 17, but this old project needs 11
    ############################################################################
    - name: â˜• Set up JDK 11 (for building the project)
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
        
    - name: âœ… Verify JDK 11 for build
      run: |
        echo "==================================="
        echo "JDK 11 active for project build"
        echo "==================================="
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        echo ""
        
    ############################################################################
    # STEP 7: Create local.properties file
    # This tells Gradle exactly where to find SDK, NDK, and CMake
    # Prevents Gradle from auto-downloading incompatible versions
    ############################################################################
    - name: ğŸ“ Create local.properties with all paths
      run: |
        echo "==================================="
        echo "Creating local.properties"
        echo "==================================="
        
        cat > local.properties << EOF
# Auto-generated by GitHub Actions
sdk.dir=$ANDROID_SDK_ROOT
ndk.dir=$ANDROID_NDK_HOME
EOF
        
        # Add CMake path if available
        if [ ! -z "$CMAKE_DIR" ]; then
          echo "cmake.dir=$CMAKE_DIR" >> local.properties
        fi
        
        echo ""
        echo "local.properties content:"
        cat local.properties
        echo ""
        
    ############################################################################
    # STEP 8: Configure gradle.properties for optimal build
    # Prevent out-of-memory errors and configure for CI environment
    ############################################################################
    - name: âš™ï¸ Configure gradle.properties
      run: |
        echo "==================================="
        echo "Configuring Gradle properties"
        echo "==================================="
        
        # Backup original if exists
        if [ -f gradle.properties ]; then
          cp gradle.properties gradle.properties.backup
        fi
        
        # Add/update gradle properties
        cat >> gradle.properties << EOF

# CI/CD Optimizations
org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError
org.gradle.parallel=false
org.gradle.daemon=false
org.gradle.configureondemand=false

# Android build optimizations
android.useAndroidX=true
android.enableJetifier=false
android.builder.sdkDownload=false
EOF
        
        echo ""
        echo "gradle.properties updated:"
        cat gradle.properties
        echo ""
        
    ############################################################################
    # STEP 9: Update Gradle wrapper to compatible version
    # The project has wrapper 7.5, we'll ensure it's properly set up
    ############################################################################
    - name: ğŸ”„ Verify and update Gradle wrapper
      run: |
        echo "==================================="
        echo "Setting up Gradle wrapper"
        echo "==================================="
        
        # Make gradlew executable
        chmod +x gradlew
        
        # Show current wrapper version
        echo "Current Gradle wrapper:"
        cat gradle/wrapper/gradle-wrapper.properties | grep distributionUrl || echo "No distribution URL found"
        
        echo ""
        echo "Gradle wrapper is ready"
        
    ############################################################################
    # STEP 10: Clean any previous build artifacts
    # Ensures a fresh build without cached issues
    ############################################################################
    - name: ğŸ§¹ Clean previous build artifacts
      run: |
        echo "==================================="
        echo "Cleaning previous builds"
        echo "==================================="
        
        ./gradlew clean --no-daemon --stacktrace || {
          echo "âš ï¸ Clean failed, but continuing..."
          rm -rf build/
          rm -rf tun2socks/build/
          rm -rf .gradle/
          exit 0
        }
        
        echo "âœ… Clean complete"
        
    ############################################################################
    # STEP 11: Test Gradle configuration
    # Verify that Gradle can read the project before building
    ############################################################################
    - name: ğŸ” Test Gradle configuration
      run: |
        echo "==================================="
        echo "Testing Gradle configuration"
        echo "==================================="
        
        ./gradlew tasks --no-daemon --stacktrace || {
          echo "âŒ Gradle configuration failed!"
          echo ""
          echo "Attempting to diagnose issues..."
          echo ""
          echo "Project structure:"
          find . -name "build.gradle*" -type f
          echo ""
          exit 1
        }
        
        echo "âœ… Gradle configuration successful"
        
    ############################################################################
    # STEP 12: Build the AAR file
    # This is the main build step that compiles native code and packages AAR
    ############################################################################
    - name: ğŸ—ï¸ Build AAR file
      id: build_aar
      run: |
        echo "==================================="
        echo "Building tun2socks AAR"
        echo "==================================="
        
        # Enable debug output if requested
        DEBUG_FLAGS=""
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          DEBUG_FLAGS="--debug"
        fi
        
        # Build with comprehensive logging
        ./gradlew tun2socks:assembleRelease \
          --no-daemon \
          --stacktrace \
          --info \
          $DEBUG_FLAGS || {
          
          echo ""
          echo "âŒ Build failed! Attempting recovery..."
          echo ""
          
          # Try without info logging
          echo "Retry 1: Building without verbose logging..."
          ./gradlew tun2socks:assembleRelease \
            --no-daemon \
            --stacktrace || {
            
            echo ""
            echo "âŒ Retry 1 failed! Trying with refresh dependencies..."
            echo ""
            
            # Try with refresh
            ./gradlew tun2socks:assembleRelease \
              --no-daemon \
              --stacktrace \
              --refresh-dependencies || {
              
              echo ""
              echo "âŒ All build attempts failed!"
              echo ""
              echo "Collecting diagnostic information..."
              echo ""
              echo "Java version:"
              java -version
              echo ""
              echo "Gradle version:"
              ./gradlew --version
              echo ""
              echo "Environment variables:"
              env | grep -E "(JAVA|ANDROID|NDK|CMAKE)" || true
              echo ""
              echo "Build output structure:"
              find . -type d -name "build" 2>/dev/null || true
              echo ""
              exit 1
            }
          }
        }
        
        echo ""
        echo "âœ… Build completed successfully!"
        
    ############################################################################
    # STEP 13: Verify build output
    # Check that the AAR file was actually created
    ############################################################################
    - name: âœ… Verify AAR file creation
      run: |
        echo "==================================="
        echo "Verifying build output"
        echo "==================================="
        
        # Find all AAR files
        echo "Searching for AAR files..."
        AAR_FILES=$(find . -name "*.aar" -type f)
        
        if [ -z "$AAR_FILES" ]; then
          echo "âŒ No AAR files found!"
          echo ""
          echo "Build output directory structure:"
          find tun2socks/build -type f 2>/dev/null || echo "Build directory not found"
          exit 1
        fi
        
        echo ""
        echo "âœ… AAR files found:"
        echo "$AAR_FILES"
        
        # Show file details
        echo ""
        echo "File details:"
        find . -name "*.aar" -type f -exec ls -lh {} \;
        
        # Find native libraries
        echo ""
        echo "Native libraries:"
        find . -path "*/stripped_native_libs/*/lib/*" -name "*.so" 2>/dev/null | head -20 || echo "No SO files found"
        
    ############################################################################
    # STEP 14: Create comprehensive build information
    # This helps with debugging and provides build details
    ############################################################################
    - name: ğŸ“„ Create detailed build information
      run: |
        echo "==================================="
        echo "Creating build information"
        echo "==================================="
        
        cat > build-info.txt << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              TUN2SOCKS ANDROID AAR BUILD REPORT                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BUILD STATUS: âœ… SUCCESS

BUILD INFORMATION:
- Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
- Repository: LondonX/tun2socks-android
- Commit SHA: ${{ github.sha }}
- Workflow Run: ${{ github.run_number }}
- Triggered By: ${{ github.event_name }}

ENVIRONMENT:
- Runner OS: $(uname -s) $(uname -r)
- Java Version: $(java -version 2>&1 | head -1)
- Gradle Version: $(./gradlew --version | grep Gradle || echo "Unknown")
- Android SDK: $ANDROID_SDK_ROOT
- NDK Path: $ANDROID_NDK_HOME
- CMake: ${CMAKE_DIR:-System CMake}

AAR FILES GENERATED:
$(find . -name "*.aar" -type f -exec basename {} \;)

NATIVE LIBRARIES (ABIs):
$(find . -path "*/stripped_native_libs/*/lib/*" -type d 2>/dev/null | grep -o '[^/]*$' | sort -u || echo "Not found")

FILE SIZES:
$(find . -name "*.aar" -type f -exec du -h {} \;)

USAGE INSTRUCTIONS:
1. Download the 'tun2socks-aar' artifact from this workflow run
2. Extract the AAR file
3. Add to your Android project's libs/ folder
4. Add to build.gradle: implementation files('libs/tun2socks-release.aar')
5. For Flutter: Follow the README instructions in the repository

NATIVE LIBRARIES:
The 'tun2socks-native-libs' artifact contains SO files for:
- arm64-v8a (64-bit ARM)
- armeabi-v7a (32-bit ARM)
- x86 (32-bit x86)
- x86_64 (64-bit x86)

TROUBLESHOOTING:
- If integration fails, check NDK version compatibility
- Ensure minSdkVersion matches (check module build.gradle)
- For Flutter, copy Java files as per repository README

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    BUILD COMPLETED SUCCESSFULLY                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
EOF
        
        cat build-info.txt
        
    ############################################################################
    # STEP 15: Upload AAR artifact
    # This is the main deliverable - the compiled AAR file
    ############################################################################
    - name: ğŸ“¤ Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-${{ github.run_number }}
        path: |
          tun2socks/build/outputs/aar/*.aar
          tun2socks/build/outputs/aar/*.aar.md5
        if-no-files-found: error
        retention-days: 90
        
    ############################################################################
    # STEP 16: Upload native libraries (optional, for manual integration)
    # Some users may want to manually integrate the SO files
    ############################################################################
    - name: ğŸ“¤ Upload native libraries
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-native-libs-${{ github.run_number }}
        path: tun2socks/build/intermediates/stripped_native_libs/release/out/lib/
        if-no-files-found: warn
        retention-days: 90
        
    ############################################################################
    # STEP 17: Upload build information
    # Provides context and instructions for using the build
    ############################################################################
    - name: ğŸ“¤ Upload build information
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.run_number }}
        path: build-info.txt
        retention-days: 90
        
    ############################################################################
    # STEP 18: Upload Java source files (for Flutter integration)
    # Flutter users need the Java wrapper class
    ############################################################################
    - name: ğŸ“¤ Upload Java source for Flutter integration
      uses: actions/upload-artifact@v4
      with:
        name: java-sources-${{ github.run_number }}
        path: tun2socks/src/main/java/**/*.java
        if-no-files-found: warn
        retention-days: 90
        
    ############################################################################
    # FINAL STEP: Success summary
    ############################################################################
    - name: ğŸ‰ Build Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                  BUILD COMPLETED SUCCESSFULLY!                    â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… AAR file built and uploaded"
        echo "âœ… Native libraries extracted"
        echo "âœ… Build information generated"
        echo "âœ… Java sources packaged for Flutter"
        echo ""
        echo "ğŸ“¦ Download artifacts from the Actions tab above"
        echo ""
        echo "Main artifact: tun2socks-aar-${{ github.run_number }}"
        echo ""
        echo "Happy coding! ğŸš€"
        echo ""
