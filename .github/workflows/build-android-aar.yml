name: Build Final tun2socks.aar
on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;26.1.10909125"

      - name: Clone xjasonlyu/tun2socks repository
        uses: actions/checkout@v4
        with:
          repository: xjasonlyu/tun2socks
          path: tun2socks_source

      - name: Build the .so file from source
        run: |
          set -e
          cd tun2socks_source

          # Configure environment for Go C-shared build
          export CGO_ENABLED=1
          export GOOS=android
          export GOARCH=arm64
          export ANDROID_API=21 # Minimum API level
          export NDK_LLVM_BIN="$ANDROID_HOME/ndk/26.1.10909125/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CC="$NDK_LLVM_BIN/clang"
          export CXX="$NDK_LLVM_BIN/clang++"
          export CGO_CFLAGS="--target=aarch64-linux-android${ANDROID_API}"
          export CGO_LDFLAGS="--target=aarch64-linux-android${ANDROID_API}"

          # Build the shared library
          go build -v -trimpath -buildmode=c-shared -o ../libtun2socks.so .
          echo "Successfully built libtun2socks.so"
          ls -lh ../

      - name: Create Android Library Project Structure
        run: |
          mkdir -p android_library/src/main/java/com/example/tun2socks
          mkdir -p android_library/src/main/jniLibs/arm64-v8a

      - name: Copy .so and Create Java Wrapper
        run: |
          # 1. Copy the .so file we just built
          cp libtun2socks.so android_library/src/main/jniLibs/arm64-v8a/

          # 2. Create the Java class that defines the native methods
          cat <<'EOF' > android_library/src/main/java/com/example/tun2socks/Tun2Socks.java
          package com.example.tun2socks;

          public class Tun2Socks {
              static {
                  // This tells Android to load our libtun2socks.so file
                  System.loadLibrary("tun2socks");
              }

              // These are the functions exported by the Go library.
              // The names must match exactly.
              public static native int start(int fd, String proxyUrl);
              public static native int stop();
          }
          EOF

      - name: Create Gradle build file for the library
        run: |
          cat <<'EOF' > android_library/build.gradle
          plugins {
              id 'com.android.library'
          }
          android {
              namespace "com.example.tun2socks"
              compileSdk 34
              defaultConfig {
                  minSdk 21
              }
              buildTypes {
                  release {
                      minifyEnabled false
                  }
              }
          }
          EOF

      - name: Assemble the AAR with Gradle
        run: |
          # Move into the library project directory to run Gradle
          cd android_library
          # Use a local gradle wrapper to build the project
          gradle wrapper --gradle-version 8.2
          ./gradlew assembleRelease

      - name: Upload the final AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-aar
          path: android_library/build/outputs/aar/android_library-release.aar

