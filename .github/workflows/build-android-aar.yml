name: Build Tun2Socks AAR (Local Clone)

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Install Android SDK + NDK
        run: |
          mkdir -p $HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          curl -o ndk.zip https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q ndk.zip -d $HOME/android-sdk/
          echo "ANDROID_NDK_HOME=$HOME/android-sdk/android-ndk-r25c" >> $GITHUB_ENV

      - name: Build Tun2Socks
        run: |
          mkdir workspace
          cd workspace
          
          # 1. Clone the library manually to avoid "unknown revision" errors
          git clone https://github.com/eycorsican/go-tun2socks.git library_src
          
          # 2. Create our wrapper folder
          mkdir wrapper
          cd wrapper
          go mod init github.com/myuser/tun2socks
          
          # 3. Point to the local source code
          go mod edit -replace github.com/eycorsican/go-tun2socks=../library_src
          
          # 4. Create the Go wrapper file
          cat <<'EOF' > tun2socks.go
          package tun2socks

          import (
              "os"
              "github.com/eycorsican/go-tun2socks/core"
              "github.com/eycorsican/go-tun2socks/proxy/socks"
          )

          // Start the tun2socks core loop. 
          // fd: File descriptor
          // proxyAddr: IP of the SOCKS proxy (e.g., "127.0.0.1")
          // proxyPort: Port of the SOCKS proxy (e.g., 10808)
          func Start(fd int, proxyAddr string, proxyPort int) {
              f := os.NewFile(uintptr(fd), "tun")

              proxy := socks.NewSocks5Handler(proxyAddr, uint16(proxyPort))

              core.RegisterTCPConnHandler(proxy)
              core.RegisterUDPConnHandler(proxy)
              core.RegisterOutputFn(func(data []byte) (int, error) {
                  return f.Write(data)
              })

              core.Start()
          }

          func Stop() {
              core.Stop()
          }
          EOF
          
          # 5. Resolve dependencies
          go get github.com/eycorsican/go-tun2socks
          go mod tidy

          # 6. Build the AAR
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../../libtun2socks.aar .
          ls -lh ../../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: "libtun2socks.aar"
