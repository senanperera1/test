name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+ with tun2socks exports)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'

    - name: Set up Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3

    - name: Install gomobile tools
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init

    - name: Patch for 16KB Page Size
      run: |
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]\+/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]\+/-androidapi=35/g' Makefile
        fi
        find . -name "build.gradle*" -type f -exec sed -i \
          -e 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' \
          -e 's/targetSdkVersion [0-9]\+/targetSdkVersion 35/g' \
          -e 's/compileSdk = [0-9]\+/compileSdk = 35/g' \
          -e 's/targetSdk = [0-9]\+/targetSdk = 35/g' {} \;

    - name: Clone go-tun2socks (latest stable) and inject local constructor
      run: |
        # Clone upstream (we’ll patch it locally to provide a stable API)
        git clone --depth 1 --branch v1.16.11 https://github.com/eycorsican/go-tun2socks.git ./third_party/go-tun2socks

        # Ensure it’s a valid module
        cat > third_party/go-tun2socks/go.mod <<'EOF'
        module github.com/eycorsican/go-tun2socks
        go 1.18
        require (
          golang.org/x/net v0.47.0
          golang.org/x/sys v0.24.0
        )
        EOF

        # Inject a stable constructor + runner so symbols exist no matter upstream changes
        cat > third_party/go-tun2socks/core/new_tun2socks.go <<'EOF'
        package core

        import (
          "time"

          "github.com/eycorsican/go-tun2socks/proxy/socks"
        )

        // Tun2SocksRunner offers Start/Stop compatible with older wrappers.
        type Tun2SocksRunner struct {
          fd      int
          tcp     socks.TCPHandler
          udp     socks.UDPHandler
          started bool
        }

        // NewTun2Socks provides a stable constructor used by mobile bindings.
        // It registers provided handlers and runs the main loop over the TUN fd.
        func NewTun2Socks(fd int, tcp socks.TCPHandler, udp socks.UDPHandler) *Tun2SocksRunner {
          return &Tun2SocksRunner{
            fd:  fd,
            tcp: tcp,
            udp: udp,
          }
        }

        // Start wires handlers and starts the core loop. This adapts to public core APIs that exist in v1.16.x.
        func (r *Tun2SocksRunner) Start() {
          if r.started {
            return
          }
          // Register handlers (functions exist in maintained branches)
          RegisterTCPHandler(r.tcp)
          RegisterUDPHandler(r.udp)
          // Kick off main loop on provided tun fd
          Start(r.fd)
          r.started = true
        }

        // Stop terminates the core loop.
        func (r *Tun2SocksRunner) Stop() {
          if !r.started {
            return
          }
          Stop()
          r.started = false
        }

        // Convenience constructor helpers for handlers
        func NewTCPHandler(addr string, port uint16) socks.TCPHandler {
          return socks.NewTCPHandler(addr, port)
        }

        func NewUDPHandler(addr string, port uint16, timeout time.Duration) socks.UDPHandler {
          return socks.NewUDPHandler(addr, port, timeout)
        }
        EOF

    - name: Wire root module to local patched third_party
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.11
          golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        )

        replace github.com/eycorsican/go-tun2socks => ./third_party/go-tun2socks
        EOF

        go mod tidy

    - name: Add libv2ray exports using patched constructor
      run: |
        mkdir -p libv2ray
        cat > libv2ray/tun.go <<'EOF'
        package libv2ray

        import (
          "time"

          "github.com/eycorsican/go-tun2socks/core"
        )

        var tunRunning bool
        var tun interface {
          Start()
          Stop()
        }

        // TunStart(fd, addr, port) starts tun2socks with SOCKS5 proxy.
        func TunStart(fd int, socksAddr string, port uint16) bool {
          if tunRunning {
            return true
          }
          tcp := core.NewTCPHandler(socksAddr, port)
          udp := core.NewUDPHandler(socksAddr, port, 30*time.Second)

          t := core.NewTun2Socks(fd, tcp, udp)
          tun = t
          go t.Start()

          tunRunning = true
          return true
        }

        // TunStop stops the tun2socks runner.
        func TunStop() {
          if tunRunning && tun != nil {
            tun.Stop()
            tunRunning = false
          }
        }
        EOF

    - name: Build AAR (normal module resolution so gobind finds x/mobile/bind)
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export GO111MODULE=on

        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -ldflags="-s -w" \
          -o build/outputs/AndroidLibXrayLite.aar \
          -javapkg=io.github.androidlibxraylite \
          ./libv2ray

    - name: Verify and upload artifacts
      run: |
        ls -lh build/outputs/*.aar || (echo "❌ No AAR built"; exit 1)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: build/outputs/*.aar
        retention-days: 90
