name: Build tun2socks AAR from uploaded .so

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: build-tools;34.0.0

      - name: Prepare Android Library module
        run: |
          # Create folder structure
          mkdir -p tun2socks-android/src/main/jniLibs/arm64-v8a
          mkdir -p tun2socks-android/src/main/java/com/example/tun2socks

          # Copy your uploaded .so file into jniLibs
          cp native/libtun2socks.so tun2socks-android/src/main/jniLibs/arm64-v8a/

          # Minimal Java wrapper class
          cat <<'EOF' > tun2socks-android/src/main/java/com/example/tun2socks/Tun2Socks.java
          package com.example.tun2socks;

          public class Tun2Socks {
              static {
                  System.loadLibrary("tun2socks");
              }

              public static native int start(int fd, String proxyUrl);
              public static native int stop();
          }
          EOF

          # Library build.gradle
          cat <<'EOF' > tun2socks-android/build.gradle
          plugins {
              id 'com.android.library'
          }

          android {
              namespace "com.example.tun2socks"
              compileSdk 34

              defaultConfig {
                  minSdk 21
                  targetSdk 34
              }

              sourceSets {
                  main {
                      java.srcDirs = ['src/main/java']
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }
          }
          EOF

          # Settings.gradle
          echo "include ':tun2socks-android'" > settings.gradle

          # Top-level build.gradle
          cat <<'EOF' > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF

      - name: Initialize Gradle wrapper
        run: gradle wrapper --gradle-version 8.2

      - name: Build AAR
        run: ./gradlew :tun2socks-android:assembleRelease

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-aar
          path: tun2socks-android/build/outputs/aar/*.aar
