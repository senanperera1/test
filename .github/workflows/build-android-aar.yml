name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'
    
    - name: Set up Go 1.23
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
    
    - name: Install gomobile (Latest)
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile with NDK r27
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init
    
    - name: Patch for 16KB Page Size
      run: |
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]*/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]*/-androidapi=35/g' Makefile
        fi
        if [ -f "build.gradle" ]; then
          sed -i 's/compileSdkVersion [0-9]*/compileSdkVersion 35/g' build.gradle
          sed -i 's/targetSdkVersion [0-9]*/targetSdkVersion 35/g' build.gradle
          sed -i 's/minSdkVersion [0-9]*/minSdkVersion 21/g' build.gradle
        fi
    
    - name: Build AAR (with 16KB page size)
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME

        if [ -f "Makefile" ]; then
          make lib
        elif [ -f "build.gradle" ] || [ -f "settings.gradle" ] || [ -f "settings.gradle.kts" ] || [ -f "gradlew" ]; then
          [ -f gradlew ] && chmod +x gradlew || true
          ./gradlew assembleRelease --no-daemon --stacktrace
        else
          echo "Manual gomobile bind fallbackâ€¦"
          if [ -d "Xray-core" ]; then
            cd Xray-core
          elif [ -d "xray-core" ]; then
            cd xray-core
          elif [ -d "core" ]; then
            cd core
          else
            echo "No core directory found, skipping gomobile bind"
            SKIP_BIND=1
          fi
          if [ -z "${SKIP_BIND}" ]; then
            if [ -d "infra/control" ] && \
               grep -R "^[[:space:]]*func[[:space:]]\([A-Z]\)" infra/control >/dev/null 2>&1; then
              gomobile bind -v \
                -target=android \
                -androidapi=35 \
                -ldflags="-s -w" \
                -tags="android" \
                -o libxray.aar \
                -javapkg=io.github.2dust.AndroidLibXrayLite \
                ./infra/control
            else
              echo "Skipping gomobile bind: infra/control missing or no exported names"
            fi
          fi
        fi

        mkdir -p build
        find . -name "*.aar" -type f -exec cp {} build/ \;
        if ! ls build/*.aar >/dev/null 2>&1; then
          echo "âŒ No AAR found!"
          exit 1
        fi
        echo "âœ… AAR built successfully!"
        ls -lh build/
    
    - name: Find and verify AAR
      run: |
        echo "=== Searching for AAR files ==="
        find . -name "*.aar" -type f | while read aar; do
          echo "Found: $aar"
          echo "Size: $(du -h "$aar" | cut -f1)"
          unzip -l "$aar" | grep -i "jni" || echo "No native libs info"
        done
        mkdir -p build
        find . -name "*.aar" -type f -exec cp {} build/ \;
        if [ ! -f build/*.aar ]; then
          echo "âŒ No AAR found!"
          exit 1
        fi
        echo "âœ… AAR built successfully!"
        ls -lh build/
    
    - name: Create 16KB page size verification doc
      run: |
        cat > ANDROID15_COMPATIBILITY.md << 'EOF'
        # Android 15+ (16KB Page Size) Compatibility
        ...
        EOF
    
    - name: Create usage guide
      run: |
        cat > USAGE_GUIDE.md << 'EOF'
        # AndroidLibXrayLite Usage Guide
        ...
        EOF
    
    - name: Create quick start script
      run: |
        cat > QUICK_START.kt << 'EOF'
        // QUICK START: tun2socks to External XRayCore
        ...
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: |
          build/*.aar
          USAGE_GUIDE.md
          ANDROID15_COMPATIBILITY.md
          QUICK_START.kt
        retention-days: 90
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: android15-v${{ github.run_number }}
        name: AndroidLibXrayLite (16KB Page Size)
        files: |
          build/*.aar
          USAGE_GUIDE.md
          ANDROID15_COMPATIBILITY.md
          QUICK_START.kt
        body: |
          ## AndroidLibXrayLite AAR - Android 15+ Compatible
          ...
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build Summary
      if: always()
      run: |
        echo "=================================================="
        echo "ðŸš€ ANDROIDLIBXRAYLITE BUILD (16KB PAGE SIZE)"
        echo "=================================================="
        find build -name "*.aar" -exec ls -lh {} \; || echo "Check artifacts above"
        echo "=================================================="
