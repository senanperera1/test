################################################################################
# WORKFLOW PURPOSE:
# This workflow builds a fully functional AAR file from the LondonX/tun2socks-android
# project, which is a badvpn-based VPN tunnel implementation for Android.
#
# USER REQUEST:
# User wants to build tun2socks-android AAR without forking or manual setup.
# The project has gradle wrapper already, but needs proper environment setup.
#
# SOLUTION:
# This workflow clones the repo, sets up all required tools (JDK, Android SDK/NDK, CMake),
# handles all compatibility issues, and builds the AAR with comprehensive error handling.
#
# KEY FIXES IMPLEMENTED:
# 1. JDK 17 for Android SDK tools (fixes sdkmanager exit code 1 error)
# 2. JDK 11 for project build (old project compatibility)
# 3. Android Platform 33 installation (CRITICAL - project requires compileSdkVersion 33)
# 4. Proper shell script error handling with if-then-else (not broken || && chains)
# 5. NDK version set in build.gradle (eliminates deprecation warnings)
# 6. Three-tier build retry mechanism with different flags
# 7. Environment variables set for all NDK path variants (ANDROID_NDK_HOME, ANDROID_NDK_ROOT, ANDROID_NDK)
#
# OUTPUT:
# - tun2socks-aar: Ready-to-use AAR file with all architectures
# - tun2socks-native-libs: Native SO libraries for manual integration
# - build-info: Build details and troubleshooting information
# - java-sources: Java wrapper classes for Flutter integration
################################################################################

name: Build Tun2Socks AAR - Production Ready

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug output'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    env:
      GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.jvmargs="-Xmx2048m -XX:MaxMetaspaceSize=512m"'
      
    steps:
    ############################################################################
    # STEP 1: Clone the tun2socks-android repository
    ############################################################################
    - name: ðŸ“¥ Checkout tun2socks-android repository
      uses: actions/checkout@v4
      with:
        repository: LondonX/tun2socks-android
        ref: main
        fetch-depth: 1
      
    - name: ðŸ“‹ Display repository info
      run: |
        echo "==================================="
        echo "Repository cloned successfully"
        echo "==================================="
        pwd
        ls -la
        echo ""
        echo "Gradle wrapper exists:"
        ls -la gradle/wrapper/ || echo "No wrapper found"
        echo ""
        
    ############################################################################
    # STEP 2: Setup JDK 17 (Required for Android SDK tools)
    ############################################################################
    - name: â˜• Set up JDK 17 (for Android SDK tools)
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle
        
    - name: âœ… Verify JDK 17 installation
      run: |
        echo "==================================="
        echo "JDK 17 installed for SDK tools"
        echo "==================================="
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        echo ""
        
    ############################################################################
    # STEP 3: Setup Android SDK
    ############################################################################
    - name: ðŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
      continue-on-error: false
      
    - name: âœ… Verify Android SDK installation
      run: |
        echo "==================================="
        echo "Android SDK Setup Complete"
        echo "==================================="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
        ls -la $ANDROID_SDK_ROOT/ || echo "SDK root not found"
        echo ""
        
    ############################################################################
    # STEP 4: Install Android NDK
    ############################################################################
    - name: ðŸ“¦ Install Android NDK 21.4.7075529
      run: |
        echo "==================================="
        echo "Installing Android NDK"
        echo "==================================="
        yes | sdkmanager --licenses || true
        
        echo "Installing NDK 21.4.7075529..."
        if ! sdkmanager --install "ndk;21.4.7075529"; then
          echo "Failed to install primary NDK, trying fallback..."
          if ! sdkmanager --install "ndk;21.3.6528147"; then
            echo "Failed to install fallback NDK, continuing anyway..."
          fi
        fi
        
        echo ""
        echo "NDK installation complete"
        ls -la $ANDROID_SDK_ROOT/ndk/ || echo "NDK directory not found"
        
    ############################################################################
    # STEP 5: Install CMake and Android Platform 33
    ############################################################################
    - name: ðŸ”§ Install CMake and Android Platform
      run: |
        echo "==================================="
        echo "Installing CMake and Android Platform"
        echo "==================================="
        
        # Install Android Platform 33 (CRITICAL - project requires this!)
        echo "Installing Android Platform 33..."
        sdkmanager --install "platforms;android-33"
        
        # Install CMake
        if ! sdkmanager --install "cmake;3.10.2.4988404"; then
          echo "Exact CMake version not available, trying alternatives..."
          if ! sdkmanager --install "cmake;3.18.1"; then
            if ! sdkmanager --install "cmake;3.22.1"; then
              echo "CMake installation failed, will use system CMake"
            fi
          fi
        fi
        
        echo ""
        echo "Installation complete"
        echo "Installed platforms:"
        ls -la $ANDROID_SDK_ROOT/platforms/ | grep android-33 || echo "WARNING: Platform 33 not found!"
        echo ""
        echo "CMake versions:"
        ls -la $ANDROID_SDK_ROOT/cmake/ || echo "CMake directory not found"
        
    ############################################################################
    # STEP 6: Verify all installations and set environment variables
    ############################################################################
    - name: âœ… Verify NDK and CMake installations
      run: |
        echo "==================================="
        echo "Verifying NDK, CMake, and Platform"
        echo "==================================="
        
        echo "Available NDK versions:"
        ls -la $ANDROID_SDK_ROOT/ndk/ 2>/dev/null || echo "No NDK found"
        
        echo ""
        echo "Available CMake versions:"
        ls -la $ANDROID_SDK_ROOT/cmake/ 2>/dev/null || echo "No CMake found"
        
        echo ""
        echo "Available Android Platforms:"
        ls -la $ANDROID_SDK_ROOT/platforms/ 2>/dev/null | grep android || echo "No platforms found"
        
        # Verify android-33 is installed
        if [ ! -d "$ANDROID_SDK_ROOT/platforms/android-33" ]; then
          echo ""
          echo "ERROR: Android Platform 33 not found!"
          echo "This is required by the project's compileSdkVersion."
          echo "Attempting emergency installation..."
          yes | sdkmanager --licenses || true
          sdkmanager --install "platforms;android-33" || {
            echo "Failed to install android-33 platform!"
            exit 1
          }
        else
          echo ""
          echo "âœ… Android Platform 33 verified"
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/ndk/21.4.7075529" ]; then
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/21.4.7075529" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/21.4.7075529" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/21.4.7075529" >> $GITHUB_ENV
          echo "âœ… Using NDK 21.4.7075529"
        elif [ -d "$ANDROID_SDK_ROOT/ndk/21.3.6528147" ]; then
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/21.3.6528147" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/21.3.6528147" >> $GITHUB_ENV
          echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/21.3.6528147" >> $GITHUB_ENV
          echo "âœ… Using NDK 21.3.6528147"
        else
          NDK_VERSION=$(ls $ANDROID_SDK_ROOT/ndk/ 2>/dev/null | head -1)
          if [ ! -z "$NDK_VERSION" ]; then
            echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/$NDK_VERSION" >> $GITHUB_ENV
            echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/$NDK_VERSION" >> $GITHUB_ENV
            echo "ANDROID_NDK=$ANDROID_SDK_ROOT/ndk/$NDK_VERSION" >> $GITHUB_ENV
            echo "âœ… Using NDK $NDK_VERSION"
          else
            echo "âŒ No NDK found!"
            exit 1
          fi
        fi
        
        if [ -d "$ANDROID_SDK_ROOT/cmake/3.10.2.4988404" ]; then
          echo "CMAKE_DIR=$ANDROID_SDK_ROOT/cmake/3.10.2.4988404" >> $GITHUB_ENV
          echo "âœ… Using CMake 3.10.2.4988404"
        else
          CMAKE_VERSION=$(ls $ANDROID_SDK_ROOT/cmake/ 2>/dev/null | head -1)
          if [ ! -z "$CMAKE_VERSION" ]; then
            echo "CMAKE_DIR=$ANDROID_SDK_ROOT/cmake/$CMAKE_VERSION" >> $GITHUB_ENV
            echo "âœ… Using CMake $CMAKE_VERSION"
          else
            echo "âš ï¸ No CMake found in SDK, will use system CMake"
          fi
        fi
        
    ############################################################################
    # STEP 6: Switch to JDK 11
    ############################################################################
    - name: â˜• Set up JDK 11 (for building the project)
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: gradle
        
    - name: âœ… Verify JDK 11 for build
      run: |
        echo "==================================="
        echo "JDK 11 active for project build"
        echo "==================================="
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        echo ""
        
    ############################################################################
    # STEP 8: Create local.properties and fix NDK configuration
    ############################################################################
    - name: ðŸ“ Create local.properties and fix NDK warnings
      run: |
        echo "==================================="
        echo "Creating local.properties"
        echo "==================================="
        
        echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
        
        # Don't set ndk.dir to avoid deprecation warnings
        # Instead, we'll set ndkVersion in build.gradle
        
        if [ ! -z "$CMAKE_DIR" ]; then
          echo "cmake.dir=$CMAKE_DIR" >> local.properties
        fi
        
        echo ""
        echo "local.properties content:"
        cat local.properties
        echo ""
        
        # Fix NDK deprecation warnings by setting ndkVersion in build.gradle
        echo "Patching build.gradle to set ndkVersion..."
        
        if [ -f "tun2socks/build.gradle" ]; then
          # Extract NDK version from path
          NDK_VERSION=$(basename "$ANDROID_NDK_HOME")
          
          # Add ndkVersion to android block if not present
          if ! grep -q "ndkVersion" "tun2socks/build.gradle"; then
            sed -i "/android {/a\    ndkVersion \"$NDK_VERSION\"" tun2socks/build.gradle
            echo "Added ndkVersion to tun2socks/build.gradle"
          fi
        fi
        
        echo ""
        
    ############################################################################
    # STEP 8: Configure gradle.properties
    ############################################################################
    - name: âš™ï¸ Configure gradle.properties
      run: |
        echo "==================================="
        echo "Configuring Gradle properties"
        echo "==================================="
        
        if [ -f gradle.properties ]; then
          cp gradle.properties gradle.properties.backup
        fi
        
        echo "" >> gradle.properties
        echo "org.gradle.jvmargs=-Xmx2048m -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" >> gradle.properties
        echo "org.gradle.parallel=false" >> gradle.properties
        echo "org.gradle.daemon=false" >> gradle.properties
        echo "org.gradle.configureondemand=false" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=false" >> gradle.properties
        echo "android.builder.sdkDownload=false" >> gradle.properties
        
        echo ""
        echo "gradle.properties updated:"
        cat gradle.properties
        echo ""
        
    ############################################################################
    # STEP 10: Setup Gradle wrapper
    ############################################################################
    - name: ðŸ”„ Verify and update Gradle wrapper
      run: |
        echo "==================================="
        echo "Setting up Gradle wrapper"
        echo "==================================="
        
        chmod +x gradlew
        
        echo "Current Gradle wrapper:"
        cat gradle/wrapper/gradle-wrapper.properties | grep distributionUrl || echo "No distribution URL found"
        
        echo ""
        echo "Gradle wrapper is ready"
        
    ############################################################################
    # STEP 11: Clean any previous build artifacts
    ############################################################################
    - name: ðŸ§¹ Clean previous build artifacts
      run: |
        echo "==================================="
        echo "Cleaning previous builds"
        echo "==================================="
        
        if ! ./gradlew clean --no-daemon --stacktrace; then
          echo "Clean failed, manually removing build directories..."
          rm -rf build/
          rm -rf tun2socks/build/
          rm -rf .gradle/
        fi
        
        echo "Clean complete"
        
    ############################################################################
    # STEP 12: Test Gradle configuration
    ############################################################################
    - name: ðŸ” Test Gradle configuration
      run: |
        echo "==================================="
        echo "Testing Gradle configuration"
        echo "==================================="
        
        if ! ./gradlew tasks --no-daemon --stacktrace; then
          echo "Configuration test failed!"
          echo ""
          echo "Attempting to diagnose issues..."
          echo ""
          echo "Project structure:"
          find . -name "build.gradle*" -type f
          echo ""
          exit 1
        fi
        
        echo "Gradle configuration successful"
        
    ############################################################################
    # STEP 13: Build the AAR file (THE MAIN BUILD STEP)
    ############################################################################
    - name: ðŸ—ï¸ Build AAR file
      id: build_aar
      run: |
        echo "==================================="
        echo "Building tun2socks AAR"
        echo "==================================="
        
        DEBUG_FLAGS=""
        if [ "${{ github.event.inputs.debug_mode }}" = "true" ]; then
          DEBUG_FLAGS="--debug"
        fi
        
        # Attempt 1: Full build with info logging
        if ./gradlew tun2socks:assembleRelease --no-daemon --stacktrace --info $DEBUG_FLAGS; then
          echo ""
          echo "Build completed successfully!"
          exit 0
        fi
        
        echo ""
        echo "Build failed! Attempting recovery..."
        echo ""
        
        # Attempt 2: Build without verbose logging
        echo "Retry 1: Building without verbose logging..."
        if ./gradlew tun2socks:assembleRelease --no-daemon --stacktrace; then
          echo ""
          echo "Build completed successfully on retry!"
          exit 0
        fi
        
        echo ""
        echo "Retry 1 failed! Trying with refresh dependencies..."
        echo ""
        
        # Attempt 3: Build with refresh dependencies
        if ./gradlew tun2socks:assembleRelease --no-daemon --stacktrace --refresh-dependencies; then
          echo ""
          echo "Build completed successfully with refresh!"
          exit 0
        fi
        
        # All attempts failed - show diagnostics
        echo ""
        echo "All build attempts failed!"
        echo ""
        echo "Collecting diagnostic information..."
        echo ""
        echo "Java version:"
        java -version
        echo ""
        echo "Gradle version:"
        ./gradlew --version
        echo ""
        echo "Environment variables:"
        env | grep -E "(JAVA|ANDROID|NDK|CMAKE)" || true
        echo ""
        echo "Build output structure:"
        find . -type d -name "build" 2>/dev/null || true
        echo ""
        exit 1
        
    ############################################################################
    # STEP 14: Verify build output
    ############################################################################
    - name: âœ… Verify AAR file creation
      run: |
        echo "==================================="
        echo "Verifying build output"
        echo "==================================="
        
        echo "Searching for AAR files..."
        AAR_FILES=$(find . -name "*.aar" -type f)
        
        if [ -z "$AAR_FILES" ]; then
          echo "No AAR files found!"
          echo ""
          echo "Build output directory structure:"
          find tun2socks/build -type f 2>/dev/null || echo "Build directory not found"
          exit 1
        fi
        
        echo ""
        echo "AAR files found:"
        echo "$AAR_FILES"
        
        echo ""
        echo "File details:"
        find . -name "*.aar" -type f -exec ls -lh {} \;
        
        echo ""
        echo "Native libraries:"
        find . -path "*/stripped_native_libs/*/lib/*" -name "*.so" 2>/dev/null | head -20 || echo "No SO files found"
        
    ############################################################################
    # STEP 15: Create comprehensive build information
    ############################################################################
    - name: ðŸ“„ Create detailed build information
      run: |
        echo "==================================="
        echo "Creating build information"
        echo "==================================="
        
        {
          echo "========================================================================"
          echo "              TUN2SOCKS ANDROID AAR BUILD REPORT"
          echo "========================================================================"
          echo ""
          echo "BUILD STATUS: SUCCESS"
          echo ""
          echo "BUILD INFORMATION:"
          echo "- Build Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "- Repository: LondonX/tun2socks-android"
          echo "- Commit SHA: ${{ github.sha }}"
          echo "- Workflow Run: ${{ github.run_number }}"
          echo "- Triggered By: ${{ github.event_name }}"
          echo ""
          echo "ENVIRONMENT:"
          echo "- Runner OS: $(uname -s) $(uname -r)"
          echo "- Java Version: $(java -version 2>&1 | head -1)"
          echo "- Gradle Version: $(./gradlew --version | grep Gradle || echo 'Unknown')"
          echo "- Android SDK: $ANDROID_SDK_ROOT"
          echo "- NDK Path: $ANDROID_NDK_HOME"
          echo "- CMake: ${CMAKE_DIR:-System CMake}"
          echo ""
          echo "AAR FILES GENERATED:"
          find . -name "*.aar" -type f -exec basename {} \;
          echo ""
          echo "NATIVE LIBRARIES (ABIs):"
          find . -path "*/stripped_native_libs/*/lib/*" -type d 2>/dev/null | grep -o '[^/]*$' | sort -u || echo "Not found"
          echo ""
          echo "FILE SIZES:"
          find . -name "*.aar" -type f -exec du -h {} \;
          echo ""
          echo "USAGE INSTRUCTIONS:"
          echo "1. Download the 'tun2socks-aar' artifact from this workflow run"
          echo "2. Extract the AAR file"
          echo "3. Add to your Android project's libs/ folder"
          echo "4. Add to build.gradle: implementation files('libs/tun2socks-release.aar')"
          echo "5. For Flutter: Follow the README instructions in the repository"
          echo ""
          echo "NATIVE LIBRARIES:"
          echo "The 'tun2socks-native-libs' artifact contains SO files for:"
          echo "- arm64-v8a (64-bit ARM)"
          echo "- armeabi-v7a (32-bit ARM)"
          echo "- x86 (32-bit x86)"
          echo "- x86_64 (64-bit x86)"
          echo ""
          echo "TROUBLESHOOTING:"
          echo "- If integration fails, check NDK version compatibility"
          echo "- Ensure minSdkVersion matches (check module build.gradle)"
          echo "- For Flutter, copy Java files as per repository README"
          echo ""
          echo "========================================================================"
          echo "                    BUILD COMPLETED SUCCESSFULLY"
          echo "========================================================================"
        } > build-info.txt
        
        cat build-info.txt
        
    ############################################################################
    # STEP 16: Upload AAR artifact
    ############################################################################
    - name: ðŸ“¤ Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-${{ github.run_number }}
        path: |
          tun2socks/build/outputs/aar/*.aar
        if-no-files-found: error
        retention-days: 90
        
    ############################################################################
    # STEP 17: Upload native libraries (for manual integration)
    ############################################################################
    - name: ðŸ“¤ Upload native libraries
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-native-libs-${{ github.run_number }}
        path: tun2socks/build/intermediates/stripped_native_libs/release/out/lib/
        if-no-files-found: warn
        retention-days: 90
        
    ############################################################################
    # STEP 18: Upload build information
    ############################################################################
    - name: ðŸ“¤ Upload build information
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ github.run_number }}
        path: build-info.txt
        retention-days: 90
        
    ############################################################################
    # STEP 19: Upload Java sources (for Flutter integration)
    ############################################################################
    - name: ðŸ“¤ Upload Java source for Flutter integration
      uses: actions/upload-artifact@v4
      with:
        name: java-sources-${{ github.run_number }}
        path: tun2socks/src/main/java/**/*.java
        if-no-files-found: warn
        retention-days: 90
        
    ############################################################################
    # STEP 20: Success summary
    ############################################################################
    - name: ðŸŽ‰ Build Summary
      run: |
        echo ""
        echo "========================================================================"
        echo "                  BUILD COMPLETED SUCCESSFULLY!"
        echo "========================================================================"
        echo ""
        echo "AAR file built and uploaded"
        echo "Native libraries extracted"
        echo "Build information generated"
        echo "Java sources packaged for Flutter"
        echo ""
        echo "Download artifacts from the Actions tab above"
        echo ""
        echo "Main artifact: tun2socks-aar-${{ github.run_number }}"
        echo ""
        echo "Happy coding!"
        echo ""
