name: Build tun2socks AAR

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'master'
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        # ✅ Xray-core requires Go >= 1.25
        go-version: '1.25.5'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;26.1.10909125" "platforms;android-34"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/26.1.10909125" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: gomobile init
    
    - name: Download dependencies (Xray-only, QUIC disabled)
      run: |
        # Remove v2ray-core to avoid duplicate proto registration
        rm -rf vendor/github.com/v2fly || true
        # Force Xray-core only
        go get -u github.com/xtls/xray-core@latest
        go mod tidy
        # Disable QUIC to avoid qtls panic
        echo 'GOFLAGS=-tags noquic' >> $GITHUB_ENV
        echo 'XRAY_DISABLE_QUIC=1' >> $GITHUB_ENV
    
    - name: Build AAR
      env:
        GOFLAGS: ${{ env.GOFLAGS }}
        XRAY_DISABLE_QUIC: ${{ env.XRAY_DISABLE_QUIC }}
      run: make android
    
    - name: List build outputs
      run: |
        echo "=== Build directory contents ==="
        find . -name "*.aar" -o -name "*.jar" | head -20
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-xray-noquic
        path: |
          **/*.aar
          **/*-sources.jar
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: build-${{ github.run_number }}
        files: |
          **/*.aar
        body: |
          ## tun2socks AAR (Xray-only, QUIC disabled)
          
          - Links only Xray-core
          - QUIC disabled to avoid qtls ABI mismatch
          - Prevents duplicate protobuf registrations
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show success message
      run: |
        echo "✅ BUILD SUCCESSFUL!"
        find . -name "*.aar" -exec ls -lh {} \;
