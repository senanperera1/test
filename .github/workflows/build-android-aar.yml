name: Build tun2socks AAR

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions: 
  contents: read
  actions: read

jobs:
  build:  
    runs-on: ubuntu-latest
    
    steps: 
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Go
        uses: actions/setup-go@v4
        with:  
          go-version: '1.22'
          cache: true

      - name: Install Android SDK manually
        run: |
          set -e
          
          # Create SDK directory
          mkdir -p ~/android-sdk
          export ANDROID_SDK_ROOT=~/android-sdk
          export ANDROID_HOME=~/android-sdk
          
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          
          # Download and install cmdline-tools
          echo "Downloading Android SDK cmdline-tools..."
          cd ~/android-sdk
          mkdir -p cmdline-tools
          cd cmdline-tools
          
          # Download specific version that actually exists
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11. 0_latest.zip
          unzip -q commandlinetools-linux-11.0_latest.zip
          rm commandlinetools-linux-11.0_latest.zip
          
          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/tools/bin:$PATH
          
          # Accept licenses
          echo "Accepting Android SDK licenses..."
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses > /dev/null 2>&1 || true
          
          # Install required SDK components
          echo "Installing Android SDK components..."
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platforms;android-33" > /dev/null 2>&1 || echo "platforms;android-33 install attempted"
          sdkmanager --sdk_root=$ANDROID_SDK_ROOT "build-tools;34. 0.0" > /dev/null 2>&1 || echo "build-tools install attempted"
          
          # Download and install NDK
          echo "Downloading Android NDK..."
          cd $ANDROID_SDK_ROOT
          mkdir -p ndk
          cd ndk
          
          # Download NDK 26.1.10517047
          wget -q https://dl.google.com/android/repository/android-ndk-r26b-linux. zip
          unzip -q android-ndk-r26b-linux.zip
          rm android-ndk-r26b-linux.zip
          mv android-ndk-r26b 26.1.10517047
          
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10517047" >> $GITHUB_ENV
          
          # Verify installation
          echo "✓ SDK installed at:  $ANDROID_SDK_ROOT"
          echo "✓ NDK installed at: $ANDROID_SDK_ROOT/ndk/26.1.10517047"
          ls -la $ANDROID_SDK_ROOT/ndk/26.1.10517047/toolchains/ | head -10

      - name: Install GoMobile
        run: |
          set -e
          export PATH=$PATH:$(go env GOPATH)/bin
          
          echo "Installing GoMobile..."
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          
          echo "Initializing GoMobile..."
          gomobile init -v
          
          echo "✓ GoMobile installed and initialized"
          gomobile version

      - name: Clone tun2socks repository
        run: |
          set -e
          
          echo "Cloning xjasonlyu/tun2socks..."
          git clone https://github.com/xjasonlyu/tun2socks.git
          cd tun2socks
          git checkout main
          
          echo "✓ Repository cloned"
          echo "Latest commit:"
          git log -1 --oneline
          
          echo ""
          echo "Directory structure:"
          ls -la | head -20

      - name: Download Go dependencies
        run: |
          set -e
          
          cd tun2socks
          
          echo "Downloading Go modules..."
          go mod download
          go mod verify
          
          echo "✓ Dependencies downloaded and verified"
          go mod graph | head -20

      - name:  Create Android wrapper functions
        run: |
          set -e
          
          cd tun2socks
          
          echo "Creating Android wrapper with exported functions..."
          
          cat > android_wrapper.go << 'WRAPPER_EOF'
          package main

          import (
            "fmt"
            "log"
            "github.com/xjasonlyu/tun2socks/v2/engine"
          )

          var (
            engineInstance *engine.Engine
            isRunning      = false
          )

          // Start initializes and starts the tun2socks engine
          // device:  file descriptor path (e.g., "fd://3")
          // proxy: proxy address (e.g., "socks5://127.0.0.1:10808")
          func Start(device string, proxy string) error {
            log.Printf("tun2socks: Starting with device=%s, proxy=%s", device, proxy)
            
            opts := engine.Options{
              Device:  device,
              Proxy:  proxy,
            }
            
            var err error
            engineInstance, err = engine.New(opts)
            if err != nil {
              log.Printf("tun2socks: Failed to create engine: %v", err)
              return fmt. Errorf("failed to create engine: %w", err)
            }
            
            err = engineInstance.Start()
            if err != nil {
              log.Printf("tun2socks: Failed to start engine: %v", err)
              return fmt. Errorf("failed to start engine: %w", err)
            }
            
            isRunning = true
            log.Printf("tun2socks: Engine started successfully")
            return nil
          }

          // Stop gracefully closes the tun2socks engine
          func Stop() error {
            if engineInstance == nil {
              return fmt. Errorf("engine not initialized")
            }
            
            log. Printf("tun2socks:  Stopping engine...")
            err := engineInstance.Close()
            if err != nil {
              log.Printf("tun2socks: Error stopping engine: %v", err)
              return fmt.Errorf("failed to close engine: %w", err)
            }
            
            isRunning = false
            log.Printf("tun2socks: Engine stopped successfully")
            return nil
          }

          // IsRunning checks if the tun2socks engine is currently running
          func IsRunning() bool {
            if engineInstance == nil {
              return false
            }
            return isRunning && engineInstance.Running()
          }

          // GetStatus returns detailed status information
          func GetStatus() string {
            if ! IsRunning() {
              return "Engine not running"
            }
            return fmt.Sprintf("Engine running - Device processing active")
          }
          WRAPPER_EOF
          
          echo "✓ Android wrapper created"
          cat android_wrapper.go

      - name: Install additional build dependencies
        run: |
          set -e
          
          echo "Checking Go build environment..."
          go version
          go env GOROOT
          go env GOPATH
          
          echo ""
          echo "Installing build tools..."
          apt-get update > /dev/null 2>&1
          apt-get install -y build-essential pkg-config > /dev/null 2>&1
          
          echo "✓ Build dependencies installed"

      - name: Build tun2socks AAR
        run:  |
          set -e
          
          cd tun2socks
          
          export PATH=$PATH:$(go env GOPATH)/bin
          export ANDROID_HOME=$ANDROID_HOME
          export ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT
          export ANDROID_NDK_ROOT=$ANDROID_NDK_ROOT
          
          echo "Build environment:"
          echo "  ANDROID_HOME:  $ANDROID_HOME"
          echo "  ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
          echo "  ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          echo "  Go:  $(go version)"
          echo "  GoMobile: $(gomobile version)"
          echo ""
          
          # Verify NDK exists
          if [ ! -d "$ANDROID_NDK_ROOT" ]; then
            echo "❌ ERROR: NDK not found at $ANDROID_NDK_ROOT"
            echo "NDK directory contents:"
            ls -la $ANDROID_SDK_ROOT/ndk/ || echo "No ndk directory found"
            exit 1
          fi
          
          echo "✓ NDK verified at:  $ANDROID_NDK_ROOT"
          echo "  Toolchains available:"
          ls $ANDROID_NDK_ROOT/toolchains/ | head -5
          echo ""
          
          # Build AAR
          echo "Building tun2socks AAR..."
          gomobile bind \
            -target=android \
            -androidapi=21 \
            -o tun2socks.aar \
            -v \
            ./
          
          # Check result
          if [ !  -f "tun2socks.aar" ]; then
            echo "❌ ERROR:  tun2socks.aar was not created!"
            exit 1
          fi
          
          echo "✓ tun2socks.aar build completed successfully"

      - name: Verify AAR artifact
        run: |
          set -e
          
          cd tun2socks
          
          if [ ! -f "tun2socks.aar" ]; then
            echo "❌ ERROR: tun2socks. aar not found!"
            exit 1
          fi
          
          echo "✓ AAR artifact verification:"
          echo "  File:  tun2socks.aar"
          echo "  Size:  $(du -h tun2socks.aar | cut -f1)"
          echo ""
          
          echo "AAR contents:"
          unzip -l tun2socks.aar | head -50
          echo ""
          
          # Verify classes. jar exists inside AAR
          if unzip -t tun2socks.aar | grep -q "classes.jar"; then
            echo "✓ classes.jar found in AAR"
          else
            echo "⚠ Warning: classes.jar not found in AAR"
          fi

      - name: Create integration documentation
        run: |
          set -e
          
          mkdir -p build-output
          cp tun2socks/tun2socks.aar build-output/
          cp tun2socks/android_wrapper.go build-output/
          
          cat > build-output/README.md << 'DOC_EOF'
          # tun2socks Android AAR

          Pure tun2socks library for Android, built from xjasonlyu/tun2socks v2 (with gVisor TCP/IP stack).

          **No bundled Xray-core** – Use with your existing Xray-core AAR.

          ## Installation

          1. Copy `tun2socks.aar` to your Android project: 
             ```
             app/libs/tun2socks.aar
             ```

          2. Update `app/build.gradle`:
             ```gradle
             dependencies {
                 // Add tun2socks library
                 implementation files('libs/tun2socks. aar')
                 
                 // Your existing Xray-core AAR
                 implementation files('libs/xray-core.aar')
             }
             ```

          3.  Sync Gradle

          ## Usage Example

          ```kotlin
          import android.net.VpnService
          import main.Main
          import java.io.FileDescriptor

          class XrayVpnService : VpnService() {

              override fun onCreate() {
                  super.onCreate()
                  startProxy()
              }

              private fun startProxy() {
                  try {
                      // Establish TUN interface
                      val builder = Builder()
                          .addAddress("10.0.0.1", 24)
                          .addRoute("0.0.0.0", 0)
                          .addDnsServer("8.8.8.8")
                          .setSession("Xray VPN")
                      
                      val tunFd = builder.establish()
                      
                      if (tunFd != null) {
                          // Feed TUN packets into tun2socks, which forwards to Xray SOCKS
                          val result = Main.start(
                              "fd://${tunFd. fd}",  // TUN interface FD
                              "socks5://127.0.0.1:10808"  // Xray SOCKS port
                          )
                          
                          if (result == null) {
                              Log. d("Xray", "tun2socks started successfully")
                          } else {
                              Log.e("Xray", "Failed to start tun2socks:  $result")
                          }
                      }
                  } catch (e: Exception) {
                      Log.e("Xray", "Error starting proxy", e)
                  }
              }

              override fun onDestroy() {
                  try {
                      Main.stop()
                  } catch (e: Exception) {
                      Log.e("Xray", "Error stopping tun2socks", e)
                  }
                  super.onDestroy()
              }
          }
          ```

          ## API Reference

          ### `Main.start(device:  String, proxy: String): String?`
          Starts the tun2socks engine. 
          - **device**: File descriptor path (e.g., `"fd://3"`)
          - **proxy**:  Proxy address (e.g., `"socks5://127.0.0.1:10808"`)
          - **returns**: Error message if failed, null if successful

          ### `Main.stop(): String? `
          Stops the tun2socks engine.
          - **returns**: Error message if failed, null if successful

          ### `Main.isRunning(): Boolean`
          Checks if the engine is currently running. 

          ### `Main.getStatus(): String`
          Returns detailed status information.

          ## Architecture

          ```
          [Android VpnService]
                 ↓
              [TUN Interface] (FD)
                 ↓
          [tun2socks] (this AAR)
                 ↓
          [SOCKS5 Proxy] ← Point to Xray-core
                 ↓
            [Xray-core] (your AAR)
                 ↓
           [Internet]
          ```

          ## Build Information

          - **Repository**: xjasonlyu/tun2socks (v2)
          - **Build Method**: GoMobile (gomobile bind)
          - **Target API**: 21+ (Android 5.0+)
          - **NDK Version**:  26.1.10517047
          - **Go Version**: 1.22+

          ## Features

          - Pure tun2socks (no Xray bundled)
          - gVisor-based TCP/IP stack
          - SOCKS5 proxy support
          - System-wide packet routing
          - Lightweight and efficient
          - Active development and maintenance

          ## Troubleshooting

          ### App crashes on startup
          - Ensure VpnService establishes TUN interface before calling `Main.start()`
          - Check that Xray-core is running and listening on SOCKS port

          ### Packets not routing
          - Verify Xray-core AAR is properly integrated
          - Check Xray config has SOCKS inbound on correct port
          - Ensure app has VPN permission

          ### JNI errors
          - Clean build:  `./gradlew clean build`
          - Verify AAR is in `app/libs/` directory
          - Check `build.gradle` includes the files() implementation

          ### Build issues
          - Use NDK 26.x or compatible version
          - Ensure Java 17+ is available
          - Check Go 1.22+ is installed

          ## License

          This AAR is built from xjasonlyu/tun2socks which is licensed under AGPL-3.0.
          See:  https://github.com/xjasonlyu/tun2socks/blob/main/LICENSE

          DOC_EOF
          
          cat > build-output/INTEGRATION_CHECKLIST.md << 'CHECKLIST_EOF'
          # Integration Checklist

          ## Setup
          - [ ] Copy `tun2socks.aar` to `app/libs/`
          - [ ] Add `implementation files('libs/tun2socks.aar')` to `build.gradle`
          - [ ] Add `implementation files('libs/xray-core.aar')` to `build.gradle` (if not already done)
          - [ ] Sync Gradle

          ## AndroidManifest.xml
          - [ ] Add `<uses-permission android:name="android.permission. BIND_VPN_SERVICE" />`
          - [ ] Add `<uses-permission android:name="android.permission.INTERNET" />`
          - [ ] Register VpnService in manifest

          ## Code Implementation
          - [ ] Create VpnService subclass
          - [ ] Call `Main.start("fd://X", "socks5://127.0.0.1:10808")` in onCreate
          - [ ] Call `Main.stop()` in onDestroy
          - [ ] Handle VPN permission request (API 23+)

          ## Testing
          - [ ] Test app starts without crashing
          - [ ] Test VPN permission prompt appears
          - [ ] Test traffic routing through proxy
          - [ ] Verify no crashes after 1 minute
          - [ ] Test graceful shutdown (Main.stop())

          ## Runtime
          - [ ] Xray-core running on port 10808 (or configured port)
          - [ ] VPN service running in foreground
          - [ ] No JNI errors in logcat
          - [ ] Monitor memory usage

          CHECKLIST_EOF
          
          echo "✓ Documentation created"
          ls -lah build-output/

      - name: Upload all artifacts
        uses: actions/upload-artifact@v4
        with:
          name:  tun2socks-aar-complete
          path: build-output/
          retention-days: 90

      - name: Upload AAR only
        uses: actions/upload-artifact@v4
        with: 
          name: tun2socks. aar
          path: build-output/tun2socks.aar
          retention-days: 90

      - name: Create GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with: 
          files: |
            build-output/tun2socks. aar
            build-output/README.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Summary
        if: always()
        run: |
          echo ""
          echo "╔══════════════════════════════════════════════════════╗"
          echo "║     tun2socks Android AAR Build - Build Summary     ║"
          echo "╚══════════════════════════════════════════════════════╝"
          echo ""
          
          if [ -f "build-output/tun2socks.aar" ]; then
            echo "✓ BUILD SUCCESSFUL"
            echo ""
            echo "Artifacts:"
            ls -lh build-output/
            echo ""
            echo "AAR Details:"
            cd build-output
            unzip -l tun2socks.aar | grep -E "\. class|\.so" | wc -l
            echo "  Total files in AAR: $(unzip -l tun2socks.aar | tail -1 | awk '{print $2}')"
            echo ""
          else
            echo "❌ BUILD FAILED - AAR not created"
            exit 1
          fi
          
          echo "Configuration:"
          echo "  Repository: xjasonlyu/tun2socks (v2)"
          echo "  Pure tun2socks (no Xray-core bundled)"
          echo "  Target API: 21+"
          echo "  NDK:  26.1.10517047"
          echo "  Go:  1.22+"
          echo ""
          echo "Next Steps:"
          echo "  1. Download tun2socks.aar from artifacts"
          echo "  2. Place in app/libs/ directory"
          echo "  3. Add to build.gradle dependencies"
          echo "  4. Call Main.start(device, proxy) from VpnService"
          echo "  5. Feed TUN packets to Xray-core SOCKS proxy"
          echo ""
          echo "Documentation:"
          echo "  - README. md - Full integration guide"
          echo "  - INTEGRATION_CHECKLIST.md - Step-by-step setup"
          echo "  - android_wrapper.go - Reference wrapper code"
          echo ""