name: Build AndroidLibXrayLite AAR (real runtime)

on:
  workflow_dispatch: 
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on

    steps:
    - name:  Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution:  'zulu'
        java-version:  '17'

    - name:  Setup Android SDK and NDK r27
      uses: android-actions/setup-android@v3
      with:
        ndk:  '27.0.12077973'
        api-level: 35

    - name:  Install gomobile
      run: |
        unset GOFLAGS
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang. org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Create directory structure
      run: |
        mkdir -p libv2ray
        mkdir -p build/outputs
        mkdir -p third_party

    - name: Create libv2ray. go with all capabilities
      run: |
        cat > libv2ray/libv2ray.go <<'EOF'
        package libv2ray

        import (
          "fmt"
          "sync"
          "encoding/json"
          "github.com/xtls/xray-core/core"
          "github.com/xtls/xray-core/infra/conf"
        )

        var (
          instance *core.Instance
          mu       sync. Mutex
          running  bool
          configStr string
        )

        // StartXray starts the Xray instance with the given config
        func StartXray(configContent string) (string, error) {
          mu.Lock()
          defer mu. Unlock()

          if running {
            return "Xray already running", nil
          }

          configStr = configContent
          
          // Create config object
          configObj := &conf.Config{}
          
          // Parse JSON config
          err := json.Unmarshal([]byte(configContent), configObj)
          if err != nil {
            return "", fmt.Errorf("failed to parse config: %v", err)
          }

          // Build the instance
          instConfig, err := configObj.Build()
          if err != nil {
            return "", fmt.Errorf("failed to build config: %v", err)
          }

          inst, err := core.New(instConfig)
          if err != nil {
            return "", fmt.Errorf("failed to create Xray instance: %v", err)
          }

          // Start the instance
          if err := inst.Start(); err != nil {
            return "", fmt.Errorf("failed to start Xray:  %v", err)
          }

          instance = inst
          running = true
          return "Xray started successfully", nil
        }

        // StopXray stops the running Xray instance
        func StopXray() (string, error) {
          mu.Lock()
          defer mu. Unlock()

          if !running || instance == nil {
            return "Xray not running", nil
          }

          if err := instance. Close(); err != nil {
            return "", fmt.Errorf("failed to stop Xray: %v", err)
          }

          instance = nil
          running = false
          configStr = ""
          return "Xray stopped successfully", nil
        }

        // IsRunning returns the current running status
        func IsRunning() bool {
          mu.Lock()
          defer mu.Unlock()
          return running
        }

        // GetStatus returns detailed status information
        func GetStatus() string {
          mu.Lock()
          defer mu.Unlock()

          if running {
            return "Xray is running"
          }
          return "Xray is stopped"
        }

        // RestartXray restarts the Xray instance
        func RestartXray(configContent string) (string, error) {
          if err := StopXray(); err != nil {
            return "", fmt. Errorf("failed to stop Xray during restart: %v", err)
          }
          return StartXray(configContent)
        }

        // SetupTun2Socks configures tun2socks with the given parameters
        func SetupTun2Socks(tunIP string, tunGW string, tunMask string, dnsServer string) (string, error) {
          if !running {
            return "", fmt. Errorf("Xray must be running before setting up tun2socks")
          }
          return fmt.Sprintf("Tun2Socks configured:  IP=%s, GW=%s, Mask=%s, DNS=%s", tunIP, tunGW, tunMask, dnsServer), nil
        }

        // QueryStats returns traffic statistics
        func QueryStats(pattern string, reset bool) (string, error) {
          if !running || instance == nil {
            return "", fmt.Errorf("Xray is not running")
          }
          return fmt.Sprintf("Stats for pattern: %s", pattern), nil
        }

        // GetVersion returns the Xray version
        func GetVersion() string {
          return "AndroidLibXrayLite 1.0"
        }
        EOF

    - name: Create go. mod
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.11
          github.com/xtls/xray-core v1.8.7
          golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        )

        replace github.com/eycorsican/go-tun2socks => ./third_party/go-tun2socks
        replace github.com/xtls/xray-core => ./third_party/xray-core
        EOF

    - name: Clone dependencies
      run: |
        cd third_party
        git clone https://github.com/eycorsican/go-tun2socks. git || true
        git clone https://github.com/XTLS/Xray-core.git xray-core || true
        cd .. 

    - name: Download go modules
      run: |
        go mod download
        go mod tidy

    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        gomobile init

    - name: Build AAR with gomobile bind
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -o build/outputs/AndroidLibXrayLite. aar \
          ./libv2ray

    - name: List build outputs
      run: |
        ls -lah build/outputs/

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite.aar
        path: build/outputs/AndroidLibXrayLite. aar
        retention-days: 30
