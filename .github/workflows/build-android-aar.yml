name: Build tun2socks AAR (Go 1.18 + gomobile fix)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'master'
    
    - name: Set up Go 1.18.10 (CRITICAL - for qtls and gomobile compatibility)
      uses: actions/setup-go@v5
      with:
        go-version: '1.18.10'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620" "platforms;android-33"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile (compatible version for Go 1.18)
      run: |
        go install golang.org/x/mobile/cmd/gomobile@v0.0.0-20230531173138-3c911d8e3eda
        go install golang.org/x/mobile/cmd/gobind@v0.0.0-20230531173138-3c911d8e3eda
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        gomobile init
    
    - name: Download dependencies
      run: |
        go mod download
    
    - name: Build AAR
      run: |
        make android
    
    - name: List build outputs
      run: |
        echo "=== Build outputs ==="
        find . -name "*.aar" -exec ls -lh {} \;
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR - Working Build

        ## Build Info
        - Built with Go 1.18.10 (required for qtls compatibility with quic-go v0.27.0)
        - gomobile v0.0.0-20230531173138 (compatible with Go 1.18)
        - Uses conflictPolicy=warn for protobuf duplicates

        ## Integration
        ```gradle
        dependencies {
            implementation files('libs/tun2socks.aar')
        }
        ```

        ## SOCKS5 Usage (Connect to external XRayCore/V2Ray)
        ```kotlin
        import tun2socks.Tun2socks

        class MyVpnService : VpnService() {
            private val vpnService = object : tun2socks.VpnService {
                override fun protect(fd: Long) = this@MyVpnService.protect(fd.toInt())
            }
            
            private val logService = object : tun2socks.LogService {
                override fun writeLog(log: String?) {
                    Log.d("Tun2socks", log ?: "")
                }
            }
            
            private val querySpeed = object : tun2socks.QuerySpeed {
                override fun updateTraffic(up: Long, down: Long) {
                    // Update UI with traffic
                }
            }
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                val vpnInterface = Builder()
                    .setMtu(1500)
                    .addAddress("10.0.0.2", 24)
                    .addRoute("0.0.0.0", 0)
                    .addDnsServer("8.8.8.8")
                    .setSession("Tun2socks")
                    .establish() ?: return START_NOT_STICKY
                
                val config = tun2socks.Vmess().apply {
                    add = "127.0.0.1"
                    port = 10808
                    net = "socks"
                }
                
                Tun2socks.startV2Ray(
                    vpnInterface.detachFd().toLong(),
                    500,
                    vpnService,
                    logService,
                    querySpeed,
                    false,
                    config,
                    "",
                    ""
                )
                return START_STICKY
            }
            
            override fun onDestroy() {
                Tun2socks.stopV2Ray()
                super.onDestroy()
            }
        }
        ```

        ## Troubleshooting History
        **Problem 1**: qtls error with Go 1.21/1.19
        - Cause: quic-go v0.27.0 only supports Go 1.18
        - Fix: Downgrade to Go 1.18.10

        **Problem 2**: gomobile@latest incompatible with Go 1.18
        - Cause: Latest gomobile requires Go 1.24+
        - Fix: Use gomobile v0.0.0-20230531173138 (last version supporting Go 1.18)

        **Problem 3**: Protobuf duplicate registrations
        - Cause: V2Ray and XRay both register same protos
        - Fix: Already handled by Makefile with conflictPolicy=warn flag

        ## Notes
        - This build INCLUDES V2Ray/XRay cores but they have conflicts
        - Use SOCKS5 mode to connect to external proxy (recommended)
        - Built AAR will be in build/ directory
        EOF
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar
        path: |
          build/*.aar
          build/*-sources.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: build-${{ github.run_number }}
        files: |
          build/*.aar
          USAGE.md
        body: |
          ## tun2socks AAR (Fixed Build)
          
          **Fixed Issues:**
          - ✅ Go 1.18.10 for qtls compatibility
          - ✅ gomobile v0.0.0-20230531173138 for Go 1.18
          - ✅ Protobuf conflicts handled with warn policy
          
          **Recommendation:** Use SOCKS5 mode with external XRayCore
          
          See USAGE.md for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show success
      run: |
        echo "✅ BUILD COMPLETE!"
        echo "Download from Artifacts section above"
        find build -name "*.aar" -exec ls -lh {} \;
