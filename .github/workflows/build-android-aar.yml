name: Build tun2socks AAR

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'main'
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;25.2.9519653" "platforms;android-30"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        gomobile init
    
    - name: Download dependencies
      run: |
        go get -d ./...
    
    - name: Build AAR
      run: |
        make android
    
    - name: List build outputs
      run: |
        echo "=== Build directory contents ==="
        find . -name "*.aar" -o -name "*.jar" | head -20
        ls -lah *.aar 2>/dev/null || echo "No AAR in root"
        ls -lah build/ 2>/dev/null || echo "No build directory"
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR with V2Ray/XRay Support

        Built from xxf098/go-tun2socks-build - supports V2Ray and XRay cores.

        ## Integration

        1. Add to your Android project:
           ```gradle
           dependencies {
               implementation files('libs/tun2socks.aar')
           }
           ```

        ## Usage (Kotlin)

        ```kotlin
        import tun2socks.Tun2socks

        class MyVpnService : VpnService() {
            
            // Implement required interfaces
            private val vpnService = object : tun2socks.VpnService {
                override fun protect(fd: Long): Boolean {
                    return this@MyVpnService.protect(fd.toInt())
                }
            }
            
            private val logService = object : tun2socks.LogService {
                override fun writeLog(log: String?) {
                    Log.d("Tun2socks", log ?: "")
                }
            }
            
            private val querySpeed = object : tun2socks.QuerySpeed {
                override fun updateTraffic(up: Long, down: Long) {
                    // Update your UI with traffic stats
                }
            }
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                // Setup VPN interface
                val builder = Builder()
                    .setMtu(1500)
                    .addAddress("10.0.0.2", 24)
                    .addRoute("0.0.0.0", 0)
                    .addDnsServer("8.8.8.8")
                    .setSession("Tun2socks VPN")
                
                val vpnInterface = builder.establish() ?: return START_NOT_STICKY
                val tunFd = vpnInterface.detachFd()
                
                // Start with XRay core
                try {
                    val vmessConfig = tun2socks.Vmess().apply {
                        host = "your.server.com"
                        path = "/path"
                        tls = "tls"
                        add = "your.server.com"
                        port = 443
                        aid = 0
                        net = "ws"
                        id = "your-uuid-here"
                    }
                    
                    Tun2socks.startXRayWithTunFd(
                        tunFd.toLong(),
                        vpnService,
                        logService,
                        querySpeed,
                        vmessConfig,
                        filesDir.absolutePath // asset path
                    )
                    
                    Log.i("VPN", "XRay started successfully")
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to start", e)
                }
                
                return START_STICKY
            }
            
            override fun onDestroy() {
                try {
                    Tun2socks.stopXRay()
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to stop", e)
                }
                super.onDestroy()
            }
        }
        ```

        ## Simple SOCKS5 Usage

        If you just want to use a SOCKS5 proxy (like from XRayCore running separately):

        ```kotlin
        // Create a simple config
        val vmessConfig = tun2socks.Vmess().apply {
            // Configure for socks5 proxy at 127.0.0.1:10808
            add = "127.0.0.1"
            port = 10808
            net = "socks"
        }
        
        Tun2socks.startV2RayWithTunFd(
            tunFd.toLong(),
            vpnService,
            logService,
            querySpeed,
            vmessConfig,
            filesDir.absolutePath
        )
        ```

        ## Features

        - ✅ V2Ray core support
        - ✅ XRay core support  
        - ✅ VMess, VLESS, Trojan, Shadowsocks protocols
        - ✅ Traffic statistics
        - ✅ Works with external XRayCore via SOCKS5
        - ✅ Full TUN integration

        ## Integration with External XRayCore

        1. Start your XRayCore with SOCKS5 inbound on `127.0.0.1:10808`
        2. Use the simple SOCKS5 usage above
        3. All TUN traffic will be forwarded to your XRayCore

        ## Notes

        - Remember to call `protect()` on all sockets to avoid routing loops
        - Implement the `LogService` interface to see debug logs
        - Implement `QuerySpeed` to monitor traffic
        EOF
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar
        path: |
          **/*.aar
          **/*-sources.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        files: |
          **/*.aar
          USAGE.md
        body: |
          ## tun2socks AAR with V2Ray/XRay Support
          
          Built from xxf098/go-tun2socks-build
          
          ### Features:
          - V2Ray and XRay core support
          - VMess, VLESS, Trojan, Shadowsocks
          - Works with external XRayCore via SOCKS5
          - Traffic statistics
          
          ### Quick Start:
          See USAGE.md for complete integration guide.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}