name: Build xjasonlyu-tun2socks AAR

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install gomobile and dependencies
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Install Android SDK + NDK
        run: |
          mkdir -p $HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          curl -o ndk.zip https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q ndk.zip -d $HOME/android-sdk/
          echo "ANDROID_NDK_HOME=$HOME/android-sdk/android-ndk-r25c" >> $GITHUB_ENV

      - name: Create Tun2Socks Wrapper from xjasonlyu/tun2socks
        run: |
          # 1. Create a workspace
          mkdir -p workspace/wrapper
          cd workspace

          # 2. Clone the user's chosen repository
          git clone https://github.com/xjasonlyu/tun2socks.git library_src
          
          # 3. Navigate into our wrapper directory
          cd wrapper
          go mod init github.com/myuser/tun2socks
          
          # 4. Point to the local source code of the real library
          go mod edit -replace=github.com/xjasonlyu/tun2socks/v2=../library_src
          
          # 5. Create our Go wrapper file that calls the library's internal functions
          cat <<'EOF' > tun2socks.go
          package tun2socks

          import (
              "context"
              "fmt"
              "io"
              "os"
              "time"
              "log"

              "github.com/xjasonlyu/tun2socks/v2/core"
              "github.com/xjasonlyu/tun2socks/v2/proxy"
              "github.com/xjasonlyu/tun2socks/v2/tun"
              _ "golang.org/x/mobile/bind"
          )

          var (
              ctx    context.Context
              cancel context.CancelFunc
          )

          // This function replicates the core logic of xjasonlyu/tun2socks's main.go
          func Start(fd int, proxyURL string) error {
              ctx, cancel = context.WithCancel(context.Background())

              // Open TUN device from file descriptor
              mtu := 1500 // A standard MTU, can be adjusted
              tunDev, err := tun.Open(fmt.Sprintf("fd://%d", fd), mtu)
              if err != nil {
                  return fmt.Errorf("failed to open tun device: %w", err)
              }

              // Create proxy handler
              proxyHandler, err := proxy.New(proxyURL)
              if err != nil {
                  return fmt.Errorf("failed to create proxy handler: %w", err)
              }

              // Create lwIP stack
              lwipStack := core.NewLWIPStack()

              // Register handlers
              core.RegisterTCPConnHandler(proxyHandler)
              core.RegisterUDPConnHandler(proxyHandler)
              core.RegisterOutputFn(func(data []byte, writeCount int) {
                  tunDev.Write(data[:writeCount])
              })

              log.Println("xjasonlyu/tun2socks is running")

              // Start the event loop
              go lwipStack.Start()
              
              // Read from TUN device
              packet := make([]byte, mtu)
              for {
                  select {
                  case <-ctx.Done():
                      return nil
                  default:
                      n, err := tunDev.Read(packet)
                      if err != nil {
                          return err
                      }
                      lwipStack.Write(packet[:n])
                  }
              }
          }

          func Stop() {
              if cancel != nil {
                  cancel()
              }
              log.Println("xjasonlyu/tun2socks is stopping")
          }
          EOF
          
          # 6. Get dependencies
          go get golang.org/x/mobile/bind
          go get github.com/xjasonlyu/tun2socks/v2
          go mod tidy

      - name: Build Tun2Socks AAR
        working-directory: workspace/wrapper
        run: |
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../../libtun2socks.aar .
          ls -lh ../../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar-xjasonlyu
          path: "libtun2socks.aar"
