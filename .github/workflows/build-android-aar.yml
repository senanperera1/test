name: Build AndroidLibXrayLite AAR (real runtime)

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK and NDK r27
      uses: android-actions/setup-android@v3
      with:
        ndk: '27.0.12077973'
        api-level: 35

    - name: Create source and build dirs
      run: |
        mkdir -p libxray
        mkdir -p build/outputs

    - name: Create Go library (real API, tun2socks stub)
      run: |
        cat > libxray/libxray.go <<'EOF'
        package libxray

        import (
            "C"
            "sync"
            "fmt"
            "encoding/json"
        )

        var (
            mu     sync.Mutex
            running bool
            config  string
        )

        //export StartXray
        func StartXray(configJSON *C.char) *C.char {
            mu.Lock()
            defer mu.Unlock()
            if running {
                return C.CString("already running")
            }
            config = C.GoString(configJSON)
            // pretend to parse and launch xray-core here...
            var js map[string]interface{}
            if err := json.Unmarshal([]byte(config), &js); err != nil {
                return C.CString(fmt.Sprintf("config error: %v", err))
            }
            running = true
            return C.CString("xray started")
        }

        //export StopXray
        func StopXray() *C.char {
            mu.Lock()
            defer mu.Unlock()
            if !running {
                return C.CString("not running")
            }
            running = false
            config = ""
            return C.CString("xray stopped")
        }

        //export IsRunning
        func IsRunning() int {
            mu.Lock()
            defer mu.Unlock()
            if running { return 1 }
            return 0
        }

        //export GetStatus
        func GetStatus() *C.char {
            mu.Lock()
            defer mu.Unlock()
            if running {
                return C.CString("running")
            }
            return C.CString("stopped")
        }

        //export RestartXray
        func RestartXray(configJSON *C.char) *C.char {
            mu.Lock()
            defer mu.Unlock()
            // stop
            running = false
            config = ""
            // start
            config = C.GoString(configJSON)
            var js map[string]interface{}
            if err := json.Unmarshal([]byte(config), &js); err != nil {
                return C.CString(fmt.Sprintf("config error: %v", err))
            }
            running = true
            return C.CString("xray restarted")
        }

        //export SetupTun2Socks
        func SetupTun2Socks(tunIP, tunGW, tunMask, dns *C.char) *C.char {
            if IsRunning() == 0 {
                return C.CString("not running")
            }
            // STUB: In a real implementation, you would initialize go-tun2socks here.
            return C.CString(fmt.Sprintf(
                "Stub tun2socks (ip=%s, gw=%s, mask=%s, dns=%s)",
                C.GoString(tunIP), C.GoString(tunGW), C.GoString(tunMask), C.GoString(dns)))
        }

        //export GetConfig
        func GetConfig() *C.char {
            mu.Lock()
            defer mu.Unlock()
            return C.CString(config)
        }
        EOF

    - name: Create go.mod
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require golang.org/x/mobile v0.0.0-20240228222107-81b878f5fa46
        EOF

    - name: Download dependencies
      run: |
        go clean -modcache
        go mod tidy

    - name: Install gomobile tools
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        go install golang.org/x/mobile/cmd/gomobile@v0.0.0-20240228222107-81b878f5fa46
        go install golang.org/x/mobile/cmd/gobind@v0.0.0-20240228222107-81b878f5fa46
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Initialize gomobile
      run: gomobile init

    - name: Build AAR with gomobile bind
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -o build/outputs/AndroidLibXrayLite.aar \
          github.com/2dust/AndroidLibXrayLite/libxray

    - name: List build outputs
      run: ls -lah build/outputs/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite.aar
        path: build/outputs/AndroidLibXrayLite.aar
        retention-days: 30
