name: Build tun2socks AAR with JNI bridge only

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          components: build-tools;34.0.0

      - name: Prepare Android Library module
        run: |
          # Create folder structure
          mkdir -p tun2socks-android/src/main/jniLibs/arm64-v8a
          mkdir -p tun2socks-android/src/main/java/tun2socks
          mkdir -p tun2socks-android/src/main/cpp

          # Copy your prebuilt libtun2socks.so into jniLibs
          cp native/libtun2socks.so tun2socks-android/src/main/jniLibs/arm64-v8a/

          # Java wrapper class
          cat <<'EOF' > tun2socks-android/src/main/java/tun2socks/Tun2Socks.java
          package tun2socks;

          public class Tun2Socks {
              static {
                  System.loadLibrary("tun2socks_jni"); // load JNI bridge
                  System.loadLibrary("tun2socks");     // load prebuilt core
              }

              public static native int start(int fd, String proxyUrl);
              public static native int stop();
          }
          EOF

          # JNI bridge C file
          cat <<'EOF' > tun2socks-android/src/main/cpp/tun2socks_jni.c
          #include <jni.h>
          #include <dlfcn.h>
          #include <string.h>

          typedef int (*tun2socks_start_fn)(int fd, const char *url);
          typedef int (*tun2socks_stop_fn)();

          static tun2socks_start_fn core_start = NULL;
          static tun2socks_stop_fn core_stop = NULL;

          static void ensure_loaded() {
              if (core_start == NULL || core_stop == NULL) {
                  void *handle = dlopen("libtun2socks.so", RTLD_NOW);
                  if (handle) {
                      core_start = (tun2socks_start_fn)dlsym(handle, "tun2socks_start");
                      core_stop  = (tun2socks_stop_fn)dlsym(handle, "tun2socks_stop");
                  }
              }
          }

          JNIEXPORT jint JNICALL
          Java_tun2socks_Tun2Socks_start(JNIEnv *env, jclass clazz, jint fd, jstring proxyUrl) {
              ensure_loaded();
              if (core_start == NULL) return -1;
              const char *url = (*env)->GetStringUTFChars(env, proxyUrl, 0);
              int result = core_start(fd, url);
              (*env)->ReleaseStringUTFChars(env, proxyUrl, url);
              return result;
          }

          JNIEXPORT jint JNICALL
          Java_tun2socks_Tun2Socks_stop(JNIEnv *env, jclass clazz) {
              ensure_loaded();
              if (core_stop == NULL) return -1;
              return core_stop();
          }
          EOF

          # Android.mk for JNI bridge only
          cat <<'EOF' > tun2socks-android/src/main/cpp/Android.mk
          LOCAL_PATH := $(call my-dir)

          include $(CLEAR_VARS)
          LOCAL_MODULE    := tun2socks_jni
          LOCAL_SRC_FILES := tun2socks_jni.c
          LOCAL_LDLIBS    := -llog -ldl
          include $(BUILD_SHARED_LIBRARY)
          EOF

          # Library build.gradle
          cat <<'EOF' > tun2socks-android/build.gradle
          plugins {
              id 'com.android.library'
          }

          android {
              namespace "tun2socks"
              compileSdk 34

              defaultConfig {
                  minSdk 21
                  targetSdk 34
              }

              sourceSets {
                  main {
                      java.srcDirs = ['src/main/java']
                      jniLibs.srcDirs = ['src/main/jniLibs']
                  }
              }

              externalNativeBuild {
                  ndkBuild {
                      path "src/main/cpp/Android.mk"
                  }
              }
          }
          EOF

          # Settings.gradle
          echo "include ':tun2socks-android'" > settings.gradle

          # Top-level build.gradle
          cat <<'EOF' > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF

      - name: Initialize Gradle wrapper
        run: gradle wrapper --gradle-version 8.2

      - name: Build AAR
        run: ./gradlew :tun2socks-android:assembleRelease

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-aar
          path: tun2socks-android/build/outputs/aar/*.aar
