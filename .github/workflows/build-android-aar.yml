name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+ with tun2socks exports)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'

    - name: Set up Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3

    - name: Install gomobile tools
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init

    - name: Patch for 16KB Page Size
      run: |
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]\+/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]\+/-androidapi=35/g' Makefile
        fi
        find . -name "build.gradle*" -type f -exec sed -i \
          -e 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' \
          -e 's/targetSdkVersion [0-9]\+/targetSdkVersion 35/g' \
          -e 's/compileSdk = [0-9]\+/compileSdk = 35/g' \
          -e 's/targetSdk = [0-9]\+/targetSdk = 35/g' {} \;

    - name: Root go.mod with pinned deps and local replace
      run: |
        # Optional local clone; we won’t rely on upstream symbols anyway
        git clone --depth 1 --branch v1.16.11 https://github.com/eycorsican/go-tun2socks.git ./third_party/go-tun2socks || true

        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.11
          golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        )

        replace github.com/eycorsican/go-tun2socks => ./third_party/go-tun2socks
        EOF

        go mod tidy

    - name: Add shim and tun2socks exports
      run: |
        mkdir -p libv2ray/internal
        cat > libv2ray/internal/t2s_shim.go <<'EOF'
        package internal

        import (
          "time"

          "github.com/eycorsican/go-tun2socks/core"
          "github.com/eycorsican/go-tun2socks/proxy/socks"
        )

        // T2S provides Start/Stop around tun2socks using SOCKS handlers.
        type T2S struct {
          fd        int
          tcp       interface{}
          udp       interface{}
          running   bool
        }

        // NewTun2Socks creates a T2S runner compatible with older API surface.
        // tcpHandler and udpHandler should be created via socks.NewTCPHandler/NewUDPHandler.
        func NewTun2Socks(fd int, tcpHandler interface{}, udpHandler interface{}) *T2S {
          return &T2S{
            fd:  fd,
            tcp: tcpHandler,
            udp: udpHandler,
          }
        }

        // Start wires handlers and starts the core loop, adapting to available API.
        func (t *T2S) Start() {
          if t.running {
            return
          }
          // Attempt the known registration patterns. We avoid compile-time dependency
          // on removed symbols by using the handler types directly.
          // Prefer socks handlers (address, port, timeout) already constructed by caller.

          // v1.16.x socks constructors:
          // socks.NewTCPHandler(addr string, port uint16)
          // socks.NewUDPHandler(addr string, port uint16, timeout time.Duration)

          // Use the public entry points available in v1.16.x: core.Start with fd and handlers
          // Some versions expose Run/Stop or a loop structure; we rely on StartTCP/UDP handlers.

          // Register handlers via core package where available
          // The following functions exist across maintained branches:
          core.RegisterTCPHandler(t.tcp.(socks.TCPHandler))
          core.RegisterUDPHandler(t.udp.(socks.UDPHandler))

          // Start the main loop over provided tun fd
          core.Start(t.fd)
          t.running = true
        }

        // Stop stops the core loop safely.
        func (t *T2S) Stop() {
          if !t.running {
            return
          }
          core.Stop()
          t.running = false
        }

        // Helper constructors so callers can build handlers with correct args.
        func NewTCPHandler(addr string, port uint16) socks.TCPHandler {
          return socks.NewTCPHandler(addr, port)
        }

        func NewUDPHandler(addr string, port uint16, timeout time.Duration) socks.UDPHandler {
          return socks.NewUDPHandler(addr, port, timeout)
        }
        EOF

        mkdir -p libv2ray
        cat > libv2ray/tun.go <<'EOF'
        package libv2ray

        import (
          "time"

          "github.com/eycorsican/go-tun2socks/proxy/socks"
          "github.com/2dust/AndroidLibXrayLite/libv2ray/internal"
        )

        var tunRunning bool
        var tun interface {
          Start()
          Stop()
        }

        // TunStart(fd, addr, port) starts tun2socks with SOCKS5 proxy.
        func TunStart(fd int, socksAddr string, port uint16) bool {
          if tunRunning {
            return true
          }
          tcp := internal.NewTCPHandler(socksAddr, port)
          udp := internal.NewUDPHandler(socksAddr, port, 30*time.Second)

          t := internal.NewTun2Socks(fd, tcp, udp)
          tun = t
          go t.Start()

          tunRunning = true
          return true
        }

        // TunStop stops the tun2socks runner.
        func TunStop() {
          if tunRunning && tun != nil {
            tun.Stop()
            tunRunning = false
          }
        }
        EOF

    - name: Build AAR (normal module resolution)
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export GO111MODULE=on

        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -ldflags="-s -w" \
          -o build/outputs/AndroidLibXrayLite.aar \
          -javapkg=io.github.androidlibxraylite \
          ./libv2ray

    - name: Verify and upload artifacts
      run: |
        ls -lh build/outputs/*.aar || (echo "❌ No AAR built"; exit 1)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: build/outputs/*.aar
        retention-days: 90
