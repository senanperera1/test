name: Build Separate Tun2Socks AAR

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Install Android SDK + NDK
        run: |
          mkdir -p $HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          curl -o ndk.zip https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q ndk.zip -d $HOME/android-sdk/
          echo "ANDROID_NDK_HOME=$HOME/android-sdk/android-ndk-r25c" >> $GITHUB_ENV

      - name: Create Tun2Socks Wrapper
        run: |
          mkdir tun2socks
          cd tun2socks
          go mod init github.com/myuser/tun2socks
          
          # Get go-tun2socks (using latest commit hash for stability instead of tag)
          go get github.com/eycorsican/go-tun2socks@master
          
          # Create wrapper
          cat <<EOF > tun2socks.go
          package tun2socks

          import (
              "os"
              "github.com/eycorsican/go-tun2socks/core"
              "github.com/eycorsican/go-tun2socks/proxy/socks"
          )

          // Simple start function
          func Start(fd int, proxyAddr string, proxyPort int) {
              // Create file from FD
              f := os.NewFile(uintptr(fd), "tun")

              // Create SOCKS5 handler
              // Note: Use 127.0.0.1 as default if empty
              host := proxyAddr
              if host == "" {
                  host = "127.0.0.1"
              }
              
              // Standard SOCKS5 handler
              proxy := socks.NewSocks5Handler(host, uint16(proxyPort))

              // Register handlers
              core.RegisterTCPConnHandler(proxy)
              core.RegisterUDPConnHandler(proxy)
              
              // Register output callback
              core.RegisterOutputFn(func(data []byte) (int, error) {
                  return f.Write(data)
              })

              // Start the loop (blocking)
              core.Start()
          }

          func Stop() {
              core.Stop()
          }
          EOF
          
          go mod tidy

      - name: Build Tun2Socks AAR
        working-directory: tun2socks
        run: |
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../libtun2socks.aar .
          ls -lh ../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: "libtun2socks.aar"
