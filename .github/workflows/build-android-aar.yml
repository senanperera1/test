name: Build LondonX tun2socks AAR (authenticated checkout)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build-upstream-tun2socks:
    runs-on: ubuntu-latest
    env:
      ANDROID_API_LEVEL: 35
      ANDROID_NDK_VERSION: 27.0.12077973
      UPSTREAM_REPO: LondonX/universal-android-tun2socks
      UPSTREAM_BRANCH: main
      UPSTREAM_DIR: upstream-tun2socks

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Show intent
        run: |
          echo "UPSTREAM_REPO=${{ env.UPSTREAM_REPO }}"
          echo "UPSTREAM_BRANCH=${{ env.UPSTREAM_BRANCH }}"

      - name: Checkout upstream repo (authenticated if UPSTREAM_PAT provided)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ env.UPSTREAM_BRANCH }}
          path: ${{ env.UPSTREAM_DIR }}
          fetch-depth: 1
          # If UPSTREAM_PAT secret exists, actions/checkout will automatically use GITHUB_TOKEN.
          # To force using a PAT, set token: ${{ secrets.UPSTREAM_PAT }} (see notes below).

      - name: If checkout failed, try authenticated git clone (fallback)
        if: failure()
        run: |
          echo "Authenticated fallback clone using UPSTREAM_PAT (if provided)"
          if [ -z "${{ secrets.UPSTREAM_PAT }}" ]; then
            echo "No UPSTREAM_PAT secret found. Cannot clone private upstream repo."
            exit 1
          fi
          rm -rf "${{ env.UPSTREAM_DIR }}" || true
          git clone --depth 1 --branch "${{ env.UPSTREAM_BRANCH }}" "https://x-access-token:${{ secrets.UPSTREAM_PAT }}@github.com/${{ env.UPSTREAM_REPO }}.git" "${{ env.UPSTREAM_DIR }}" || {
            echo "Authenticated clone failed. Check UPSTREAM_REPO and UPSTREAM_PAT."
            exit 1
          }

      - name: Show upstream layout
        run: |
          echo "=== upstream dir: ${{ env.UPSTREAM_DIR }} ==="
          ls -la "${{ env.UPSTREAM_DIR }}" || true
          find "${{ env.UPSTREAM_DIR }}" -maxdepth 3 -type f \( -name gradlew -o -name settings.gradle -o -name build.gradle \) -print || true

      - name: Set up Java JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK and NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_API_LEVEL }}
          ndk: ${{ env.ANDROID_NDK_VERSION }}

      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true

      - name: Make upstream gradlew executable if present
        run: |
          GW=$(find "${{ env.UPSTREAM_DIR }}" -maxdepth 2 -type f -name gradlew | head -n 1 || true)
          if [ -n "$GW" ]; then
            chmod +x "$GW"
            echo "Found gradlew: $GW"
          else
            echo "No gradlew found in upstream repo"
          fi

      - name: Build upstream tun2socks
        run: |
          set -euo pipefail
          UP="${{ env.UPSTREAM_DIR }}"
          GW=$(find "$UP" -maxdepth 2 -type f -name gradlew | head -n 1 || true)
          if [ -n "$GW" ]; then
            GW_DIR=$(dirname "$GW")
            pushd "$GW_DIR"
            ./gradlew clean --no-daemon --stacktrace || true
            ./gradlew tun2socks:assembleRelease --no-daemon --stacktrace
            popd
          else
            echo "No gradlew wrapper; checking for build files"
            BUILD_FILE=$(find "$UP" -maxdepth 3 -type f -name 'settings.gradle' -o -name 'build.gradle' | head -n 1 || true)
            if [ -n "$BUILD_FILE" ]; then
              BUILD_DIR=$(dirname "$BUILD_FILE")
              pushd "$BUILD_DIR"
              gradle clean --no-daemon --stacktrace || true
              gradle tun2socks:assembleRelease --no-daemon --stacktrace
              popd
            else
              echo "No Gradle build files found in upstream repo. Nothing to build."
              exit 1
            fi
          fi

      - name: Collect outputs
        run: |
          mkdir -p build/outputs
          find "${{ env.UPSTREAM_DIR }}" -type f -name "*.aar" -exec cp {} build/outputs/ \; || true
          STRIPPED="${{ env.UPSTREAM_DIR }}/tun2socks/build/intermediates/stripped_native_libs/release/out/lib"
          if [ -d "$STRIPPED" ]; then
            mkdir -p build/outputs/jniLibs
            cp -r "$STRIPPED"/* build/outputs/jniLibs/ || true
          fi
          ls -la build/outputs || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: londonx-tun2socks-artifacts
          path: |
            build/outputs/*.aar
            build/outputs/jniLibs/**
          retention-days: 90
