name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

permissions:
  contents: write
  
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'
    
    - name: Set up Go 1.23
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'
    
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
    
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init
    
    - name: Patch for 16KB Page Size
      run: |
        # Patch Makefile for API 35
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]\+/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]\+/-androidapi=35/g' Makefile
        fi
        
        # Patch build.gradle files
        find . -name "build.gradle*" -type f -exec sed -i \
          -e 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' \
          -e 's/targetSdkVersion [0-9]\+/targetSdkVersion 35/g' \
          -e 's/compileSdk = [0-9]\+/compileSdk = 35/g' \
          -e 's/targetSdk = [0-9]\+/targetSdk = 35/g' {} \;
    
    - name: Build AAR
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export GO111MODULE=on
        
        # AndroidLibXrayLite uses Makefile
        if [ -f "Makefile" ]; then
          echo "Building with Makefile..."
          make lib || make android || make
        
        # Fallback to Gradle
        elif [ -f "build.gradle" ] || [ -f "gradlew" ]; then
          echo "Building with Gradle..."
          chmod +x gradlew 2>/dev/null || true
          ./gradlew assembleRelease || gradle assembleRelease
        
        # Last resort: direct gomobile
        else
          echo "Direct gomobile build..."
          go mod download
          gomobile bind -v \
            -target=android \
            -androidapi=35 \
            -ldflags="-s -w" \
            -o libxray.aar \
            -javapkg=io.github.androidlibxraylite \
            .
        fi
    
    - name: Find and verify AAR
      run: |
        echo "=== Searching for AAR files ==="
        find . -name "*.aar" -type f
        
        mkdir -p build/outputs
        find . -name "*.aar" -type f -exec cp {} build/outputs/ \;
        
        if ! ls build/outputs/*.aar 1> /dev/null 2>&1; then
          echo "❌ No AAR found!"
          exit 1
        fi
        
        echo "✅ AAR built successfully!"
        ls -lh build/outputs/
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: build/outputs/*.aar
        retention-days: 90
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: android15-v${{ github.run_number }}
        name: AndroidLibXrayLite (16KB Page Size)
        files: build/outputs/*.aar
        body: |
          ## AndroidLibXrayLite - Android 15+ Compatible (16KB Page Size)
          
          ✅ Xray Core + tun2socks
          ✅ 16KB page size support
          ✅ NDK r27, Go 1.23, API 35
          
          **Usage with external XRayCore:**
          ```kotlin
          Libv2ray.tunStart(tunFd, "127.0.0.1:10808")
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
