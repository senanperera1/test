name: Build AndroidLibXrayLite AAR (real runtime)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK and NDK r27
      uses: android-actions/setup-android@v3
      with:
        ndk: '27.0.12077973'
        api-level: 35

    - name: Install gomobile
      run: |
        unset GOFLAGS
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Prepare local forks (if using third_party)
      run: |
        # If you maintain forks, clone them here. Example:
        # git clone https://github.com/yourname/go-tun2socks.git third_party/go-tun2socks
        # git clone https://github.com/yourname/xray-core.git third_party/xray-core
        ls -la

    - name: Create go.mod with local replace
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.11
          github.com/xtls/xray-core v1.251208.0
          golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        )

        # Replace with your local clones or forks that contain go.mod
        replace github.com/eycorsican/go-tun2socks => ./third_party/go-tun2socks
        replace github.com/xtls/xray-core => ./third_party/xray-core
        EOF

        go mod tidy

    - name: Try building libv2ray (real runtime)
      run: |
        set -e
        # Build the package to see if upstream code compiles for Android target
        go build -v ./libv2ray || (echo "go build failed; native/cgo likely required. See logs." && exit 1)

    - name: Run gomobile bind (if go build succeeded)
      if: success()
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        gomobile init
        gomobile bind -v -target=android -androidapi=35 -o build/outputs/AndroidLibXrayLite.aar ./libv2ray

    - name: Upload artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite.aar
        path: build/outputs/AndroidLibXrayLite.aar
