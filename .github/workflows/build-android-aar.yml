name: Build Pure tun2socks AAR (xjasonlyu - No V2Ray)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: gomobile init
    
    - name: Create pure tun2socks wrapper (xjasonlyu)
      run: |
        mkdir -p pure-tun2socks
        cd pure-tun2socks
        
        # Initialize module
        go mod init github.com/pure-tun2socks/mobile
        
        # Add xjasonlyu/tun2socks (pure, actively maintained, no V2Ray)
        go get github.com/xjasonlyu/tun2socks/v2@latest
        
        # Create simple wrapper
        cat > tun2socks.go << 'EOF'
        package tun2socks

        import (
            "errors"
            "fmt"
            "os"
            
            "github.com/xjasonlyu/tun2socks/v2/core/device"
            "github.com/xjasonlyu/tun2socks/v2/core/device/tun"
            "github.com/xjasonlyu/tun2socks/v2/engine"
            "github.com/xjasonlyu/tun2socks/v2/proxy"
        )

        var (
            running    bool
            engineKey  *engine.Key
            tunDevice  device.Device
        )

        // Start starts pure SOCKS5 forwarding
        // tunFd: TUN device file descriptor
        // mtu: MTU size (typically 1500)
        // socksAddr: SOCKS5 proxy address (e.g., "127.0.0.1:10808")
        func Start(tunFd int64, mtu int64, socksAddr string) error {
            if running {
                return errors.New("already running")
            }

            // Open TUN device
            var err error
            tunDevice, err = tun.Open(int(tunFd), int(mtu))
            if err != nil {
                return fmt.Errorf("failed to open TUN: %v", err)
            }

            // Create SOCKS5 proxy adapter
            proxyURL := fmt.Sprintf("socks5://%s", socksAddr)
            proxyAdapter, err := proxy.ParseProxy(proxyURL)
            if err != nil {
                return fmt.Errorf("invalid SOCKS5 address: %v", err)
            }

            // Start engine
            engineKey = engine.Insert(tunDevice, proxyAdapter)
            if engineKey == nil {
                return errors.New("failed to start engine")
            }

            running = true
            return nil
        }

        // Stop stops forwarding
        func Stop() error {
            if !running {
                return errors.New("not running")
            }

            if engineKey != nil {
                engine.Remove(engineKey)
                engineKey = nil
            }
            
            if tunDevice != nil {
                tunDevice.Close()
                tunDevice = nil
            }

            running = false
            return nil
        }

        // IsRunning checks if forwarding is active
        func IsRunning() bool {
            return running
        }

        // GetVersion returns version info
        func GetVersion() string {
            return "pure-tun2socks-v2.5.2"
        }

        // SetLogLevel sets log level
        func SetLogLevel(level string) {
            os.Setenv("LOG_LEVEL", level)
        }
        EOF
        
        go mod tidy
    
    - name: Build AAR
      run: |
        cd pure-tun2socks
        gomobile bind -v -androidapi 21 -target=android/arm,android/arm64,android/amd64 -o tun2socks.aar -javapkg=io.puretun2socks .
    
    - name: Create usage doc
      run: |
        cat > USAGE.md << 'EOF'
        # Pure tun2socks - NO V2Ray/XRay Embedded

        Based on xjasonlyu/tun2socks (actively maintained, 2024)
        Pure SOCKS5 forwarder - NO Vmess bullshit!

        ## Usage in Android

        ```kotlin
        import io.puretun2socks.Tun2socks

        // In your VPN service
        val tunFd = vpnInterface.detachFd()

        // Start - just pass fd and SOCKS5 address!
        Tun2socks.start(
            tunFd.toLong(),
            1500L,                    // MTU
            "127.0.0.1:10808"        // Your XrayCore SOCKS5
        )

        // Stop
        Tun2socks.stop()

        // Check status
        val running = Tun2socks.isRunning()
        ```

        ## That's It!

        No Vmess objects, no JSON configs, just:
        - Read packets from TUN
        - Forward to SOCKS5
        - Your XrayCore handles everything else

        ## Flow

        ```
        TUN device â†’ tun2socks â†’ 127.0.0.1:10808 (Your XrayCore) â†’ Internet
        ```

        Pure and simple! ðŸš€
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pure-tun2socks-aar
        path: |
          pure-tun2socks/*.aar
          pure-tun2socks/*.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: pure-build-${{ github.run_number }}
        files: |
          pure-tun2socks/*.aar
          USAGE.md
        body: |
          ## Pure tun2socks AAR - NO V2Ray/XRay
          
          Based on xjasonlyu/tun2socks (2024, actively maintained)
          
          ### Simple API:
          ```kotlin
          Tun2socks.start(tunFd.toLong(), 1500L, "127.0.0.1:10808")
          ```
          
          No Vmess, no configs, just pure SOCKS5 forwarding!
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
