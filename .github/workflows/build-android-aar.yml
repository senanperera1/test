name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+ with tun2socks exports)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'

    - name: Set up Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV

    - name: Setup Gradle (new action)
      uses: gradle/actions/setup-gradle@v4

    - name: Install gomobile tools
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init

    - name: Patch for 16KB Page Size
      run: |
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]\+/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]\+/-androidapi=35/g' Makefile
        fi
        find . -name "build.gradle*" -type f -exec sed -i \
          -e 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' \
          -e 's/targetSdkVersion [0-9]\+/targetSdkVersion 35/g' \
          -e 's/compileSdk = [0-9]\+/compileSdk = 35/g' \
          -e 's/targetSdk = [0-9]\+/targetSdk = 35/g' {} \;

    - name: Root go.mod (normal module resolution)
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.11
          golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        )
        EOF

        go mod tidy

    - name: Add tun2socks exports (use socks handlers directly)
      run: |
        mkdir -p libv2ray
        cat > libv2ray/tun.go <<'EOF'
        package libv2ray

        import (
          "time"

          "github.com/eycorsican/go-tun2socks/core"
          "github.com/eycorsican/go-tun2socks/proxy/socks"
        )

        var tunRunning bool

        // TunStart wires handlers then starts the tun2socks core loop on fd.
        func TunStart(fd int, socksAddr string, port uint16) bool {
          if tunRunning {
            return true
          }
          tcp := socks.NewTCPHandler(socksAddr, port)
          udp := socks.NewUDPHandler(socksAddr, port, 30*time.Second)

          // Register handlers with core then start loop
          core.RegisterTCPHandler(tcp)
          core.RegisterUDPHandler(udp)

          go core.Start(fd)
          tunRunning = true
          return true
        }

        // TunStop stops the tun2socks core loop.
        func TunStop() {
          if tunRunning {
            core.Stop()
            tunRunning = false
          }
        }
        EOF

    - name: Build AAR (normal module resolution so gobind finds x/mobile/bind)
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export GO111MODULE=on

        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -ldflags="-s - w" \
          -o build/outputs/AndroidLibXrayLite.aar \
          -javapkg=io.github.androidlibxraylite \
          ./libv2ray

    - name: Verify and upload artifacts
      run: |
        ls -lh build/outputs/*.aar || (echo "âŒ No AAR built"; exit 1)

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: build/outputs/*.aar
        retention-days: 90
