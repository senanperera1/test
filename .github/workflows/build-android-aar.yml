name: Build tun2socks AAR (Minimal - No V2Ray/XRay)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout base tun2socks
      uses: actions/checkout@v4
      with:
        repository: 'xjasonlyu/tun2socks'
        ref: 'main'
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620" "platforms;android-33"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        gomobile init
    
    - name: Create minimal binding
      run: |
        mkdir -p mobile
        cat > mobile/tun2socks.go << 'GOEOF'
        package mobile

        import (
            "context"
            "io"
            "net"
            "os"
            "time"
            
            "github.com/xjasonlyu/tun2socks/v2/core"
            "github.com/xjasonlyu/tun2socks/v2/proxy/socks5"
        )

        type VpnService interface {
            Protect(fd int) bool
        }

        type PacketFlow interface {
            WritePacket(packet []byte) (int, error)
        }

        type Tun2socks struct {
            tunFd      int
            proxyURL   string
            ctx        context.Context
            cancel     context.CancelFunc
            vpnService VpnService
        }

        func NewTun2socks(tunFd int, mtu int, proxyURL string, vpnService VpnService) (*Tun2socks, error) {
            ctx, cancel := context.WithCancel(context.Background())
            
            t := &Tun2socks{
                tunFd:      tunFd,
                proxyURL:   proxyURL,
                ctx:        ctx,
                cancel:     cancel,
                vpnService: vpnService,
            }
            
            return t, nil
        }

        func (t *Tun2socks) Start() error {
            // Open TUN device
            tunFile := os.NewFile(uintptr(t.tunFd), "tun")
            
            // Setup core device
            device := core.NewDevice(tunFile, t.mtu)
            
            // Start the stack
            go func() {
                device.Start()
            }()
            
            return nil
        }

        func (t *Tun2socks) Stop() {
            if t.cancel != nil {
                t.cancel()
            }
        }

        // Simple SOCKS5 start function
        func StartSocks5(tunFd int, mtu int, socksAddr string, vpnService VpnService) error {
            t, err := NewTun2socks(tunFd, mtu, "socks5://"+socksAddr, vpnService)
            if err != nil {
                return err
            }
            return t.Start()
        }
        GOEOF
    
    - name: Create go.mod for mobile binding
      run: |
        cat > mobile/go.mod << 'GOEOF'
        module tun2socks/mobile

        go 1.21

        require (
            github.com/xjasonlyu/tun2socks/v2 v2.5.2
        )
        GOEOF
    
    - name: Download dependencies
      run: |
        cd mobile
        go mod tidy
        go get -d ./...
    
    - name: Build AAR (SOCKS5 only)
      run: |
        cd mobile
        gomobile bind -v -androidapi 21 -javapkg=io.github.tun2socks -o tun2socks.aar .
    
    - name: List build outputs
      run: |
        echo "=== Build directory contents ==="
        find . -name "*.aar" -o -name "*.jar"
        ls -lah mobile/*.aar 2>/dev/null || echo "No AAR found"
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR (Minimal - SOCKS5 Only)

        Pure tun2socks implementation without V2Ray/XRay - no qtls errors!

        ## Integration

        1. Add to your Android project:
           ```gradle
           dependencies {
               implementation files('libs/tun2socks.aar')
           }
           ```

        ## Usage (Kotlin)

        ```kotlin
        import io.github.tun2socks.Mobile

        class MyVpnService : VpnService() {
            
            private val vpnService = object : Mobile.VpnService {
                override fun protect(fd: Long): Boolean {
                    return this@MyVpnService.protect(fd.toInt())
                }
            }
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                // Setup VPN interface
                val builder = Builder()
                    .setMtu(1500)
                    .addAddress("10.0.0.2", 24)
                    .addRoute("0.0.0.0", 0)
                    .addDnsServer("8.8.8.8")
                    .setSession("Tun2socks VPN")
                
                val vpnInterface = builder.establish() ?: return START_NOT_STICKY
                val tunFd = vpnInterface.detachFd()
                
                try {
                    // Connect to SOCKS5 proxy (e.g., from your XRayCore)
                    Mobile.startSocks5(
                        tunFd.toLong(),
                        1500, // MTU
                        "127.0.0.1:10808", // Your SOCKS5 server
                        vpnService
                    )
                    
                    Log.i("VPN", "tun2socks started successfully")
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to start", e)
                }
                
                return START_STICKY
            }
            
            override fun onDestroy() {
                // Cleanup handled automatically
                super.onDestroy()
            }
        }
        ```

        ## Features

        - âœ… Pure tun2socks (no V2Ray/XRay bloat)
        - âœ… SOCKS5 proxy support
        - âœ… No qtls errors
        - âœ… Lightweight and stable
        - âœ… Works with any SOCKS5 proxy

        ## Use with XRayCore

        1. Run XRayCore separately with SOCKS5 inbound:
           ```json
           {
             "inbounds": [{
               "port": 10808,
               "protocol": "socks",
               "listen": "127.0.0.1"
             }]
           }
           ```

        2. Point tun2socks to `127.0.0.1:10808`
        3. Done! No runtime errors.

        ## Notes

        - This is a minimal build - only SOCKS5 support
        - No V2Ray/XRay cores embedded
        - Use with external proxy server
        - Much smaller APK size
        EOF
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-minimal
        path: |
          mobile/*.aar
          mobile/*-sources.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: minimal-build-${{ github.run_number }}
        files: |
          mobile/*.aar
          USAGE.md
        body: |
          ## tun2socks AAR (Minimal Build)
          
          Pure tun2socks without V2Ray/XRay cores.
          
          ### Features:
          - SOCKS5 proxy support only
          - No qtls errors
          - Lightweight build
          - Works with external proxy servers
          
          ### Quick Start:
          See USAGE.md for integration guide.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show success message
      run: |
        echo "âœ… BUILD SUCCESSFUL!"
        echo ""
        echo "Minimal tun2socks.aar built without V2Ray/XRay!"
        echo ""
        echo "ðŸ“¦ Download from 'Artifacts' section"
        echo ""
        find mobile -name "*.aar" -exec ls -lh {} \;
