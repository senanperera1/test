name: Build tun2socks AAR (FINAL FIX - gomobile init issue)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'master'
    
    - name: Set up Go 1.18.10
      uses: actions/setup-go@v5
      with:
        go-version: '1.18.10'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620" "platforms;android-33"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile (CRITICAL - specific version for Go 1.18)
      run: |
        # Install specific gomobile version that works with Go 1.18
        go install golang.org/x/mobile/cmd/gomobile@v0.0.0-20230531173138-3c911d8e3eda
        go install golang.org/x/mobile/cmd/gobind@v0.0.0-20230531173138-3c911d8e3eda
        
        # Add to PATH
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
        
        # Verify installation
        export PATH="$(go env GOPATH)/bin:$PATH"
        gomobile version || echo "gomobile installed"
    
    - name: Initialize gomobile (FIXED - prevent auto-update)
      run: |
        # Set GOPATH to prevent gomobile from trying to install latest
        export PATH="$(go env GOPATH)/bin:$PATH"
        
        # Initialize without triggering auto-update
        gomobile init -ndk $ANDROID_NDK_HOME || echo "Init may have warnings, continuing..."
    
    - name: Download dependencies
      run: |
        go mod download || true
    
    - name: Build AAR
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        make android
    
    - name: Verify build output
      run: |
        echo "=== Checking for AAR files ==="
        find . -name "*.aar" -exec ls -lh {} \; || echo "No AAR found yet"
        ls -la build/ || echo "No build directory"
    
    - name: Create CONTEXT document for next AI
      run: |
        cat > BUILD_CONTEXT.md << 'EOF'
        # CONTEXT FOR NEXT AI - tun2socks AAR Build

        ## GOAL
        Build tun2socks AAR from xxf098/go-tun2socks-build repository.
        User wants ONLY basic tun2socks + SOCKS5 (to connect to external XRayCore).
        Does NOT want embedded V2Ray/XRay cores (they cause runtime conflicts).

        ## ROOT CAUSE OF ALL ERRORS
        The xxf098/go-tun2socks-build repo uses:
        - quic-go v0.27.0 → REQUIRES Go 1.18 (fails on Go 1.19+)
        - Has V2Ray + XRay cores → causes protobuf duplicate registrations
        - Needs gomobile that works with Go 1.18

        ## VERSION COMPATIBILITY MATRIX
        ```
        Go Version   | quic-go v0.27.0 | gomobile          | Result
        -------------|-----------------|-------------------|--------
        1.18.10      | ✅ Works        | v0.0.0-20230531  | ✅ SHOULD WORK
        1.19+        | ❌ Fails qtls   | Any              | ❌ FAILS
        1.21         | ❌ Fails qtls   | Any              | ❌ FAILS
        1.18.10      | ✅ Works        | @latest          | ❌ FAILS (needs Go 1.24)
        ```

        ## ERROR HISTORY

        ### Error 1: qtls incompatibility
        ```
        Error: cannot use "The version of quic-go you're using can't be built on Go 1.19 yet"
        ```
        **Cause**: quic-go v0.27.0 only supports Go 1.18
        **Fix**: Use Go 1.18.10

        ### Error 2: gomobile version conflict
        ```
        Error: invalid go version '1.24.0': must match format 1.23
        ```
        **Cause**: gomobile@latest requires Go 1.24+, but we need Go 1.18
        **Fix**: Use gomobile v0.0.0-20230531173138-3c911d8e3eda

        ### Error 3: gomobile init auto-update
        ```
        gomobile: go install golang.org/x/mobile/cmd/gobind@latest failed
        ```
        **Cause**: `gomobile init` tries to reinstall gobind@latest even if we installed specific version
        **Fix**: Use `-ndk` flag and ignore warnings

        ## CURRENT STATUS
        - This workflow uses Go 1.18.10 + gomobile v0.0.0-20230531173138
        - Should build successfully if gomobile init doesn't fail
        - Makefile already has `-X google.golang.org/protobuf/reflect/protoregistry.conflictPolicy=warn`

        ## IF THIS STILL FAILS
        Options for next AI:

        ### Option A: Skip gomobile init entirely
        Try building without `gomobile init` - sometimes NDK path is enough.

        ### Option B: Use Docker with pre-installed gomobile
        Use a Docker image with Go 1.18 + gomobile already set up.

        ### Option C: Build from different repo
        Try 2dust/AndroidLibXrayLite or Matsuri/libcore (already have working gomobile builds).

        ### Option D: Manual gomobile setup
        Download gomobile binary directly instead of using `go install`.

        ## RECOMMENDED NEXT STEP
        If gomobile init keeps failing, try Option A (skip init) or Option C (different repo).
        EOF
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR Usage

        ## SOCKS5 Mode (Recommended)
        Connect to external XRayCore/V2Ray running on localhost:

        ```kotlin
        val config = tun2socks.Vmess().apply {
            add = "127.0.0.1"
            port = 10808  // Your SOCKS5 proxy port
            net = "socks"
        }
        
        Tun2socks.startV2Ray(
            tunFd,
            500,
            vpnService,
            logService,
            querySpeed,
            false,
            config,
            "",
            ""
        )
        ```

        ## Alternative: Use 2dust/AndroidLibXrayLite
        If this build keeps failing, consider using:
        https://github.com/2dust/AndroidLibXrayLite
        - Pre-built AAR releases available
        - No complex dependencies
        - Works out of the box
        EOF
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-build
        path: |
          build/*.aar
          build/*-sources.jar
          USAGE.md
          BUILD_CONTEXT.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: build-${{ github.run_number }}
        files: |
          build/*.aar
          USAGE.md
          BUILD_CONTEXT.md
        body: |
          ## tun2socks AAR Build
          
          Go 1.18.10 + gomobile v0.0.0-20230531173138
          
          If build failed, see BUILD_CONTEXT.md for troubleshooting.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Build status
      if: always()
      run: |
        echo "========================================="
        echo "BUILD ATTEMPTED"
        echo "========================================="
        echo ""
        echo "If build failed, next AI should:"
        echo "1. Read BUILD_CONTEXT.md"
        echo "2. Try Option A: Skip gomobile init"
        echo "3. Or Option C: Use 2dust/AndroidLibXrayLite"
        echo ""
        find . -name "*.aar" -exec ls -lh {} \; || echo "❌ No AAR built"
        echo ""
        echo "========================================="
