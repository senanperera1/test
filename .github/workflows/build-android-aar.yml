name: Build LondonX tun2socks AAR (stable)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      UPSTREAM_REPO: LondonX/tun2socks-android
      UPSTREAM_BRANCH: main
      UPSTREAM_DIR: upstream-tun2socks
      ANDROID_API: 33
      ANDROID_NDK_VERSION: 27.0.12077973

    steps:
      - name: Checkout this repository (workflow files)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Checkout upstream repo (LondonX/tun2socks-android)
        uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ env.UPSTREAM_BRANCH }}
          path: ${{ env.UPSTREAM_DIR }}
          fetch-depth: 1

      - name: Show upstream layout (diagnostic)
        run: |
          echo "=== upstream dir: ${{ env.UPSTREAM_DIR }} ==="
          ls -la "${{ env.UPSTREAM_DIR }}" || true
          find "${{ env.UPSTREAM_DIR }}" -maxdepth 3 -type f \( -name gradlew -o -name settings.gradle -o -name build.gradle \) -print || true

      - name: Set up Java 17 (required for sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Export Android SDK root
        run: |
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "PATH=$PATH:/usr/local/lib/android/sdk/cmdline-tools/latest/bin" >> $GITHUB_ENV

      - name: Install Android SDK packages (cmdline-tools, platform, build-tools, ndk)
        uses: android-actions/setup-android@v3
        with:
          packages: |
            cmdline-tools;latest
            platform-tools
            platforms;android-${{ env.ANDROID_API }}
            build-tools;33.0.2
            ndk;${{ env.ANDROID_NDK_VERSION }}

      - name: Accept Android SDK licenses (noninteractive)
        run: |
          # ensure sdkmanager is available and accept all licenses non-interactively
          yes | sdkmanager --licenses || true

      - name: Make upstream gradlew executable
        run: |
          GW=$(find "${{ env.UPSTREAM_DIR }}" -maxdepth 2 -type f -name gradlew | head -n 1 || true)
          if [ -z "$GW" ]; then
            echo "gradlew not found in upstream repo; aborting"
            exit 1
          fi
          chmod +x "$GW"
          echo "Found gradlew: $GW"
          echo "GRADLE_WRAPPER_DIR=$(dirname "$GW")" >> $GITHUB_ENV

      - name: Show Java and Gradle wrapper info
        run: |
          java -version || true
          echo "Using gradle wrapper dir: $GRADLE_WRAPPER_DIR"
          "$GRADLE_WRAPPER_DIR/gradlew" --version || true

      - name: Build :tun2socks:assembleRelease (wrapper, verbose)
        run: |
          set -euo pipefail
          export GRADLE_USER_HOME="$RUNNER_TEMP/gradle-cache"
          mkdir -p "$GRADLE_USER_HOME"
          echo "GRADLE_USER_HOME=$GRADLE_USER_HOME"

          pushd "$GRADLE_WRAPPER_DIR"
          # show full wrapper distribution and run with verbose flags
          ./gradlew --version
          ./gradlew clean --no-daemon --warning-mode all --stacktrace || true
          ./gradlew :tun2socks:assembleRelease --no-daemon --warning-mode all --stacktrace --info || {
            echo "Gradle build failed. Collecting debug info..."
            echo "=== Last 200 lines of gradle daemon logs (if any) ==="
            ls -la ~/.gradle/daemon || true
            tail -n 200 ~/.gradle/daemon/*/daemon-*.log || true
            echo "=== tun2socks/build.gradle ==="
            sed -n '1,240p' "${{ env.UPSTREAM_DIR }}/tun2socks/build.gradle" || true
            echo "=== project build.gradle ==="
            sed -n '1,240p' "${{ env.UPSTREAM_DIR }}/build.gradle" || true
            popd
            exit 1
          }
          popd
          echo "Gradle build finished (success)."

      - name: Collect AARs and native libs
        run: |
          mkdir -p build/outputs
          find "${{ env.UPSTREAM_DIR }}" -type f -name "*.aar" -exec cp {} build/outputs/ \; || true

          STRIPPED_DIR="${{ env.UPSTREAM_DIR }}/tun2socks/build/intermediates/stripped_native_libs/release/out/lib"
          if [ -d "$STRIPPED_DIR" ]; then
            mkdir -p build/outputs/jniLibs
            cp -r "$STRIPPED_DIR"/* build/outputs/jniLibs/ || true
          else
            echo "No stripped native libs found at $STRIPPED_DIR (path may differ)"
          fi

          echo "=== build/outputs contents ==="
          ls -la build/outputs || true
          if [ -d build/outputs/jniLibs ]; then
            echo "=== jniLibs contents ==="
            find build/outputs/jniLibs -maxdepth 3 -type f -print || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: londonx-tun2socks-artifacts
          path: |
            build/outputs/*.aar
            build/outputs/jniLibs/**
          retention-days: 90

      - name: Failure debug (only on failure)
        if: failure()
        run: |
          echo "=== Upstream dir listing ==="
          ls -la "${{ env.UPSTREAM_DIR }}" || true
          echo "=== Find build.gradle files ==="
          find "${{ env.UPSTREAM_DIR }}" -maxdepth 4 -type f -name 'build.gradle*' -print || true
          if [ -f "${{ env.UPSTREAM_DIR }}/tun2socks/build.gradle" ]; then
            echo "=== tun2socks/build.gradle (head) ==="
            sed -n '1,200p' "${{ env.UPSTREAM_DIR }}/tun2socks/build.gradle" || true
          fi
