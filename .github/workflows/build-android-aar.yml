name: Build Final tun2socks AAR

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Android SDK + NDK r26c
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          gomobile init

      - name: Create wrapper and build AAR
        run: |
          set -e
          mkdir -p workspace/wrapper
          cd workspace

          # Clone tun2socks source
          git clone https://github.com/xjasonlyu/tun2socks.git library_src

          # Create wrapper module
          cd wrapper
          go mod init github.com/myuser/tun2socks
          go mod edit -replace=github.com/xjasonlyu/tun2socks/v2=../library_src

          # Wrapper exposing Start/Stop for gomobile
          cat <<'EOF' > tun2socks.go
          package tun2socks

          import (
              "context"
              "fmt"
              "log"

              "github.com/xjasonlyu/tun2socks/v2/core"
              "github.com/xjasonlyu/tun2socks/v2/proxy"
              "github.com/xjasonlyu/tun2socks/v2/tun"
              _ "golang.org/x/mobile/bind"
          )

          var (
              ctx    context.Context
              cancel context.CancelFunc
          )

          // Start runs the tun2socks loop; fd is the TUN file descriptor, proxyURL like "socks5://127.0.0.1:10808".
          func Start(fd int, proxyURL string) error {
              ctx, cancel = context.WithCancel(context.Background())

              const mtu = 1500
              dev, err := tun.Open(fmt.Sprintf("fd://%d", fd), mtu)
              if err != nil {
                  return fmt.Errorf("open tun: %w", err)
              }

              handler, err := proxy.New(proxyURL)
              if err != nil {
                  return fmt.Errorf("proxy: %w", err)
              }

              lwip := core.NewLWIPStack()

              core.RegisterTCPConnHandler(handler)
              core.RegisterUDPConnHandler(handler)
              core.RegisterOutputFn(func(data []byte, writeCount int) {
                  dev.Write(data[:writeCount])
              })

              log.Println("tun2socks starting")
              go lwip.Start()

              buf := make([]byte, mtu)
              for {
                  select {
                  case <-ctx.Done():
                      return nil
                  default:
                      n, err := dev.Read(buf)
                      if err != nil {
                          return err
                      }
                      lwip.Write(buf[:n])
                  }
              }
          }

          // Stop signals the loop to exit.
          func Stop() {
              if cancel != nil {
                  cancel()
              }
              log.Println("tun2socks stopping")
          }
          EOF

          # Dependencies
          go get golang.org/x/mobile/bind
          go get github.com/xjasonlyu/tun2socks/v2
          go mod tidy

          # Build AAR in workspace root
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../libtun2socks.aar .
          ls -lh ../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: workspace/libtun2socks.aar
