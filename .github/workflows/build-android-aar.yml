name: Build Final tun2socks.aar
on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Install NDK
        run: sdkmanager "ndk;26.1.10909125"

      - name: Clone xjasonlyu/tun2socks repository
        uses: actions/checkout@v4
        with:
          repository: xjasonlyu/tun2socks
          path: tun2socks_source

      - name: Build the .so file from source
        run: |
          set -e
          cd tun2socks_source

          # Configure environment for Go C-shared build
          export CGO_ENABLED=1
          export GOOS=android
          export GOARCH=arm64
          export ANDROID_API=21
          export NDK_LLVM_BIN="$ANDROID_HOME/ndk/26.1.10909125/toolchains/llvm/prebuilt/linux-x86_64/bin"
          export CC="$NDK_LLVM_BIN/clang"
          export CXX="$NDK_LLVM_BIN/clang++"
          export CGO_CFLAGS="--target=aarch64-linux-android${ANDROID_API}"
          export CGO_LDFLAGS="--target=aarch64-linux-android${ANDROID_API}"

          # Build the shared library
          go build -v -trimpath -buildmode=c-shared -o ../libtun2socks.so .
          echo "Successfully built libtun2socks.so"

      - name: Create Android Library Project Structure
        run: |
          mkdir -p android_library/src/main/java/com/example/tun2socks
          mkdir -p android_library/src/main/jniLibs/arm64-v8a

      - name: Copy .so and Create Java Wrapper
        run: |
          cp libtun2socks.so android_library/src/main/jniLibs/arm64-v8a/

          cat <<'EOF' > android_library/src/main/java/com/example/tun2socks/Tun2Socks.java
          package com.example.tun2socks;

          public class Tun2Socks {
              static {
                  System.loadLibrary("tun2socks");
              }
              // These functions must match the exported Go functions
              public static native int start(int fd, String proxyUrl);
              public static native int stop();
          }
          EOF

      - name: Create Gradle build files for the library
        run: |
          # Library's build.gradle
          cat <<'EOF' > android_library/build.gradle
          plugins {
              id 'com.android.library'
          }
          android {
              namespace "com.example.tun2socks"
              compileSdk 34
              defaultConfig {
                  minSdk 21
              }
          }
          EOF
          
          # Root settings.gradle
          # THE FIX IS HERE: We create a full Gradle project context
          cat <<'EOF' > settings.gradle
          pluginManagement {
              repositories {
                  google()
                  mavenCentral()
                  gradlePluginPortal()
              }
          }
          rootProject.name = "tun2socks-builder"
          include ':android_library'
          EOF
          
          # Root build.gradle
          cat <<'EOF' > build.gradle
          buildscript {
              repositories {
                  google()
                  mavenCentral()
              }
              dependencies {
                  // This provides the 'com.android.library' plugin
                  classpath 'com.android.tools.build:gradle:8.2.0'
              }
          }
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }
          EOF

      - name: Assemble the AAR with Gradle
        run: |
          # Copy the library project into the root project directory
          cp -r android_library .
          
          # We need to grant execute permissions to the gradlew script
          gradle wrapper --gradle-version 8.2
          chmod +x ./gradlew
          
          # Run the build
          ./gradlew :android_library:assembleRelease

      - name: Upload the final AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-aar
          path: android_library/build/outputs/aar/android_library-release.aar
