name: Build tun2sock AAR

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v2

    - name: Install Android NDK
      run: |
        sdkmanager --install "ndk;25.2.9519653"
        echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV

    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        export PATH=$PATH:$(go env GOPATH)/bin
        gomobile init -ndk $ANDROID_NDK_HOME

    - name: Clone tun2socks
      run: |
        git clone https://github.com/xjasonlyu/tun2socks.git
        cd tun2socks

    - name: Create Go wrapper
      run: |
        cd tun2socks
        mkdir -p mobile
        cat > mobile/mobile.go << 'EOF'
        package mobile

        import (
            "context"
            "fmt"
            "io"
            "net"
            "time"

            "github.com/xjasonlyu/tun2socks/v2/core"
            "github.com/xjasonlyu/tun2socks/v2/core/device"
            "github.com/xjasonlyu/tun2socks/v2/core/device/tun"
            "github.com/xjasonlyu/tun2socks/v2/proxy"
        )

        type Tun2socks struct {
            cancel context.CancelFunc
            dev    device.Device
        }

        // Start initializes and starts tun2socks
        // tunFd: file descriptor of the TUN interface
        // proxyUrl: SOCKS5 proxy URL (e.g., "socks5://127.0.0.1:10808")
        // mtu: MTU size (typically 1500)
        func Start(tunFd int, proxyUrl string, mtu int) (*Tun2socks, error) {
            if tunFd < 0 {
                return nil, fmt.Errorf("invalid TUN file descriptor")
            }

            if mtu <= 0 {
                mtu = 1500
            }

            // Create TUN device from file descriptor
            tunDev, err := tun.Open(tunFd, uint32(mtu))
            if err != nil {
                return nil, fmt.Errorf("failed to open TUN device: %w", err)
            }

            // Parse and create proxy
            proxyHandler, err := proxy.NewProxy(proxyUrl)
            if err != nil {
                tunDev.Close()
                return nil, fmt.Errorf("failed to create proxy: %w", err)
            }

            // Set up the stack
            ctx, cancel := context.WithCancel(context.Background())
            
            // Create new stack
            err = core.SetDevice(tunDev)
            if err != nil {
                cancel()
                tunDev.Close()
                return nil, fmt.Errorf("failed to set device: %w", err)
            }

            core.SetProxy(proxyHandler)

            // Start forwarding
            go func() {
                <-ctx.Done()
            }()

            return &Tun2socks{
                cancel: cancel,
                dev:    tunDev,
            }, nil
        }

        // Stop stops tun2socks and cleans up resources
        func (t *Tun2socks) Stop() error {
            if t.cancel != nil {
                t.cancel()
            }
            
            if t.dev != nil {
                return t.dev.Close()
            }
            
            return nil
        }

        // WriteToTun writes data to the TUN interface
        func (t *Tun2socks) WriteToTun(data []byte) (int, error) {
            if t.dev == nil {
                return 0, fmt.Errorf("device not initialized")
            }
            return t.dev.Write(data)
        }

        // ReadFromTun reads data from the TUN interface
        func (t *Tun2socks) ReadFromTun(buf []byte) (int, error) {
            if t.dev == nil {
                return 0, fmt.Errorf("device not initialized")
            }
            return t.dev.Read(buf)
        }

        // SetProxy updates the proxy configuration
        func SetProxyURL(proxyUrl string) error {
            proxyHandler, err := proxy.NewProxy(proxyUrl)
            if err != nil {
                return fmt.Errorf("failed to create proxy: %w", err)
            }
            core.SetProxy(proxyHandler)
            return nil
        }
        EOF

    - name: Modify go.mod to disable QUIC
      run: |
        cd tun2socks
        # Add build tags to disable QUIC
        echo "Building with QUIC disabled"

    - name: Build AAR with QUIC disabled
      run: |
        cd tun2socks
        export CGO_ENABLED=1
        export GO111MODULE=on
        export PATH=$PATH:$(go env GOPATH)/bin
        
        # Build with tags to disable QUIC
        gomobile bind -v \
          -tags='disable_quic,noquic' \
          -ldflags='-s -w' \
          -target=android \
          -androidapi=21 \
          -o tun2socks.aar \
          ./mobile

    - name: Verify AAR
      run: |
        cd tun2socks
        ls -lh tun2socks.aar
        unzip -l tun2socks.aar

    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar
        path: tun2socks/tun2socks.aar
        retention-days: 30

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: tun2socks/tun2socks.aar
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
