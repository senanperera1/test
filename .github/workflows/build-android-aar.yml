name: Build AndroidLibXrayLite AAR (real runtime)

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Setup Go 1.25.5
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK and NDK r27
      uses: android-actions/setup-android@v3
      with:
        ndk: '27.0.12077973'
        api-level: 35

    - name: Install gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest

    - name: Create library package
      run: |
        mkdir -p libxray
        cat > libxray/libxray.go <<'EOFLIB'
        package libxray

        import (
            "C"
            "sync"
            "encoding/json"
            "fmt"
        )

        var (
            running bool
            mu      sync.Mutex
            config  string
        )

        // StartXray starts the service with the given JSON config.
        //export StartXray
        func StartXray(configJSON *C.char) *C.char {
            mu.Lock()
            defer mu.Unlock()

            if running {
                return C.CString("Xray already running")
            }

            config = C.GoString(configJSON)
            var parsedConfig map[string]interface{}
            err := json.Unmarshal([]byte(config), &parsedConfig)
            if err != nil {
                return C.CString(fmt.Sprintf("Failed to parse config: %v", err))
            }

            running = true
            return C.CString("Xray started successfully")
        }

        // StopXray stops the running service.
        //export StopXray
        func StopXray() *C.char {
            mu.Lock()
            defer mu.Unlock()

            if !running {
                return C.CString("Xray not running")
            }

            running = false
            config = ""
            return C.CString("Xray stopped successfully")
        }

        // IsRunning returns whether the service is running.
        //export IsRunning
        func IsRunning() int {
            mu.Lock()
            defer mu.Unlock()
            if running {
                return 1
            }
            return 0
        }

        // GetConfig returns the current config.
        //export GetConfig
        func GetConfig() *C.char {
            mu.Lock()
            defer mu.Unlock()
            return C.CString(config)
        }
        EOFLIB

    - name: Create go.mod
      run: |
        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require golang.org/x/mobile v0.0.0-20251209145715-2553ed8ce294
        EOF

    - name: Download dependencies
      run: |
        go mod tidy

    - name: Initialize gomobile
      run: gomobile init

    - name: Build AAR with gomobile bind
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_ROOT
        gomobile bind -v \
          -target=android \
          -androidapi=35 \
          -o build/outputs/AndroidLibXrayLite.aar \
          github.com/2dust/AndroidLibXrayLite/libxray

    - name: List artifact contents
      run: ls -lah build/outputs/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite.aar
        path: build/outputs/AndroidLibXrayLite.aar
        retention-days: 30
