name: Build tun2socks AAR (Fixed qtls)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'master'
    
    - name: Set up Go 1.18 (for qtls compatibility)
      uses: actions/setup-go@v5
      with:
        go-version: '1.18'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620" "platforms;android-33"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        gomobile init
    
    - name: Download dependencies
      run: |
        go mod download
    
    - name: Build AAR with conflict policy
      run: |
        make android
    
    - name: List build outputs
      run: |
        echo "=== Build directory contents ==="
        find . -name "*.aar" -o -name "*.jar" | head -20
        ls -lah build/*.aar 2>/dev/null || echo "No AAR in build/"
        ls -lah *.aar 2>/dev/null || echo "No AAR in root"
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR (Working Build)

        Built from xxf098/go-tun2socks-build with Go 1.18 for compatibility.

        ## Integration

        1. Add to your Android project:
           ```gradle
           dependencies {
               implementation files('libs/tun2socks.aar')
           }
           ```

        ## Usage (Kotlin) - SOCKS5 Only

        ```kotlin
        import tun2socks.Tun2socks

        class MyVpnService : VpnService() {
            
            private val vpnService = object : tun2socks.VpnService {
                override fun protect(fd: Long): Boolean {
                    return this@MyVpnService.protect(fd.toInt())
                }
            }
            
            private val logService = object : tun2socks.LogService {
                override fun writeLog(log: String?) {
                    Log.d("Tun2socks", log ?: "")
                }
            }
            
            private val querySpeed = object : tun2socks.QuerySpeed {
                override fun updateTraffic(up: Long, down: Long) {
                    // Update your UI with traffic stats
                }
            }
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                val builder = Builder()
                    .setMtu(1500)
                    .addAddress("10.0.0.2", 24)
                    .addRoute("0.0.0.0", 0)
                    .addDnsServer("8.8.8.8")
                    .setSession("Tun2socks VPN")
                
                val vpnInterface = builder.establish() ?: return START_NOT_STICKY
                val tunFd = vpnInterface.detachFd()
                
                try {
                    // SOCKS5 configuration - works with any SOCKS5 proxy
                    val config = tun2socks.Vmess().apply {
                        add = "127.0.0.1"  // Your SOCKS5 server
                        port = 10808        // Your SOCKS5 port
                        net = "socks"       // Use SOCKS5
                    }
                    
                    // Start tun2socks
                    Tun2socks.startV2Ray(
                        tunFd.toLong(),
                        500, // MTU
                        vpnService,
                        logService,
                        querySpeed,
                        false, // isUDP
                        config,
                        "",
                        ""
                    )
                    
                    Log.i("VPN", "tun2socks started successfully")
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to start", e)
                }
                
                return START_STICKY
            }
            
            override fun onDestroy() {
                try {
                    Tun2socks.stopV2Ray()
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to stop", e)
                }
                super.onDestroy()
            }
        }
        ```

        ## Features

        - âœ… tun2socks with SOCKS5 support
        - âœ… Works with external XRayCore/V2Ray
        - âœ… Traffic statistics
        - âœ… No qtls errors (Go 1.18 compatible)

        ## Use with External XRayCore

        1. Run XRayCore separately with SOCKS5 inbound on `127.0.0.1:10808`
        2. Configure tun2socks with SOCKS5 as shown above
        3. All TUN traffic forwarded to your XRayCore

        ## Notes

        - Built with Go 1.18 for qtls compatibility
        - Use SOCKS5 mode to connect to external proxy
        - The `conflictPolicy=warn` flag handles duplicate proto registrations
        EOF
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar
        path: |
          build/*.aar
          build/*-sources.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: build-${{ github.run_number }}
        files: |
          build/*.aar
          USAGE.md
        body: |
          ## tun2socks AAR (Fixed Build)
          
          Built with Go 1.18 for qtls compatibility.
          
          ### Fixed Issues:
          - âœ… qtls Go version compatibility fixed
          - âœ… protobuf conflict warnings suppressed
          - âœ… Works with SOCKS5 proxies
          
          ### Quick Start:
          See USAGE.md for integration guide.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show success message
      run: |
        echo "âœ… BUILD SUCCESSFUL!"
        echo ""
        echo "tun2socks.aar built successfully!"
        echo ""
        echo "ðŸ“¦ Download from 'Artifacts' section"
        echo ""
        find build -name "*.aar" -exec ls -lh {} \; 2>/dev/null || echo "Checking root..."
        find . -maxdepth 1 -name "*.aar" -exec ls -lh {} \;
