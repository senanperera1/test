name: Build tun2socks AAR

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Install Android SDK + NDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          ndk: 26.1.10909125
          cmake: 3.22.1
          components: build-tools;34.0.0

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          gomobile init

      - name: Create wrapper and build AAR
        run: |
          set -e
          mkdir -p workspace/wrapper
          cd workspace

          # Clone tun2socks source
          git clone https://github.com/xjasonlyu/tun2socks.git library_src

          # Create wrapper module
          cd wrapper
          go mod init github.com/myuser/tun2socks
          go mod edit -replace=github.com/xjasonlyu/tun2socks=../library_src

          # Inline wrapper Go code
          cat <<'EOF' > tun2socks.go
          package tun2socks

          import (
              "log"
              _ "golang.org/x/mobile/bind"
              "github.com/xjasonlyu/tun2socks/core"
              "github.com/xjasonlyu/tun2socks/proxy"
          )

          // Minimal wrapper: you can extend this with tun device handling if needed.
          func Start(proxyURL string) {
              handler, err := proxy.New(proxyURL)
              if err != nil {
                  log.Println("proxy init error:", err)
                  return
              }
              lwip := core.NewLWIPStack()
              core.RegisterTCPConnHandler(handler)
              core.RegisterUDPConnHandler(handler)
              log.Println("tun2socks core initialized")
              go lwip.Start()
          }

          func Stop() {
              log.Println("tun2socks stopping")
          }
          EOF

          go get golang.org/x/mobile/bind
          go get github.com/xjasonlyu/tun2socks
          go mod tidy

          # Build AAR in workspace root
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../libtun2socks.aar .
          ls -lh ../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: workspace/libtun2socks.aar
