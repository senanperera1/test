name: Build AndroidLibXrayLite AAR (16KB Page Size - Android 15+ with tun2socks exports)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      GOFLAGS: -mod=vendor
      GOPROXY: direct
      GOSUMDB: off

    steps:
    - name: Checkout AndroidLibXrayLite
      uses: actions/checkout@v4
      with:
        repository: '2dust/AndroidLibXrayLite'
        ref: 'main'
        submodules: 'recursive'

    - name: Set up Go 1.25.5 (xray-core requires >= 1.25)
      uses: actions/setup-go@v5
      with:
        go-version: '1.25.5'

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install NDK r27 (16KB Page Size Support)
      run: |
        sdkmanager --install "ndk;27.0.12077973" "platforms;android-35"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/27.0.12077973" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV

    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3

    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    - name: Initialize gomobile
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        gomobile init

    - name: Patch for 16KB Page Size
      run: |
        if [ -f "Makefile" ]; then
          sed -i 's/-androidapi [0-9]\+/-androidapi 35/g' Makefile
          sed -i 's/-androidapi=[0-9]\+/-androidapi=35/g' Makefile
        fi
        find . -name "build.gradle*" -type f -exec sed -i \
          -e 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' \
          -e 's/targetSdkVersion [0-9]\+/targetSdkVersion 35/g' \
          -e 's/compileSdk = [0-9]\+/compileSdk = 35/g' \
          -e 's/targetSdk = [0-9]\+/targetSdk = 35/g' {} \;

    - name: Clone go-tun2socks v1.16.7 locally and wire replace
      run: |
        git clone --depth 1 --branch v1.16.7 https://github.com/eycorsican/go-tun2socks.git ./third_party/go-tun2socks

        cat > go.mod <<'EOF'
        module github.com/2dust/AndroidLibXrayLite

        go 1.25

        require (
          github.com/eycorsican/go-tun2socks v1.16.7
        )

        replace github.com/eycorsican/go-tun2socks => ./third_party/go-tun2socks
        EOF

        go mod tidy
        go mod vendor

        # Assert local replace is in effect
        test -f third_party/go-tun2socks/core/tun.go || ls -R third_party/go-tun2socks | head

    - name: Add tun2socks exports (expects v1.16.7 API with NewTun2Socks)
      run: |
        mkdir -p libv2ray
        cat > libv2ray/tun.go <<'EOF'
        package libv2ray

        import (
            "time"

            "github.com/eycorsican/go-tun2socks/core"
            "github.com/eycorsican/go-tun2socks/proxy/socks"
        )

        var tunRunning bool
        var tun interface {
            Start()
            Stop()
        }

        // TunStart starts tun2socks with a given TUN file descriptor and SOCKS5 proxy address/port.
        func TunStart(fd int, socksAddr string, port uint16) bool {
            if tunRunning {
                return true
            }

            tcpHandler := socks.NewTCPHandler(socksAddr, port)
            udpHandler := socks.NewUDPHandler(socksAddr, port, 30*time.Second)

            t := core.NewTun2Socks(fd, tcpHandler, udpHandler)
            tun = t

            go t.Start()
            tunRunning = true
            return true
        }

        // TunStop stops the tun2socks loop.
        func TunStop() {
            if tunRunning && tun != nil {
                tun.Stop()
                tunRunning = false
            }
        }
        EOF

    - name: Build AAR
      run: |
        export PATH="$(go env GOPATH)/bin:$PATH"
        export ANDROID_NDK_HOME=$ANDROID_NDK_HOME
        export GO111MODULE=on
        export GOFLAGS="-mod=vendor"

        if [ -f "Makefile" ]; then
          make lib || make android || make
        elif [ -f "build.gradle" ] || [ -f "gradlew" ]; then
          chmod +x gradlew 2>/dev/null || true
          ./gradlew assembleRelease || gradle assembleRelease
        else
          # Use local replace + vendored deps to prevent drift
          gomobile bind -v \
            -target=android \
            -androidapi=35 \
            -ldflags="-s -w" \
            -o libxray.aar \
            -javapkg=io.github.androidlibxraylite \
            ./libv2ray
        fi

    - name: Find and verify AAR
      run: |
        echo "=== Searching for AAR files ==="
        find . -name "*.aar" -type f
        mkdir -p build/outputs
        find . -name "*.aar" -type f -exec cp {} build/outputs/ \;
        if ! ls build/outputs/*.aar 1> /dev/null 2>&1; then
          echo "❌ No AAR found!"
          exit 1
        fi
        echo "✅ AAR built successfully!"
        ls -lh build/outputs/

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: AndroidLibXrayLite-16kb-compatible
        path: build/outputs/*.aar
        retention-days: 90

    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: android15-v${{ github.run_number }}
        name: AndroidLibXrayLite (16KB Page Size + tun2socks exports)
        files: build/outputs/*.aar
        body: |
          ## AndroidLibXrayLite - Android 15+ Compatible (16KB Page Size)
          
          ✅ Xray Core + tun2socks
          ✅ TunStart/TunStop exported
          ✅ 16KB page size support
          ✅ Go 1.25.5 (required by xray-core), NDK r27, API 35
          
          **Usage with external XRayCore:**
          ```kotlin
          Libv2ray.TunStart(tunFd, "127.0.0.1", 10808)
          ...
          Libv2ray.TunStop()
          ```
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
