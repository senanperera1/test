name: Build SagerNet Tun2Socks AAR (Final)

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest

    steps:
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init

      - name: Install Android SDK + NDK
        run: |
          mkdir -p $HOME/android-sdk
          export ANDROID_HOME=$HOME/android-sdk
          curl -o ndk.zip https://dl.google.com/android/repository/android-ndk-r25c-linux.zip
          unzip -q ndk.zip -d $HOME/android-sdk/
          echo "ANDROID_NDK_HOME=$HOME/android-sdk/android-ndk-r25c" >> $GITHUB_ENV

      - name: Create Tun2Socks Wrapper
        run: |
          mkdir tun2socks
          cd tun2socks
          go mod init github.com/myuser/tun2socks
          
          # This 'replace' directive is the fix for the module path mismatch.
          go mod edit -replace=github.com/eycorsican/go-tun2socks=github.com/SagerNet/go-tun2socks@latest
          
          # Now, get the module using its *original* declared path and get the bind dependency.
          go get github.com/eycorsican/go-tun2socks
          go get golang.org/x/mobile/bind
          
          # Create the Go wrapper file with the blank bind import.
          cat <<'EOF' > tun2socks.go
          package tun2socks

          import (
              "os"
              "github.com/eycorsican/go-tun2socks/core"
              "github.com/eycorsican/go-tun2socks/proxy/socks"
              
              // This blank import forces Go to keep the 'bind' package.
              _ "golang.org/x/mobile/bind"
          )

          // Start the tun2socks core loop. This is a blocking call.
          func Start(fd int, proxyAddr string, proxyPort int) {
              f := os.NewFile(uintptr(fd), "tun")
              proxy := socks.NewSocks5Handler(proxyAddr, uint16(proxyPort))
              core.RegisterTCPConnHandler(proxy)
              core.RegisterUDPConnHandler(proxy)
              core.RegisterOutputFn(func(data []byte) (int, error) {
                  return f.Write(data)
              })
              core.Start()
          }

          // Stop the tun2socks core loop
          func Stop() {
              core.Stop()
          }
          EOF
          
          go mod tidy

      - name: Build Tun2Socks AAR
        working-directory: tun2socks
        run: |
          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../libtun2socks.aar .
          ls -lh ../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: "libtun2socks.aar"
