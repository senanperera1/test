name: Build Full tun2socks AAR

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v4

    - name: Install Go
      uses: actions/setup-go@v5
      with:
        go-version: "1.22.x"

    - name: Install Android NDK
      uses: nttld/setup-android-ndk@v1
      id: ndk
      with:
        ndk-version: r26d

    - name: Install gomobile + dependencies
      run: |
        sudo apt update
        sudo apt install -y unzip
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest

    - name: Prepare Project Structure (creates wrapper automatically)
      run: |
        mkdir -p tun2socks-wrapper
        cd tun2socks-wrapper

        # Clone real tun2socks core
        git clone https://github.com/eycorsican/go-tun2socks.git core

        # Init go module for wrapper
        cat << 'EOF' > go.mod
module tun2socks-wrapper
go 1.22
replace github.com/eycorsican/go-tun2socks => ./core
require github.com/eycorsican/go-tun2socks v0.0.0
EOF

        # Wrapper API for gomobile (FULL FUNCTIONALITY)
        cat << 'EOF' > wrapper.go
package tun2socks

import (
    "io"
    "log"
    "net"
    "os"

    core "github.com/eycorsican/go-tun2socks/core"
    "github.com/eycorsican/go-tun2socks/tun"
    "github.com/eycorsican/go-tun2socks/proxy/socks"
    "github.com/eycorsican/go-tun2socks/proxy/shadowsocks"
)

var tunIF io.ReadWriteCloser

// ===== API FOR ANDROID ======

func StartTun(fd int, mtu int, socks5Addr string, ssAddr string, ssKey string, ssCipher string) {
    var err error

    tunIF, err = tun.OpenTunDevice(fd, mtu)
    if err != nil {
        log.Fatalf("Failed to open tun device: %v", err)
    }

    if socks5Addr != "" {
        core.RegisterTCPConnHandler(socks.NewTCPHandler(socks5Addr))
        core.RegisterUDPConnHandler(socks.NewUDPHandler(socks5Addr))
    }

    if ssAddr != "" {
        core.RegisterTCPConnHandler(shadowsocks.NewTCPHandler(ssAddr, ssKey, ssCipher))
        core.RegisterUDPConnHandler(shadowsocks.NewUDPHandler(ssAddr, ssKey, ssCipher))
    }

    go core.Run(tunIF)
}

func StopTun() {
    if tunIF != nil {
        tunIF.Close()
    }
}

// Debug log
func SetLog(enabled bool) {
    if enabled {
        core.SetLogger(log.New(os.Stdout, "[tun2socks] ", log.LstdFlags))
    } else {
        core.SetLogger(log.New(io.Discard, "", 0))
    }
}
EOF

        go mod tidy

    - name: Initialize gomobile
      run: |
        export ANDROID_NDK_HOME=${{ steps.ndk.outputs.ndk-path }}
        gomobile init

    - name: Build AAR (real working tun2socks)
      run: |
        export ANDROID_NDK_HOME=${{ steps.ndk.outputs.ndk-path }}
        cd tun2socks-wrapper
        gomobile bind -v \
          -androidapi=21 \
          -o tun2socks-full.aar \
          .

    - name: Upload AAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-full-aar
        path: tun2socks-wrapper/tun2socks-full.aar
