name: Build tun2socks AAR

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build: 
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with: 
          go-version: '1.22'
          cache: true

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          ndk-version: '26. 1.10517047'
          cmake-version: '3.22.1'

      - name: Install GoMobile and dependencies
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          export PATH=$PATH:$(go env GOPATH)/bin
          gomobile init -v

      - name: Clone tun2socks repository
        run: |
          git clone https://github.com/xjasonlyu/tun2socks. git
          cd tun2socks
          git checkout main
          ls -la

      - name: Download Go dependencies
        run: |
          cd tun2socks
          go mod download
          go mod verify

      - name: Create wrapper for Android binding
        run: |
          cd tun2socks
          # Create a wrapper package with exported functions for Android
          cat > android_wrapper.go << 'EOF'
          package main

          import (
            "github.com/xjasonlyu/tun2socks/v2/engine"
          )

          var engineInstance *engine.Engine

          // Start initializes and starts the tun2socks engine
          func Start(device string, proxy string) error {
            opts := engine.Options{
              Device:  device,
              Proxy:  proxy,
            }
            var err error
            engineInstance, err = engine.New(opts)
            if err != nil {
              return err
            }
            return engineInstance.Start()
          }

          // Stop closes the tun2socks engine
          func Stop() error {
            if engineInstance != nil {
              return engineInstance.Close()
            }
            return nil
          }

          // IsRunning checks if engine is running
          func IsRunning() bool {
            if engineInstance != nil {
              return engineInstance.Running()
            }
            return false
          }
          EOF
          cat android_wrapper.go

      - name: Build tun2socks AAR
        run: |
          cd tun2socks
          export PATH=$PATH:$(go env GOPATH)/bin
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_NDK=$ANDROID_NDK_ROOT
          
          # Build AAR with gomobile bind
          gomobile bind -o tun2socks.aar \
            -target=android \
            -androidapi=21 \
            -v \
            ./

      - name:  Verify AAR artifact
        run: |
          cd tun2socks
          if [ !  -f "tun2socks.aar" ]; then
            echo "ERROR: tun2socks. aar was not created!"
            exit 1
          fi
          echo "âœ“ AAR file created successfully"
          echo "File size: $(du -h tun2socks.aar | cut -f1)"
          echo ""
          echo "AAR contents:"
          unzip -l tun2socks. aar | head -30

      - name: Create output directory
        run: |
          mkdir -p build-output
          cp tun2socks/tun2socks.aar build-output/
          cp tun2socks/android_wrapper.go build-output/

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name:  tun2socks-aar
          path: build-output/tun2socks.aar
          retention-days: 30

      - name: Upload wrapper reference
        uses: actions/upload-artifact@v4
        with: 
          name: android-wrapper
          path: build-output/android_wrapper.go
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: build-output/tun2socks.aar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo "=== Build Complete ==="
          echo "Repository: xjasonlyu/tun2socks"
          echo "AAR Location: build-output/tun2socks.aar"
          echo "Android API Level: 21+"
          echo "NDK Version: 26.1.10517047"
          echo ""
          echo "Integration Instructions:"
          echo "1. Download tun2socks.aar from artifacts"
          echo "2. Place in your Android project:  app/libs/tun2socks. aar"
          echo "3. Add to build.gradle:"
          echo "   implementation files('libs/tun2socks.aar')"
          echo "4. Call from your VPNService:"
          echo "   Main. Start(\"fd://\" + tunFd, \"socks5://127.0.0.1:10808\")"
          echo "   Main.Stop()"