name: Build tun2socks AAR (Strip V2Ray/XRay)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout xxf098/go-tun2socks-build
      uses: actions/checkout@v4
      with:
        repository: 'xxf098/go-tun2socks-build'
        ref: 'master'
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
    
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: Install NDK
      run: |
        sdkmanager --install "ndk;23.1.7779620" "platforms;android-33"
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/23.1.7779620" >> $GITHUB_ENV
    
    - name: Install gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        go install golang.org/x/mobile/cmd/gobind@latest
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH
    
    - name: Initialize gomobile
      run: |
        gomobile init
    
    - name: Remove V2Ray and XRay cores
      run: |
        echo "Removing V2Ray/XRay dependencies from go.mod..."
        
        # Remove v2ray and xray imports from go.mod
        sed -i '/v2ray/d' go.mod
        sed -i '/xray/d' go.mod
        sed -i '/v2fly/d' go.mod
        sed -i '/xtls/d' go.mod
        sed -i '/quic-go/d' go.mod
        
        # Comment out or remove V2Ray/XRay related code
        echo "Patching tun2socks.go to remove V2Ray/XRay functions..."
        
        # Create a backup
        cp tun2socks.go tun2socks.go.backup
        
        # Remove V2Ray and XRay start functions, keep only basic functionality
        cat > patch_remove_cores.sh << 'PATCHEOF'
        #!/bin/bash
        
        # Remove startV2Ray and startXRay function implementations
        perl -i -p0e 's/func startV2Ray\(.*?\n\}//gs' tun2socks.go
        perl -i -p0e 's/func startXRay\(.*?\n\}//gs' tun2socks.go
        perl -i -p0e 's/func StartV2Ray.*?\n\}//gs' tun2socks.go
        perl -i -p0e 's/func StartXRay.*?\n\}//gs' tun2socks.go
        perl -i -p0e 's/func StopV2Ray.*?\n\}//gs' tun2socks.go
        perl -i -p0e 's/func StopXRay.*?\n\}//gs' tun2socks.go
        
        # Remove V2Ray/XRay imports
        sed -i '/v2ray/d' tun2socks.go
        sed -i '/xray/d' tun2socks.go
        sed -i '/v2fly/d' tun2socks.go
        sed -i '/xtls/d' tun2socks.go
        
        echo "Patching complete"
        PATCHEOF
        
        chmod +x patch_remove_cores.sh
        ./patch_remove_cores.sh || true
        
        echo "Cleaning up go.mod..."
        go mod tidy || true
    
    - name: Create minimal build script
      run: |
        cat > build_minimal.sh << 'BUILDEOF'
        #!/bin/bash
        set -e
        
        echo "Building minimal tun2socks (SOCKS5 only)..."
        
        # Build with socks tag only, exclude v2ray/xray
        gomobile bind -v \
          -target=android \
          -androidapi=21 \
          -ldflags="-s -w" \
          -o tun2socks.aar \
          ./
        
        echo "Build complete!"
        ls -lh tun2socks.aar
        BUILDEOF
        
        chmod +x build_minimal.sh
    
    - name: Download dependencies
      run: |
        go mod download || true
        go get -d ./... || true
    
    - name: Build AAR (Minimal)
      run: |
        # Try custom build script first
        ./build_minimal.sh || {
          echo "Custom build failed, trying Makefile..."
          make android || make lib
        }
    
    - name: List build outputs
      run: |
        echo "=== Build directory contents ==="
        find . -name "*.aar" -o -name "*.jar" | head -20
        ls -lah *.aar 2>/dev/null || echo "No AAR in root"
        ls -lah build/ 2>/dev/null || echo "No build directory"
    
    - name: Create usage documentation
      run: |
        cat > USAGE.md << 'EOF'
        # tun2socks AAR (Minimal - No V2Ray/XRay Cores)

        Built from xxf098/go-tun2socks-build with V2Ray/XRay cores removed.

        ## Integration

        1. Add to your Android project:
           ```gradle
           dependencies {
               implementation files('libs/tun2socks.aar')
           }
           ```

        ## Usage (Kotlin) - SOCKS5 Only

        ```kotlin
        import tun2socks.Tun2socks

        class MyVpnService : VpnService() {
            
            private val vpnService = object : tun2socks.VpnService {
                override fun protect(fd: Long): Boolean {
                    return this@MyVpnService.protect(fd.toInt())
                }
            }
            
            private val logService = object : tun2socks.LogService {
                override fun writeLog(log: String?) {
                    Log.d("Tun2socks", log ?: "")
                }
            }
            
            private val querySpeed = object : tun2socks.QuerySpeed {
                override fun updateTraffic(up: Long, down: Long) {
                    // Update your UI with traffic stats
                }
            }
            
            override fun onStartCommand(intent: Intent?, flags: Int, startId: Int): Int {
                val builder = Builder()
                    .setMtu(1500)
                    .addAddress("10.0.0.2", 24)
                    .addRoute("0.0.0.0", 0)
                    .addDnsServer("8.8.8.8")
                    .setSession("Tun2socks VPN")
                
                val vpnInterface = builder.establish() ?: return START_NOT_STICKY
                val tunFd = vpnInterface.detachFd()
                
                try {
                    // Simple SOCKS5 configuration
                    val config = tun2socks.Vmess().apply {
                        add = "127.0.0.1"  // Your SOCKS5 server
                        port = 10808        // Your SOCKS5 port
                        net = "socks"       // Use SOCKS5
                    }
                    
                    // Start with basic function (V2Ray/XRay functions removed)
                    Tun2socks.startWithTunFd(
                        tunFd.toLong(),
                        vpnService,
                        logService,
                        querySpeed,
                        config,
                        filesDir.absolutePath
                    )
                    
                    Log.i("VPN", "tun2socks started successfully")
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to start", e)
                }
                
                return START_STICKY
            }
            
            override fun onDestroy() {
                try {
                    Tun2socks.stop()
                } catch (e: Exception) {
                    Log.e("VPN", "Failed to stop", e)
                }
                super.onDestroy()
            }
        }
        ```

        ## Features

        - âœ… Basic tun2socks functionality
        - âœ… SOCKS5 proxy support
        - âœ… No V2Ray/XRay cores (no qtls errors!)
        - âœ… Traffic statistics
        - âœ… Lightweight build

        ## Use with External XRayCore

        1. Run XRayCore separately with SOCKS5 inbound on `127.0.0.1:10808`
        2. Configure tun2socks to use SOCKS5 as shown above
        3. All TUN traffic forwarded to your XRayCore

        ## Notes

        - V2Ray and XRay functions have been removed
        - Use basic `startWithTunFd` or SOCKS5 configuration
        - Much smaller and more stable
        - No runtime qtls conflicts
        EOF
    
    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-aar-minimal
        path: |
          **/*.aar
          **/*-sources.jar
          USAGE.md
        retention-days: 30
    
    - name: Create Release
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      continue-on-error: true
      with:
        tag_name: minimal-${{ github.run_number }}
        files: |
          **/*.aar
          USAGE.md
        body: |
          ## tun2socks AAR (Minimal - No V2Ray/XRay)
          
          Built from xxf098/go-tun2socks-build with cores stripped.
          
          ### Changes:
          - âŒ V2Ray core removed
          - âŒ XRay core removed
          - âœ… SOCKS5 support retained
          - âœ… No qtls errors
          - âœ… Smaller APK size
          
          ### Quick Start:
          See USAGE.md for integration guide.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Show success message
      run: |
        echo "âœ… BUILD SUCCESSFUL!"
        echo ""
        echo "tun2socks.aar built WITHOUT V2Ray/XRay cores!"
        echo ""
        echo "ðŸ“¦ Download from 'Artifacts' section"
        echo ""
        find . -name "*.aar" -exec ls -lh {} \;
