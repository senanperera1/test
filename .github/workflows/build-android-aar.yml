name: Build Tun2Socks AAR

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"

      - name: Install NDK
        uses: nttld/setup-android-ndk@v1
        id: ndk
        with:
          ndk-version: r26d

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest

      - name: Clone working tun2socks
        run: |
          git clone https://github.com/xjasonlyu/tun2socks.git
          cd tun2socks
          git checkout v2
          go mod tidy

      - name: Add gomobile wrapper
        run: |
          cd tun2socks
          mkdir -p mobile
          cat > mobile/mobile.go << 'EOF'
package mobile

import (
    "github.com/xjasonlyu/tun2socks/v2/core"
    "github.com/xjasonlyu/tun2socks/v2/core/option"
    "github.com/xjasonlyu/tun2socks/v2/tun"
    "github.com/xjasonlyu/tun2socks/v2/proxy/socks"
    "github.com/xjasonlyu/tun2socks/v2/proxy/shadowsocks"
)

var engine core.Core

func StartTun(fd int, mtu int, server string) error {
    var err error
    engine, err = tun.Start(fd, &option.Options{MTU: mtu, Server: server})
    return err
}

func StartSocks(addr string) error {
    return socks.Start(addr, nil)
}

func StartSS(addr, method, password string) error {
    return shadowsocks.Start(addr, method, password)
}

func Stop() {
    if engine != nil {
        engine.Close()
    }
}
EOF

      - name: gomobile init
        run: |
          export ANDROID_NDK_HOME="${{ steps.ndk.outputs.ndk-path }}"
          gomobile init

      - name: Build AAR
        run: |
          cd tun2socks
          export ANDROID_NDK_HOME="${{ steps.ndk.outputs.ndk-path }}"
          gomobile bind -androidapi=21 -o tun2socks.aar ./mobile

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: tun2socks-aar
          path: tun2socks/tun2socks.aar
