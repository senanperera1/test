name: Build tun2socks AAR

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  build:  
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Go
        uses: actions/setup-go@v4
        with:  
          go-version: '1.22'
          cache: true

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: '9.0'
          accept-android-sdk-licenses: true
          packages: 'platforms;android-33 ndk;26. 1.10517047'

      - name: Install GoMobile and dependencies
        run: |
          export PATH=$PATH:$(go env GOPATH)/bin
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          gomobile init -v

      - name: Clone tun2socks repository
        run: |
          git clone https://github.com/xjasonlyu/tun2socks.git
          cd tun2socks
          git checkout main
          ls -la

      - name: Download Go dependencies
        run: |
          cd tun2socks
          go mod download
          go mod verify

      - name: Create wrapper for Android binding
        run: |
          cd tun2socks
          # Create a wrapper package with exported functions for Android
          cat > android_wrapper.go << 'EOF'
          package main

          import (
            "github.com/xjasonlyu/tun2socks/v2/engine"
          )

          var engineInstance *engine.Engine

          // Start initializes and starts the tun2socks engine
          func Start(device string, proxy string) error {
            opts := engine.Options{
              Device:  device,
              Proxy:  proxy,
            }
            var err error
            engineInstance, err = engine.New(opts)
            if err != nil {
              return err
            }
            return engineInstance.Start()
          }

          // Stop closes the tun2socks engine
          func Stop() error {
            if engineInstance != nil {
              return engineInstance.Close()
            }
            return nil
          }

          // IsRunning checks if engine is running
          func IsRunning() bool {
            if engineInstance != nil {
              return engineInstance.Running()
            }
            return false
          }
          EOF
          cat android_wrapper.go

      - name: Build tun2socks AAR
        run: |
          cd tun2socks
          export PATH=$PATH:$(go env GOPATH)/bin
          export ANDROID_HOME=$ANDROID_SDK_ROOT
          export ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10517047
          
          # Verify NDK exists
          if [ ! -d "$ANDROID_NDK_ROOT" ]; then
            echo "NDK not found at $ANDROID_NDK_ROOT"
            ls -la $ANDROID_SDK_ROOT/ndk/ || echo "No ndk directory"
            exit 1
          fi
          
          echo "ANDROID_HOME:  $ANDROID_HOME"
          echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          echo "Go path: $(which go)"
          echo "GoMobile path: $(which gomobile)"
          
          # Build AAR with gomobile bind
          gomobile bind -o tun2socks.aar \
            -target=android \
            -androidapi=21 \
            -v \
            ./

      - name:  Verify AAR artifact
        run: |
          cd tun2socks
          if [ !  -f "tun2socks.aar" ]; then
            echo "ERROR: tun2socks. aar was not created!"
            exit 1
          fi
          echo "✓ AAR file created successfully"
          echo "File size: $(du -h tun2socks.aar | cut -f1)"
          echo ""
          echo "AAR contents:"
          unzip -l tun2socks.aar | head -40

      - name: Create output directory
        run: |
          mkdir -p build-output
          cp tun2socks/tun2socks.aar build-output/
          cp tun2socks/android_wrapper.go build-output/
          
          # Create integration guide
          cat > build-output/INTEGRATION_GUIDE.md << 'EOF'
          # tun2socks AAR Integration Guide

          ## Installation

          1. **Download the AAR artifact** from the GitHub Actions build

          2. **Add to your Android project:**
             ```
             app/libs/tun2socks. aar
             ```

          3. **Update build. gradle:**
             ```gradle
             dependencies {
                 implementation files('libs/tun2socks.aar')
                 // Your existing Xray-core AAR
                 implementation files('libs/xray-core. aar')
             }
             ```

          ## Usage

          ### Basic VPNService Integration

          ```kotlin
          import main.Main

          class MyVPNService : VpnService() {
              override fun onCreate() {
                  super.onCreate()
                  val tunFd = establish()  // Get TUN interface FD
                  
                  // Feed packets into Xray SOCKS proxy
                  Main.start("fd://$tunFd", "socks5://127.0.0.1:10808")
              }

              override fun onDestroy() {
                  Main.stop()
                  super.onDestroy()
              }
          }
          ```

          ### Check Engine Status

          ```kotlin
          if (Main.isRunning()) {
              Log.d("tun2socks", "Engine is running")
          }
          ```

          ## Features

          - Pure tun2socks (no bundled Xray-core)
          - SOCKS5 proxy support
          - gVisor-based TCP/IP stack
          - Works seamlessly with your existing Xray-core AAR
          - Handles system-wide packet routing to proxy

          ## Troubleshooting

          - **Crash on Start:** Ensure TUN interface is properly established before calling `Main.start()`
          - **Packets not routing:** Verify Xray-core is listening on specified SOCKS port
          - **JNI errors:** Check that build.gradle includes the tun2socks. aar in libs folder
          EOF
          cat build-output/INTEGRATION_GUIDE. md

      - name: Upload AAR artifact
        uses: actions/upload-artifact@v4
        with:
          name:  tun2socks-aar
          path: build-output/tun2socks.aar
          retention-days: 30

      - name: Upload wrapper and guide
        uses: actions/upload-artifact@v4
        with:  
          name: integration-files
          path: build-output/
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with: 
          files: build-output/tun2socks.aar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          echo ""
          echo "╔════════════════════════════════════════════════╗"
          echo "║         tun2socks AAR Build Complete           ║"
          echo "╚════════════════════════════════════════════════╝"
          echo ""
          echo "Repository: xjasonlyu/tun2socks (Pure tun2socks, no Xray-core)"
          echo "Build Date: $(date)"
          echo "Go Version: $(go version)"
          echo ""
          echo "Output Files:"
          echo "  • tun2socks.aar - Android Library Archive"
          echo "  • android_wrapper.go - Reference wrapper code"
          echo "  • INTEGRATION_GUIDE.md - Integration instructions"
          echo ""
          echo "Android Configuration:"
          echo "  API Level: 21+"
          echo "  NDK Version: 26.1.10517047"
          echo "  JDK Version: 17+"
          echo ""
          echo "Quick Integration:"
          echo "  1. Copy tun2socks.aar to app/libs/"
          echo "  2. Add to build.gradle: implementation files('libs/tun2socks.aar')"
          echo "  3. Call Main.start(device, proxy) from VPNService"
          echo "  4. Feed packets from TUN into Xray-core SOCKS proxy"
          echo ""