name: Build Final tun2socks AAR

on:
  workflow_dispatch:

jobs:
  build-aar:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Android SDK + NDK
        run: |
          yes | sdkmanager --licenses
          sdkmanager "platforms;android-34" "build-tools;34.0.0" "ndk;26.1.10909125"
          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Install gomobile
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          go install golang.org/x/mobile/cmd/gobind@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          gomobile init

      - name: Create Wrapper and Build AAR
        run: |
          mkdir -p workspace/wrapper
          cd workspace
          git clone https://github.com/xjasonlyu/tun2socks.git library_src
          cd wrapper
          go mod init github.com/myuser/tun2socks
          go mod edit -replace=github.com/xjasonlyu/tun2socks/v2=../library_src

          cat <<'EOF' > tun2socks.go
          package tun2socks
          import (
              "context"
              "fmt"
              "log"
              "github.com/xjasonlyu/tun2socks/v2/core"
              "github.com/xjasonlyu/tun2socks/v2/proxy"
              "github.com/xjasonlyu/tun2socks/v2/tun"
              _ "golang.org/x/mobile/bind"
          )
          var (
              ctx    context.Context
              cancel context.CancelFunc
          )
          func Start(fd int, proxyURL string) error {
              ctx, cancel = context.WithCancel(context.Background())
              mtu := 1500
              tunDev, err := tun.Open(fmt.Sprintf("fd://%d", fd), mtu)
              if err != nil { return fmt.Errorf("failed to open tun device: %w", err) }
              proxyHandler, err := proxy.New(proxyURL)
              if err != nil { return fmt.Errorf("failed to create proxy handler: %w", err) }
              lwipStack := core.NewLWIPStack()
              core.RegisterTCPConnHandler(proxyHandler)
              core.RegisterUDPConnHandler(proxyHandler)
              core.RegisterOutputFn(func(data []byte, writeCount int) { tunDev.Write(data[:writeCount]) })
              log.Println("tun2socks running")
              go lwipStack.Start()
              packet := make([]byte, mtu)
              for {
                  select {
                  case <-ctx.Done():
                      return nil
                  default:
                      n, err := tunDev.Read(packet)
                      if err != nil { return err }
                      lwipStack.Write(packet[:n])
                  }
              }
          }
          func Stop() {
              if cancel != nil { cancel() }
              log.Println("tun2socks stopping")
          }
EOF

          go get golang.org/x/mobile/bind
          go get github.com/xjasonlyu/tun2socks/v2
          go mod tidy

          gomobile bind -v -target=android/arm64 -androidapi=21 -o ../libtun2socks.aar .
          ls -lh ../libtun2socks.aar

      - name: Upload AAR
        uses: actions/upload-artifact@v4
        with:
          name: libtun2socks-aar
          path: workspace/libtun2socks.aar
