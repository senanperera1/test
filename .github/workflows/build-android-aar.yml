name: Build tun2socks-android AAR

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      ANDROID_API_LEVEL: 35
      ANDROID_NDK_VERSION: 27.0.12077973

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # If building upstream repo, set repository: 'LondonX/tun2socks-android'
        # If building your fork, omit repository or set to your fork.
        fetch-depth: 0
        submodules: recursive

    - name: Set up Java (JDK 17)
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'

    - name: Setup Android SDK and NDK
      uses: android-actions/setup-android@v3
      with:
        api-level: ${{ env.ANDROID_API_LEVEL }}
        ndk: ${{ env.ANDROID_NDK_VERSION }}

    - name: Accept Android SDK licenses
      run: |
        yes | sdkmanager --licenses || true

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-cache-${{ runner.os }}-${{ hashFiles('**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-cache-${{ runner.os }}-

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Optional: apply small patches (uncomment if needed)
      if: false
      run: |
        # Example: patch build.gradle or AndroidManifest if you need to change compileSdk/targetSdk
        # sed -i 's/compileSdkVersion [0-9]\+/compileSdkVersion 35/g' tun2socks/build.gradle || true
        echo "No patches applied"

    - name: Clean build directory
      run: ./gradlew clean --no-daemon

    - name: Build AAR (assembleRelease)
      run: |
        # If the project is a library module named 'tun2socks' adjust the task:
        # ./gradlew :tun2socks:assembleRelease
        # Otherwise run top-level assembleRelease to build all modules
        ./gradlew assembleRelease --no-daemon --stacktrace

    - name: Collect AAR artifacts
      run: |
        mkdir -p build/outputs
        # Find AARs produced by the build and copy them to build/outputs
        find . -type f -name "*.aar" -exec cp {} build/outputs/ \; || true
        echo "AARs copied to build/outputs:"
        ls -la build/outputs || true

    - name: Upload AAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: tun2socks-android-aar
        path: build/outputs/*.aar
        retention-days: 90

    - name: Debug info on failure
      if: failure()
      run: |
        echo "=== Gradle build logs (last 200 lines) ==="
        tail -n 200 ~/.gradle/daemon/*/daemon-*.log || true
        echo "=== Project tree ==="
        find . -maxdepth 3 -type f -name 'build.gradle*' -print
        echo "=== Show gradle tasks ==="
        ./gradlew tasks --all --no-daemon || true
